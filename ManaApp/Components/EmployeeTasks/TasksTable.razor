@using ManaApp.Models

@if (!Tasks.Any())
{
    <p>Nav nākamo uzdevumu.</p>
}
else
{
    var orderedTasks = Tasks
        .OrderBy(t => t.BatchCode)
        .ThenBy(t => t.PartName)
        .ThenBy(t => t.StepOrder)
        .ThenBy(t => t.Status)
        .ThenByDescending(t => t.Priority);

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Batch</th>
                <th>Nosaukums</th>
                <th>Detaļa</th>
                <th>Solis</th>
                <th>Prioritāte</th>
                <th>Statuss</th>
                <th>Planned</th>
                <th>Finishing qty</th>
                <th>Procesā</th>
                <th>Komentārs</th>
                <th>Izvēlēties</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var t in orderedTasks)
            {
                <tr class="@(t.Status == 2 ? "table-warning" : (t.Status == 3 ? "table-success" : ""))">
                    <td>@t.BatchCode</td>
                    <td>@t.ProductName</td>
                    <td>@t.PartName</td>
                    <td>@t.StepName</td>
                    <td>@t.Priority</td>
                    <td>@StatusText(t.Status)</td>

                    <td>
                        @if (t.StepType != 3)
                        {
                            @t.Planned
                        }
                    </td>

                    <td>
                        @if (t.StepType == 3)
                        {
                            @t.Done
                        }
                    </td>

                    <td>
                        @if (t.Status == 2)
                        {
                            @t.Planned
                        }
                    </td>

                    <td>
                        @if (t.IsCommentForEmployee && !string.IsNullOrWhiteSpace(t.Comment))
                        {
                            @t.Comment
                        }
                    </td>

                    <td>
                        <button class="btn btn-primary"
                                disabled="@(t.Status == 1 && !CanStart(t))"
                                @onclick="() => OnOpen.InvokeAsync(t)">
                            Atvērt
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    [Parameter] public IEnumerable<TaskRow> Tasks { get; set; } = Enumerable.Empty<TaskRow>();
    [Parameter] public Func<int, string> StatusText { get; set; } = default!;
    [Parameter] public Func<TaskRow, bool> CanStart { get; set; } = default!;
    [Parameter] public EventCallback<TaskRow> OnOpen { get; set; }
}

