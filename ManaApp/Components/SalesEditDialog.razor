<div class="modal">
    <div class="modal-window">

        <div class="modal-header">
            <h3>Labot pārdošanai pievienotās preces</h3>
        </div>

        <div class="modal-body">

            @foreach (var group in Items.GroupBy(i => i.VersionId))
            {
                var first = group.First();

                <div class="product-block">

                    <!-- HEADER + SUMMARY IN ONE ROW -->
                    <div class="product-header-row">
                        <h4>
                            @first.ProductName
                            @if (!string.IsNullOrWhiteSpace(first.VersionName))
                            {
                                <span> (@first.VersionName)</span>
                            }
                        </h4>

                        <div class="summary-inline">
                                <span>
                                    Kopā (STOCK):
                                    @(
                                        group
                                            .Where(i => !i.IsAssembly)
                                            .SelectMany(i => i.Batches)
                                            .Sum(b => b.Qty)
                                    )
                                </span>

                                <span>
                                    Kopā (ASSEMBLY):
                                    @(
                                        group
                                            .Where(i => i.IsAssembly)
                                            .SelectMany(i => i.Batches)
                                            .Sum(b => b.Qty)
                                    )
                                </span>
                        </div>
                    </div>

                    <!-- BATCH TABLE -->
                    <table class="sales-edit-table">
                                <thead>
                                    <tr>
                                        <th>Batch</th>
                                        <th>Pieejams (STOCK)</th>
                                        <th>Pārdot (STOCK)</th>
                                        <th>Pieejams (ASSEMBLY)</th>
                                        <th>Pārdot (ASSEMBLY)</th>
                                        <th></th> <!-- delete column -->
                                    </tr>
                                </thead>


                        <tbody>
                            @foreach (var item in group)
                            {
@for (int batchIndex = 0; batchIndex < item.Batches.Count; batchIndex++)
{
    var batch = item.Batches[batchIndex];

   <tr @key="@($"{item.VersionId}-{item.IsAssembly}-{batch.BatchCode}")">


        <td>@batch.BatchCode</td>

        <td>@(item.IsAssembly ? "-" : item.InStock.ToString())</td>

        <td>
            <input type="number"
                   value="@batch.Qty"
                   disabled="@item.IsAssembly"
                   @oninput="e => batch.Qty = int.TryParse(e.Value?.ToString(), out var v) ? v : 0" />
        </td>

        <td>@(item.IsAssembly ? item.InStock.ToString() : "-")</td>

        <td>
            <input type="number"
                   value="@batch.Qty"
                   disabled="@(!item.IsAssembly)"
                   @oninput="e => batch.Qty = int.TryParse(e.Value?.ToString(), out var v) ? v : 0" />
        </td>
        <td>
            <button type="button"
        @onclick="() => RemoveBatch(item, batch.BatchCode)">
    ✖
</button>
        
        </td>
    </tr>
}

                            }
                            </tbody>

                    </table>

                </div>
            }

        </div>

        <!-- FOOTER BUTTONS (RESTORED) -->
        <div class="modal-footer">
            <button @onclick="OnSave">ATJAUNOT</button>
            <button @onclick="OnCancel">ATCELT</button>
        </div>

    </div>
</div>

@code {
    [Parameter] public IReadOnlyList<SalesCartItem> Items { get; set; }
        = Array.Empty<SalesCartItem>();

    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }


void RemoveBatch(SalesCartItem item, string batchCode)
{
    var batch = item.Batches.FirstOrDefault(b => b.BatchCode == batchCode);
    if (batch != null)
    {
        item.Batches.Remove(batch);
        StateHasChanged();
    }
}


}
