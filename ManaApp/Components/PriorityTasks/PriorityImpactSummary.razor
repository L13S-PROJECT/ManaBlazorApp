@using System.Linq
@using System.Text.Json.Serialization
@inject HttpClient Http
@namespace ManaApp.Components.PriorityTasks


@if (rows == null)
{
    <div>Ielādē...</div>
}
else
{
    
        var employees = rows
            .Select(r => r.EmployeeName)
            .Distinct()
            .OrderBy(e => e)
            .ToList();

        var workCenters = rows
            .Select(r => r.WorkCenter)
            .Distinct()
            .OrderBy(w => w)
            .ToList();
    

    <h5>Prioritārie darbi</h5>

    <table class="table table-sm">
        <thead>
            <tr>
                <th>Workcentrs</th>
                @foreach (var emp in employees)
                {
                    <th>
                        <span style="cursor:pointer"
                            @onclick="() => OpenPopup(emp)">
                            @emp
                        </span>
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var wc in workCenters)
            {
                <tr>
                    <td><strong>@wc</strong></td>

                    @foreach (var emp in employees)
                    {
                        var match = rows.FirstOrDefault(r =>
                            r.WorkCenter == wc &&
                            r.EmployeeName == emp);

                        <td>@(match?.PriorityCount ?? 0)</td>
                    }
                </tr>
            }
        </tbody>
    </table>

    <h5>Parastie darbi</h5>

    <table class="table table-sm">
        <thead>
            <tr>
                <th>Workcentrs</th>
                @foreach (var emp in employees)
                {
                    <th>@emp</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var wc in workCenters)
            {
                <tr>
                    <td><strong>@wc</strong></td>

                    @foreach (var emp in employees)
                    {
                        var match = rows.FirstOrDefault(r =>
                            r.WorkCenter == wc &&
                            r.EmployeeName == emp);

                        <td>@(match?.NormalCount ?? 0)</td>
                    }
                </tr>
            }
        </tbody>
    </table>
}

@if (selectedEmployeeId != null)
{
    <EmployeeLoadPopup EmployeeId="selectedEmployeeId.Value"
                       OnClose="ClosePopup" />
}

@code {

    private List<PriorityImpactRow>? rows;

    private class PriorityImpactRow
    {
        public string WorkCenter { get; set; } = "";
        public string EmployeeName { get; set; } = "";
        public int PriorityCount { get; set; }
        public int NormalCount { get; set; }
        public int EmployeeId { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        rows = await Http.GetFromJsonAsync<List<PriorityImpactRow>>(
            "http://localhost:5270/api/production-priorities/impact");
    }

    public async Task Reload()
    {
        rows = await Http.GetFromJsonAsync<List<PriorityImpactRow>>(
            "http://localhost:5270/api/production-priorities/impact");

        StateHasChanged();
    }

    private int? selectedEmployeeId;

private void OpenPopup(string employeeName)
{
    var match = rows?.FirstOrDefault(r => r.EmployeeName == employeeName);
    if (match != null)
        selectedEmployeeId = match.EmployeeId;
}

private void ClosePopup()
{
    selectedEmployeeId = null;
}
}
