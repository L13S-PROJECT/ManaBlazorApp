@using ManaApp.Models
@using ManaApp.Components


<div class="ptv2-box ptv2-box-detail ptv2-box-batches">

        <div class="ptv2-box-header">
            <h3>
                @(SelectedProduct == null
                    ? "Izvēlies preci"
                    : SelectedProduct.productName)
            </h3>

            <label class="ptv2-archive-toggle">
                <input type="checkbox"
                    class="ptv2-toggle"
                    @bind="ShowArchived" />
                <span>Rādīt arhīvu</span>
            </label>

        </div>

   
    @if (SelectedProduct == null)
    {
        <div class="ptv2-detail-placeholder">
            Izvēlies preci, lai atvērtu ražošanas sarakstu(-s)
        </div>
    }
    else if (ProductBatches.Count == 0)
    {
        <div class="ptv2-detail-placeholder">
            Nav ražošanas saraksts
        </div>
    }
    else
    {
        <div class="ptv2-batches">


           <!-- HEADER -->
            <div class="ptv2-batches-header">
                <div>Raž.kods</div>
                <div>Versija</div>
                <div class="num">Apjoms</div>
                <div class="num">SOLD</div> 
                <div class="num">Done</div>
                <div>Datums</div>
                <div>Komentārs</div>
                <div></div>
            </div>

            <!-- ROWS -->
                @foreach (var b in ProductBatches
                    .Where(b => ShowArchived || !IsArchived(b)))
                {

                <div class="ptv2-batch-row
                    @(IsArchived(b) ? "archived" : "")
                    @(SelectedBatch?.BatchProductId == b.BatchProductId ? "active" : "")"
                    @onclick="() => SelectBatch(b)">


                    <div>
                        @b.BatchCode
                        @if (LatestVersionByProductCode.TryGetValue(
                            SelectedProduct!.productCode, out var latest)
                            && b.VersionId == latest)
                        {
                            <span class="ptv2-star">★</span>
                        }
                    </div>

                    <div>@b.VersionName</div>
                    <div class="num">@b.Planned</div>
                    <div class="num">@b.Sold</div>
                    <div class="num">@b.Done</div>
                    <div>
                        @(b.StartedAt?.ToString("dd.MM.yyyy") ?? "")
                    </div>

                    <div class="ptv2-comment" title="@b.Comment">
                        @b.Comment
                    </div>
<button type="button"
        class="ptv2-edit"
        @onclick="() => OpenCommentDialog(b)"
        @onclick:stopPropagation="true">
    ✎
</button>

                </div>
            }
        </div>
    }
</div>

@if (IsCommentDialogOpen)
{
<BatchCommentDialog
    Comment="@DialogComment"
    OnSave="OnCommentSaved"
    OnClose="CloseCommentDialog" />

}

@code {

string? BatchComment =>
    ProductBatches.FirstOrDefault()?.Comment;

    [Parameter] public ProductRow? SelectedProduct { get; set; }
    [Parameter] public List<ProductBatchRow> ProductBatches { get; set; } = new();
    [Parameter] public Dictionary<string, int> LatestVersionByProductCode { get; set; } = new();
    [Parameter] public ProductBatchRow? SelectedBatch { get; set; }
    
    async Task SelectBatch(ProductBatchRow batch)
{
    if (OnBatchSelected.HasDelegate)
        await OnBatchSelected.InvokeAsync(batch);
}

bool IsCommentDialogOpen = false;
string? DialogComment;
int? EditingBatchId;

void OpenCommentDialog(ProductBatchRow row)
{
    EditingBatchId = row.BatchId;
    DialogComment = row.Comment;   // <-- esošais DB komentārs šim batcham
    IsCommentDialogOpen = true;
}

void CloseCommentDialog()
{
    IsCommentDialogOpen = false;
    EditingBatchId = null;
}

async Task OnCommentSaved(string? newComment)
{
    if (EditingBatchId is null)
        return;

    await Http.PostAsJsonAsync(
        "http://localhost:5270/api/batches/update-comment",
        new
        {
            BatchId = EditingBatchId.Value,
            Comment = newComment
        });

    // atjaunojam TIKAI šo batch rindu(s)
    foreach (var r in ProductBatches.Where(x => x.BatchId == EditingBatchId.Value))
        r.Comment = newComment;

    IsCommentDialogOpen = false;
    EditingBatchId = null;
    StateHasChanged();
}

[Inject] HttpClient Http { get; set; } = default!;

[Parameter] public EventCallback<ProductBatchRow> OnBatchSelected { get; set; }

private bool ShowArchived = false;

bool IsArchived(ProductBatchRow b)
    => b.Planned > 0 && (b.Done + b.Sold) >= b.Planned;

}
