@using ManaApp.Models
@using ManaApp.Components
@inject HttpClient Http
@inject IJSRuntime JS


@if (SelectedBatch is null)
{
    <div class="ptv2-detail-placeholder">
        Izvƒìlies Ra≈æo≈°anas partiju, lai redzƒìtu detaƒºas
    </div>
    return;
}


@foreach (var p in Parts)
{
<div class="ptv2-tasks-row">
    <!-- 1. Nosaukums -->
            <div class="ptv2-part-name" title="@p.TopPartName">
                <span class="ptv2-part-indicator
                    @(DetailedIndicators.TryGetValue(p.ProductToPartId, out var st)
                        ? $"state-{st}"
                        : "state-gray")">
                </span>

                @p.TopPartName
            </div>
    <!-- 2. Gatavs -->
        <div>
<input type="checkbox"
       class="ptv2-switch"
       checked="@ActivatedParts.Contains(p.ProductToPartId)"
       disabled="@ActivatedParts.Contains(p.ProductToPartId)"
       @onclick:preventDefault="true"
       @onclick="() => OnActivatePart(p.ProductToPartId)" />
        </div>

    <!-- 3. Apjoms -->
    <div>@(SelectedBatch!.Planned * p.Quantity)</div>

    <!-- 4. Pie≈°ƒ∑irts -->
    <div></div>

    <!-- 5. Pie≈Üƒìma -->
    <div></div>

    <!-- 6. SƒÅkums (NO SUMMARY API) -->
    <div> </div>

    <!-- 7. Pabeigts (NO SUMMARY API) -->
    <div> </div>

    <!-- 8. KomentƒÅrs -->
    <div></div>

    <!-- 9. Done -->
    <div></div>
</div>

@foreach (var step in p.Steps)
{

    @if (TasksByStep.TryGetValue(step.Id, out var tasks))

    {
        @foreach (var t in tasks)
        {
            <div class="ptv2-tasks-row sub task">
                <!-- 1. Nosaukums (tuk≈°s ‚Äì step jau ir augstƒÅk) -->
                    <div title="@step.StepName">
                        @step.StepName
                    </div>

                        <!-- 2. Gatavs -->
                        <div></div>

                        <!-- 3. Apjoms -->
                        <div></div>

                        <!-- 4. Pie≈°ƒ∑irts -->
                        <div>
                            <select value="@t.Assigned_To"
                                    @onchange="e => OnAssignedChanged(t.TaskId, e)">
                                <option value="">‚Äî</option>
                                @foreach (var emp in Employees)
                                {
                                    <option value="@emp.Id">@emp.Name</option>
                                }
                            </select>
                        </div>

                        <!-- 5. Pie≈Üƒìma -->
                        <div>
                            @Employees.FirstOrDefault(e => e.Id == t.Claimed_By)?.Name

                        </div>

                <!-- 6. SƒÅkums -->
                        <div>
                            @(t.StartedAt.HasValue
                                ? t.StartedAt.Value.ToString("dd.MM.yyyy")
                                : "‚Äî")
                        </div>

                <!-- 7. Pabeigts -->
                        <div>
                            @(t.FinishedAt.HasValue
                                ? t.FinishedAt.Value.ToString("dd.MM.yyyy")
                                : "‚Äî")
                        </div>

                <!-- 8. KomentƒÅrs (vizuƒÅli, funkcija vƒìlƒÅk) -->
                <div class="ptv2-comment-wrap">
                    <input
                        type="text"
                        class="ptv2-comment-input @(string.IsNullOrWhiteSpace(t.Comment) ? "empty" : "")"
                        value="@(string.IsNullOrWhiteSpace(t.Comment) ? "(Pievienot komentƒÅru)" : t.Comment)"
                        readonly />
                        <button
                            type="button"
                            class="ptv2-comment-edit"
                            title="Labot komentƒÅru"
                            @onclick="() => OpenCommentEditor(t)">
                            ‚úé
                        </button>

                </div>


                        <!-- 9. Done (vizuƒÅli checkbox, funkcija vƒìlƒÅk) -->
                <div class="ptv2-done-cell">
                    <input type="checkbox"
                        class="ptv2-done-checkbox"
                        title="Redzams"
                        checked="@(t.Done > 0)" />
                </div>

            </div>
        }
    }
}


}

@if (IsCommentPopupOpen && EditingTask is not null)
{
    <div class="ptv2-popup-backdrop">
        <div class="ptv2-popup">
            <h4>KomentƒÅrs</h4>

                    <textarea
                        style="width:100%; height:80px;"
                        @bind="EditingCommentText">
                    </textarea>

            <div style="margin-top:8px; text-align:right;">
                <button @onclick="CancelComment">Atcelt</button>
                <button style="margin-left:6px;" @onclick="ConfirmComment">OK</button>
            </div>
        </div>
    </div>
}

@code {

    // glabƒÅs ProductToPartId, kuri jau ir aktivizƒìti ≈°ai partijai
    private HashSet<int> ActivatedParts = new();
    
    // DETAILED indikatori pa detaƒºƒÅm
    private Dictionary<int, string> DetailedIndicators = new();

    [Parameter] public ProductBatchRow? SelectedBatch { get; set; }

// Parts ir ProductTopParts konkrƒìtajai VersionId (no SelectedBatch) 26.01.2026
    private List<DetailPartRow> Parts = new();

private sealed class DetailedIndicatorRow
{
    public int ProductToPartId { get; set; }
    public string State { get; set; } = "";
}


    private Dictionary<int, List<DetailTaskRow>> TasksByStep
    = new(); // key = TopPartStepId


    protected override async Task OnParametersSetAsync()
{
    Parts.Clear();
    TasksByStep.Clear();

    if (SelectedBatch?.VersionId is not int vid || vid <= 0)
        return;

// üÜï ielƒÅdƒìjam aktivizƒìtƒÅs detaƒºas (status != 5)
if (SelectedBatch?.BatchId is int batchId && batchId > 0)
{
    var activeParts =
        await Http.GetFromJsonAsync<List<int>>(
            $"http://localhost:5270/api/tasks/active-parts?batchId={batchId}"
        ) ?? new();

    ActivatedParts = activeParts.ToHashSet();
}

// üÜï ielƒÅdƒìjam DETAILED indikatorus (gray / blue / yellow / green)
if (SelectedBatch?.BatchProductId is int batchProductId2 && batchProductId2 > 0)
{
    var indicators =
        await Http.GetFromJsonAsync<List<DetailedIndicatorRow>>(
            $"http://localhost:5270/api/tasks/detailed-indicators?batchProductId={batchProductId2}"
        ) ?? new();

    DetailedIndicators = indicators.ToDictionary(
        x => x.ProductToPartId,
        x => x.State
    );
}

    // 1) IelƒÅdƒìjam ProductTopParts (DETAIL)
    var partsUrl =
        $"http://localhost:5270/api/products/details?versionId={vid}&stepType=1";

    Parts =
        await Http.GetFromJsonAsync<List<DetailPartRow>>(partsUrl)
        ?? new();

    
    if (SelectedBatch?.BatchProductId is not int bpId || bpId <= 0)
        return;

    // 2) IelƒÅdƒìjam DETAIL taskus ≈†AI PARTIJAI
    var tasksUrl =
        $"http://localhost:5270/api/tasks/by-batch" +
        $"?batchProductId={bpId}&stepType=1";

    var tasks =
        await Http.GetFromJsonAsync<List<DetailTaskRow>>(tasksUrl)
        ?? new();

    // 3) Grupƒìjam pƒìc TopPartStep_ID
    TasksByStep = tasks
        .GroupBy(t => t.TopPartStepId)
        .ToDictionary(g => g.Key, g => g.ToList());
    
    // 4) Aprƒìƒ∑inƒÅm PART Start / End no taskiem
foreach (var p in Parts)
{
    var partTasks = tasks
        .Where(t =>
            p.Steps.Any(s => s.Id == t.TopPartStepId))
        .ToList();

    if (partTasks.Count == 0)
        continue;

    p.StartDate = partTasks
        .Where(t => t.StartedAt.HasValue)
        .Min(t => t.StartedAt);

    p.EndDate = partTasks
        .Where(t => t.FinishedAt.HasValue)
        .Max(t => t.FinishedAt);
}

}

private List<EmployeeRow> Employees = new();

protected override async Task OnInitializedAsync()
{
    Employees =
        await Http.GetFromJsonAsync<List<EmployeeRow>>(
            "http://localhost:5270/api/employees")
        ?? new();
}

public sealed class EmployeeRow
{
    public int Id { get; set; }
    public string Name { get; set; } = "";
}

async Task OnAssignedChanged(int taskId, ChangeEventArgs e)
{
    int? empId =
        int.TryParse(e.Value?.ToString(), out var v)
            ? v
            : (int?)null;

    await Http.PostAsJsonAsync(
        "http://localhost:5270/api/tasks/update-assignee",
        new
        {
            TaskId = taskId,
            Assigned_To = empId
        });
}

private sealed class DetailTaskRow
{
    public int TaskId { get; set; }
    public int Status { get; set; }
    public int? Assigned_To { get; set; }
    public int Done { get; set; }

    public int TopPartStepId { get; set; }

    // üÜï NO EmployeeTasks
    public int? Claimed_By { get; set; }
    public DateTime? StartedAt { get; set; }
    public DateTime? FinishedAt { get; set; }
    public string? Comment { get; set; }
}

private sealed class DetailSummaryRow
{
    public int ProductToPartId { get; set; }
    public DateTime? StartedAt { get; set; }
    public DateTime? FinishedAt { get; set; }
}
// switch pogas funkcija 27.01.2026
async Task OnActivatePart(int productToPartId)
{
    if (SelectedBatch?.BatchId is not int batchId || batchId <= 0)
        return;

    var part = Parts.FirstOrDefault(p => p.ProductToPartId == productToPartId);
    if (part is null)
        return;

    var batchCode = SelectedBatch?.BatchCode ?? "‚Äî";

        var ok = await JS.InvokeAsync<bool>(
            "confirm",
            $"Vai detaƒºa \"{part.TopPartName}\" ({batchCode}) ir gatava?"
        );

    if (!ok)
        return;

    

Console.WriteLine(
    $"[UI] BatchProductId={SelectedBatch?.BatchProductId}, ProductToPartId={productToPartId}"
);


    await Http.PostAsJsonAsync(
    "http://localhost:5270/api/tasks/activate-part",
    new
    {
        BatchProductId = SelectedBatch!.BatchProductId,
        ProductToPartId = productToPartId
    }
    );


    var activeParts =
        await Http.GetFromJsonAsync<List<int>>(
            $"http://localhost:5270/api/tasks/active-parts?batchId={batchId}"
        ) ?? new();

    ActivatedParts = activeParts.ToHashSet();

    

    // pƒÅrlƒÅdƒìjam detaƒºas / taskus
    await OnParametersSetAsync();
}

    private bool IsCommentPopupOpen = false;
    private int EditingTaskId;
    private string? EditingComment;
    private DetailTaskRow? EditingTask;

void OpenCommentEditor(DetailTaskRow task)
{
    EditingTask = task;
    EditingCommentText = task.Comment ?? "";
    IsCommentPopupOpen = true;
}


private string EditingCommentText = "";

void CancelComment()
{
    IsCommentPopupOpen = false;
    EditingTask = null;
}

async Task ConfirmComment()
{
    if (EditingTask is not null)
    {
        await Http.PostAsJsonAsync(
            "http://localhost:5270/api/tasks/update-comment",
            new
            {
                TaskId = EditingTask.TaskId,
                Comment = EditingCommentText
            });

        EditingTask.Comment = EditingCommentText;
    }

    IsCommentPopupOpen = false;
    EditingTask = null;
}


}
