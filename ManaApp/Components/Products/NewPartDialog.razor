@namespace ManaApp.Components.Products
@using Syncfusion.Blazor.Popups
@using ManaApp.Models
@inject HttpClient Http
@inject IJSRuntime JS

<SfDialog Width="760px"
          Height="520px"
          ShowCloseIcon="true"
          IsModal="true"
          ZIndex="10060"
          CssClass="topPartManageDialog"
          Visible="Visible"
          VisibleChanged="VisibleChanged">

    <DialogTemplates>

        <Header>
            Detaļu veidu pārvaldība
        </Header>

        <Content>

            <div style="display:flex; gap:18px; height:100%; overflow:hidden;">

<!-- KREISĀ PUSE -->
<div style="flex:1; border-right:1px solid #ddd; padding-right:15px; overflow:auto;">

    @if (topParts is null || topParts.Count == 0)
    {
        <div>Nav datu</div>
    }
    else
    {
        @foreach (var group in topParts
                                .OrderBy(x => x.Stage)
                                .GroupBy(x => x.Stage))
        {
            <div style="margin-bottom:15px;">

                <div class="stage-title">
                    @(group.Key == 1 ? "DETAĻU SAGATAVOŠANAS POSMS"
                    : group.Key == 2 ? "KOMPLEKTĒŠANAS POSMS"
                    : "KRĀSOŠANAS POSMS")
                </div>

                @foreach (var part in group)
                {
                    <div class="stage-item">
                        <input type="checkbox"
                            checked="@(selectedPart?.Id == part.Id)"
                            @onchange="() => SelectPart(part)" />
                        @part.TopPartName
                    </div>
                }

            </div>
        }
    }

</div>

                <!-- LABĀ PUSE -->
<div style="flex:1; padding-left:15px;">

<div class="dialog-header-row">

    <div class="dialog-title">
        @(isNewMode
            ? "Jaunas detaļas pievienošana"
            : selectedPart is not null
                ? "Detaļas labošana"
                : "")
    </div>

<button class="dialog-new-btn"
        @onclick="StartNew">
    + Jauns
</button>

</div>

@if (isNewMode)
{
    <div style="margin-bottom:10px;">
        <label>Posms</label>
            <select class="erp-select"
                    @bind="newStage">
                <option value="1">DETAĻAS</option>
                <option value="2">KOMPLEKTĒŠANA</option>
                <option value="3">KRĀSOŠANA</option>
            </select>
    </div>

    <div style="margin-bottom:10px;">
        <label>Nosaukums</label>
        <input class="erp-input"
               @bind="editName" />
    </div>

    <div style="margin-bottom:10px;">
        <label>Kods (3 simboli)</label>
        <input class="erp-input"
       maxlength="3"
       style="text-transform:uppercase"
       @bind="editCode"
       @bind:event="oninput" />
    </div>

    <button class="btn btn-primary"
            @onclick="SaveNew">
        Saglabāt
    </button>
}
else if (selectedPart is null)
{
    <div>Izvēlies detaļu kreisajā pusē.</div>
}
else
{
        <div style="margin-bottom:10px;">
            <strong>Posms:</strong>
            @(selectedPart.Stage == 1 ? "DETAĻAS"
            : selectedPart.Stage == 2 ? "KOMPLEKTĒŠANA"
            : "KRĀSOŠANA")
        </div>

        <div style="margin-bottom:10px;">
            <label>Nosaukums</label>
            <input class="erp-input"
                   @bind="editName" />
        </div>

        <div style="margin-bottom:10px;">
            <label>Kods (3 simboli)</label>
            <input class="erp-input"
                maxlength="3"
                @bind="editCode" />
        </div>

        <button class="btn btn-primary"
                @onclick="SaveEdit">
            Saglabāt
        </button>

    }

</div>

            </div>

        </Content>

    </DialogTemplates>

</SfDialog>

@code {

    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
private string _editCode = "";

private string editCode
{
    get => _editCode;
    set => _editCode = (value ?? "").ToUpper();
}
private List<TopPartDto> topParts = new();

protected override async Task OnParametersSetAsync()
{
    if (Visible)
    {
        topParts = await Http.GetFromJsonAsync<List<TopPartDto>>(
            "http://localhost:5270/api/topparts") ?? new();
    }
}

private TopPartDto? selectedPart;
private string editName = "";

private void SelectPart(TopPartDto part)
{
    if (selectedPart?.Id == part.Id)
    {
        // ja nospiež to pašu vēlreiz → noņem atlasi
        selectedPart = null;
        editName = "";
        editCode = "";
        return;
    }

    isNewMode = false;
    selectedPart = part;
    editName = part.TopPartName;
    editCode = part.TopPartCode;
}
private async Task SaveEdit()
{
    if (selectedPart is null)
        return;

    if (string.IsNullOrWhiteSpace(editName))
        return;

    if (string.IsNullOrWhiteSpace(editCode) || editCode.Length != 3)
        return;

    var resp = await Http.PutAsJsonAsync(
        "http://localhost:5270/api/topparts",
        new
        {
            Id = selectedPart.Id,
            TopPartName = editName,
            TopPartCode = editCode
        });

    if (resp.IsSuccessStatusCode)
    {
        selectedPart.TopPartName = editName;
        selectedPart.TopPartCode = editCode;

        selectedPart = null;
        editName = "";
        editCode = "";
    }
}

private bool isNewMode = false;
private int newStage = 1;

private void StartNew()
{
    selectedPart = null;
    editName = "";
    newStage = 1;
    editCode = "";
    isNewMode = true;
}

private async Task SaveNew()
{
    if (string.IsNullOrWhiteSpace(editName))
    {
        await JS.InvokeVoidAsync("alert", "Nosaukums ir obligāts.");
        return;
    }

    if (string.IsNullOrWhiteSpace(editCode) || editCode.Length != 3)
    {
        await JS.InvokeVoidAsync("alert", "Kods obligāts un jābūt tieši 3 simboliem.");
        return;
    }

    var ok = await JS.InvokeAsync<bool>(
        "confirm",
        "Vai pievienot jaunu detaļas veidu?");
    if (!ok) return;

    var resp = await Http.PostAsJsonAsync(
        "http://localhost:5270/api/topparts",
        new
        {
            TopPartName = editName,
            TopPartCode = editCode,
            Stage = newStage
        });

    if (resp.IsSuccessStatusCode)
    {
        var created = await resp.Content.ReadFromJsonAsync<TopPartDto>();

        if (created != null)
            topParts.Add(created);

        isNewMode = false;
        editName = "";
        editCode = "";
    }
    else
    {
        var error = await resp.Content.ReadAsStringAsync();
        await JS.InvokeVoidAsync("alert", error);
    }
}

}