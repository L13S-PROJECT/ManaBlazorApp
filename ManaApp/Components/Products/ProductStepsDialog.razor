@using ManaApp.Models
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@inject IJSRuntime JS


<SfDialog Width="720px"
          ShowCloseIcon="true"
          IsModal="true"
          ZIndex="10050"
          Header="Tehnoloƒ£ijas soƒºi"
          Visible="Visible"
        VisibleChanged="VisibleChanged">
<DialogEvents Opened="@( (Syncfusion.Blazor.Popups.OpenEventArgs args) => OnDialogOpened(args) )" />
<DialogTemplates>
<Content>
<div class="steps-dialog">
    @if (Steps is null || Steps.Count == 0)
    {
        <div style="opacity:.7">≈†ai detaƒºai soƒºu nav.</div>
    }
    else
    {
    <div class="steps-table">
    <div class="steps-table-head steps-grid">
        <div class="steps-th steps-th-order">Secƒ´ba</div>
        <div class="steps-th">Nosaukums</div>
        <div class="steps-th steps-th-workcenter">Darba centrs</div>
        <div class="steps-th steps-th-flags">Statuss</div>
        <div class="steps-th">KomentƒÅrs</div>
        <div class="steps-th steps-th-actions"></div>
    </div>

    <div class="steps-table-body">
            @for (int i = 0; i < Steps!.Count; i++)
            {
                var s = Steps[i];
                var index = i;

<div @key="s"
     class="steps-tr steps-grid @( _selectedIndex == index ? "dragging" : "" ) 
     @( _hoverIndex == index && _isDragging && _selectedIndex != index ? "drop-target" : "" )"
     @onmouseenter="() => OnDragEnter(index)"
     @onmouseup="EndDrag">
              
                <div class="steps-order-cell">
                    <span class="steps-drag-handle"
                        @onmousedown="() => StartDrag(index)"
                        title="PƒÅrvietot">‚ãÆ‚ãÆ</span>
                </div>

                <div>
                    <input class="steps-input"
                        type="text"
                        @bind="s.StepName"
                        @bind:event="oninput"
                        placeholder="Pievienot nosaukumu" />
                </div>

                <div>
                    <SfDropDownList TValue="int" TItem="WorkCenter"
                                    CssClass="steps-ddl"
                                    PopupCssClass="steps-ddl-popup-small"
                                    DataSource="WorkCenters"
                                    @bind-Value="s.WorkCentrId"
                                    Width="100%">
                        <DropDownListFieldSettings Text="WorkCentr_Name" Value="Id" />
                    </SfDropDownList>
                </div>

                <div class="steps-flags-cell">
                    <label class="steps-flag" title="Paralƒìls solis">
                        <input type="checkbox" @bind="s.IsParallel" />
                        <span class="flag-icon parallel"></span>
                    </label>

                    <label class="steps-flag" title="Pƒìdƒìjais (Final) solis">
                        <input type="checkbox"
                               checked="@s.IsFinal"
                               disabled="@( !IsLastStep(s) )"
                               @onchange="() => OnSetFinal.InvokeAsync(s)" />
                        <span class="flag-icon final"></span>
                    </label>
                </div>

                <div>
                    <input class="steps-input steps-input-pill"
                           type="text"
                           value="@s.Comments"
                           @onchange="e => s.Comments = e.Value?.ToString()" />
                </div>

                <div class="steps-td-right">
                    <button type="button"
                            class="steps-btn"
                            @onclick="() => OnDelete.InvokeAsync(s)"
                            title="Dzƒìst">üóë</button>
                </div>
            </div>
        }
                        
    </div>
</div>
    }
</div>
</Content>

<FooterTemplate>
    <div class="steps-footer">

        <button type="button"
                class="action-btn action-btn-sm"
                title="Pievieno jaunu tehnoloƒ£ijas soli ≈°ai detaƒºai"
                @onclick="OnAddStep">
            + Pievienot soli
        </button>

        <button type="button"
                class="action-btn action-btn-sm action-btn-primary"
                title="SaglabƒÅt"
                @onclick="OnSave">
            SaglabƒÅt
        </button>

        <button type="button"
                class="action-btn action-btn-sm"
                title="Aizvƒìrt logu"
                @onclick="OnClose">
            Aizvƒìrt
        </button>

    </div>
</FooterTemplate>
</DialogTemplates>

</SfDialog>


@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public List<PartStepDto>? Steps { get; set; }
    [Parameter] public IEnumerable<StepTypeDto>? StepTypes { get; set; }
    [Parameter] public IEnumerable<WorkCenter>? WorkCenters { get; set; }
    [Parameter] public EventCallback<PartStepDto> OnMoveUp { get; set; }
    [Parameter] public EventCallback<PartStepDto> OnMoveDown { get; set; }
    [Parameter] public EventCallback<PartStepDto> OnDelete { get; set; }
    [Parameter] public EventCallback<PartStepDto> OnSetFinal { get; set; }

private bool IsLastStep(PartStepDto s)
    {
        if (Steps is null || Steps.Count == 0)
            return false;

        var maxOrder = Steps.Max(x => x.StepOrder);
        return s.StepOrder == maxOrder;
    }
[Parameter] public EventCallback OnOpenStepTypes { get; set; }
[Parameter] public EventCallback OnOpenWorkCenters { get; set; }

[Parameter] public EventCallback OnAddStep { get; set; }
[Parameter] public EventCallback OnSave { get; set; }
[Parameter] public EventCallback OnClose { get; set; }

private int? _dragIndex = null;

private int? _selectedIndex = null;

private void SelectForMove(int index)
{   
        if (_selectedIndex is null)
        {
            _selectedIndex = index;
            StateHasChanged();
            return;
        }

        if (_selectedIndex == index)
        {
            _selectedIndex = null;
            StateHasChanged();
            return;
        }

    var item = Steps![_selectedIndex.Value];
    Steps.RemoveAt(_selectedIndex.Value);
    Steps.Insert(index, item);

    _selectedIndex = null;

    for (int i = 0; i < Steps.Count; i++)
        Steps[i].StepOrder = (i + 1) * 10;

    StateHasChanged();
}
private int? _hoverIndex = null;

private void SetHover(int index)
{
    if (_selectedIndex != null)
        _hoverIndex = index;
}

private bool _isDragging = false;

private void StartDrag(int index)
{
    _selectedIndex = index;
    _hoverIndex = index;
    _isDragging = true;
    StateHasChanged();
}

private void OnDragEnter(int index)
{
    if (!_isDragging || _selectedIndex == null || Steps == null)
        return;

    if (index == _selectedIndex)
        return;

    var item = Steps[_selectedIndex.Value];
    Steps.RemoveAt(_selectedIndex.Value);
    Steps.Insert(index, item);

    _selectedIndex = index;
    _hoverIndex = index;

    for (int i = 0; i < Steps.Count; i++)
        Steps[i].StepOrder = (i + 1) * 10;

    StateHasChanged();
}

private void EndDrag()
{
    _isDragging = false;
    _selectedIndex = null;
    _hoverIndex = null;
    StateHasChanged();
}

private void OnDialogOpened(Syncfusion.Blazor.Popups.OpenEventArgs args)
{
    args.PreventFocus = true;
}

}