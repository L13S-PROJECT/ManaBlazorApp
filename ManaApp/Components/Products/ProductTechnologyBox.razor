@namespace ManaApp.Components.Products
@using ManaApp.Models

<div class="technology-panel">

    <div class="technology-panel-header">
        TehnoloÄ£ija
    </div>

    <div class="technology-panel-body">

    @if (Selected is not null)
    {
        <div class="technology-header-actions">
            @if (OnAddPart.HasDelegate)
            {
                <button type="button"
                        class="action-btn tech-add-btn"
                        title="Pievienot jaunu detaÄ¼u"
                        @onclick="OnAddPart">
                    + pievienot
                </button>

                <button type="button"
                        class="action-btn tech-manage-btn"
                        title="PÄrvaldÄ«t soÄ¼u tipus"
                        @onclick="OnOpenStepTypes">
                    SoÄ¼u tipi
                </button>

                <button type="button"
                        class="action-btn tech-manage-btn"
                        title="PÄrvaldÄ«t darba centrus"
                        @onclick="OnOpenWorkCenters">
                    Darba centri
                </button>
            }
        </div>
    }

        @if (Selected is null)
        {
            <div style="opacity:.7">IzvÄ“lies rindu kreisajÄ pusÄ“.</div>
        }
        else if (LoadingPartDetails || LoadingWorks)
        {
            <div style="opacity:.7">IelÄdÄ“juâ€¦</div>
        }
        else if ((WorksByParts is null || WorksByParts.Count == 0)
              && (SelectedPartDetails is null || SelectedPartDetails.Count == 0))
        {
            <div style="opacity:.7">Nav detaÄ¼u.</div>
        }
        else
        {
            @foreach (var part in (WorksByParts ?? new List<WorksByPartDto>()))
            {
                <div class="tech-item">
                    <div class="tech-head" @onclick="() => TogglePart(part.TopPartCode)">
                        <span class="tech-toggle">
                            @(openParts.Contains(part.TopPartCode ?? "") ? "âˆ’" : "+")
                        </span>
                        <span class="tech-code">@part.TopPartCode</span>
                        <span class="tech-name">â€” @part.TopPartName</span>
                        <span class="tech-qty">
                            @{
                                var qty = SelectedPartDetails?
                                    .FirstOrDefault(x => x.TopPartCode == part.TopPartCode)?
                                    .Quantity ?? 0;
                            }
                            @(qty > 0 ? $"x{qty}" : "")
                        </span>

                        <button type="button"
                                class="action-btn tech-manage-btn"
                                @onclick="(e) => OnOpenSteps.InvokeAsync(part.TopPartCode)"
                                @onclick:stopPropagation="true">
                            + SoÄ¼i
                        </button>

                        <button type="button"
                                class="tech-delete-btn"
                                title="DzÄ“st detaÄ¼u"
                                aria-label="DzÄ“st detaÄ¼u"
                                @onclick="() => OnDeletePart.InvokeAsync(part.TopPartCode)"
                                @onclick:stopPropagation="true">
                            ğŸ—‘
                        </button>
                    </div>
                </div>

                @if (openParts.Contains(part.TopPartCode ?? "") && part.Steps?.Any() == true)
                {
                    <ul class="tech-steps">
                        @foreach (var s in part.Steps!)
                        {
                            <li class="tech-step">
                                <span class="tech-step-arrow">âœ</span>
                                <span class="tech-step-name">@s.StepName</span>
                            </li>
                        }
                    </ul>
                }
            }
        }

    </div>
</div>

@code {
    [Parameter] public ProductRow? Selected { get; set; }
    [Parameter] public bool LoadingPartDetails { get; set; }
    [Parameter] public bool LoadingWorks { get; set; }
    [Parameter] public List<ProductDetailDto>? SelectedPartDetails { get; set; }
    [Parameter] public List<WorksByPartDto>? WorksByParts { get; set; }

    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public EventCallback OnAddPart { get; set; }
    [Parameter] public EventCallback<string?> OnOpenSteps { get; set; }
    [Parameter] public EventCallback<string?> OnDeletePart { get; set; }
    [Parameter] public EventCallback OnOpenStepTypes { get; set; }
    [Parameter] public EventCallback OnOpenWorkCenters { get; set; }
    private HashSet<string> openParts = new();

private void TogglePart(string? code)
{
    if (string.IsNullOrWhiteSpace(code)) return;

    if (!openParts.Add(code))
        openParts.Remove(code);
}
}