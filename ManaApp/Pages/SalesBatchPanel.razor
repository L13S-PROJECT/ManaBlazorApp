@using ManaApp.Shared
@using ManaApp.Components
@using ManaApp.Models
@inject NavigationManager Nav



@if (activeSheet == BatchPanelSheet.Sales)
{
    
    <h4 class="panel-subtitle">Pievienotās preces</h4>

    <div class="sales-actions">
    <button class="action-btn"
            @onclick="EditSalesRequested"
            disabled="@(!SalesItems.Any())">
        LABOT
    </button>

    <button class="action-btn"
            @onclick="OnSold"
            disabled="@(!SalesItems.Any())">
        PĀRDOT
    </button>

    <button class="action-btn"
        @onclick="OpenDeliveryNote"
        disabled="@(!SalesItems.Any())">
    RĒĶINS
</button>

</div>


    @if (SalesItems.Count == 0)
    {
        <div style="opacity:.6;font-size:13px;">
            Nav pievienotu preču
        </div>
    }
    else
    {
        <div style="margin-top:12px;">

            @foreach (var it in SalesItems)
            {
                <div class="sales-row">
                <div class="sales-info-row">

    <div style="display:flex; gap:6px;">
</div>

    <span class="sales-name">
    @it.ProductName
    <span class="sales-version">@it.VersionName</span>
</span>
    <span class="sales-type">@(it.IsAssembly ? "ASSEMBLY" : "STOCK")</span>
    <span class="sales-qty">@it.Qty GB</span>
</div>
                       
                </div>
            }
        </div>
    }
}
  
<BatchLineEditDialog
    IsOpen="isEditOpen"
    IsOpenChanged="v => isEditOpen = v"
    Line="editLine"
    OnSaved="OnEditSaved" />


        @if (isCreateOpen)
        {
            <CreatePlanDialog
                ErrorMessage="@createPlanError"
                OnConfirm="CreateConfirmed"
                OnCancel="() => isCreateOpen = false" />

        }

@if (isEditSalesOpen && editingSalesItem is not null)
{
    <SalesMinusDialog
        ProductName="@editingSalesItem.ProductName"
        VersionName="@editingSalesItem.VersionName"
        InitialQty="@editingSalesItem.Qty"
        MaxQty="@editingSalesItem.InStock"
        OnConfirm="OnEditSalesConfirmed"
        OnCancel="CloseEditSalesDialog" />
}

@code {

[Inject] private HttpClient Http { get; set; } = default!;
[Inject] private IJSRuntime JS { get; set; } = default!;


[Parameter]
public IReadOnlyList<BatchCartItem> Items { get; set; }
    = Array.Empty<BatchCartItem>();

[Parameter] public EventCallback<BatchCartItem> OnEdit { get; set; }
[Parameter] public EventCallback<BatchCartItem> OnDelete { get; set; }

[Parameter] public EventCallback EditSalesRequested { get; set; }

private string? createPlanError;

private int editQty;
private string? editComment;

public void StartEdit(ManaApp.Shared.BatchCartItem item)
{
    editQty = item.Qty;
    editComment = item.Comment;
    StateHasChanged();
}

private string DraftTitle =>
    Items.Count == 0
        ? ""
        : $"Melnraksts no {DateTime.Now:dd.MM.yyyy}";


private void OnEditSaved(ProductionTasks.BatchLine line)
{
    // te vēlāk ieliksim precīzu piesaisti pie Items
    isEditOpen = false;
    StateHasChanged();
}

private ProductionTasks.BatchLine? editLine;

private BatchCartModel Model = new();

public class BatchCartModel
{
    public int? BatchId { get; set; }
    public string Title { get; set; } = string.Empty;
    public string? Comment { get; set; }
    public List<ManaApp.Shared.BatchCartItem> Items { get; set; } = new();
}

private async Task<bool> SaveDraftAsync()
{
    var url = Model.BatchId.HasValue
        ? "http://localhost:5270/api/batches/draft/update"
        : "http://localhost:5270/api/batches/draft/create";

    try
    {
        SyncItemsToModel();
var resp = await Http.PostAsJsonAsync(url, Model);


        if (!resp.IsSuccessStatusCode)
        {
            var txt = await resp.Content.ReadAsStringAsync();
            if (resp.StatusCode == System.Net.HttpStatusCode.Conflict)
                await JS.InvokeVoidAsync("alert", txt);
            else
                await JS.InvokeVoidAsync(
                    "alert",
                    $"Draft saglabāšana neizdevās ({(int)resp.StatusCode}).\n{txt}"
                );

            return false;
        }

        var data = await resp.Content.ReadFromJsonAsync<Dictionary<string, int>>();
        if (data != null && data.TryGetValue("batchId", out var id))
            Model.BatchId = id;

        return true;
    }
    catch (Exception ex)
    {
        await JS.InvokeVoidAsync(
            "alert",
            $"Draft saglabāšanas kļūda.\n{ex.Message}"
        );
        return false;
    }
}

private int? editingIndex = null;
private ManaApp.Shared.BatchCartItem itemDraft = new();

private void AddItem(ManaApp.Shared.BatchCartItem item)
{
    // dublikātu aizliegums (pēc VersionId vai ProductId)
    var dupe = Model.Items.Any(x =>
        x.VersionId == item.VersionId || x.ProductId == item.ProductId);

    if (dupe)
    {
        JS.InvokeVoidAsync("alert", "Šī prece jau ir pievienota.");
        return;
    }

    Model.Items.Add(item.Clone());
}

private void StartEditItem(int idx)
{
    editingIndex = idx;
    itemDraft = Model.Items[idx].Clone();
}
private void SaveEditItem()
{
    if (editingIndex is null)
        return;

    // dublikātu pārbaude (izņemot pašu sevi)
    var dupe = Model.Items
        .Where((_, i) => i != editingIndex.Value)
        .Any(x =>
            x.VersionId == itemDraft.VersionId ||
            x.ProductId == itemDraft.ProductId);

    if (dupe)
    {
        JS.InvokeVoidAsync("alert", "Šī prece jau ir pievienota.");
        return;
    }

    Model.Items[editingIndex.Value] = itemDraft.Clone();
    editingIndex = null;
}
private async Task DeleteItem(int idx)
{
    var ok = await JS.InvokeAsync<bool>("confirm", "Vai dzēst rindu?");
    if (!ok) return;

    // ja melnraksts jau DB — dzēs arī serverī
    if (Model.BatchId.HasValue && Model.BatchId > 0)
    {
        var line = Model.Items[idx];
        var url = $"http://localhost:5270/api/batches/{Model.BatchId.Value}/line/{line.VersionId}";
        await Http.DeleteAsync(url);
    }

    Model.Items.RemoveAt(idx);
}

private void SyncItemsToModel()
{
    Model.Items.Clear();

    foreach (var it in Items)
    {
        Model.Items.Add(new BatchCartItem
{
    VersionId = it.VersionId,   // ⬅️ ŠIS SALABO FK
    Code = it.Code,
    Name = it.Name,
    Qty = it.Qty,
    Comment = it.Comment
});

    }
}

private async Task SaveDraftClicked()
{
    SyncItemsToModel();

    if (string.IsNullOrWhiteSpace(Model.Title) || Model.Items.Count == 0)
    {
        await JS.InvokeVoidAsync("alert", "Nepieciešams nosaukums un vismaz 1 prece.");
        return;
    }

    await SaveDraftAsync();
}

private bool isEditOpen = false;
private int editIndex = -1;
private void OpenEdit(BatchCartItem it)
{
    // izveidojam rindu dialogam
    editLine = new ProductionTasks.BatchLine
    {
        BatchCode = it.Code,      // ja nav īstā lauka, nav kritiski – tikai virsrakstam
        Planned   = it.Qty,
        Comment   = it.Comment,
        BatchStatus = 5           // lai ļauj labot qty (pēc tava dialoga loģikas)
    };

    isEditOpen = true;
}
private enum BatchPanelSheet
{
    Sales
}

private BatchPanelSheet activeSheet = BatchPanelSheet.Sales;

private CancellationTokenSource? _commentCts;

private async Task OnCommentChanged()
{
    _commentCts?.Cancel();
    _commentCts = new CancellationTokenSource();

    try
    {
        await Task.Delay(600, _commentCts.Token);
        await SaveCommentToDbAsync(); // ⬅️ VIENMĒR
    }
    catch (TaskCanceledException) { }
}


private async Task SaveCommentToDbAsync()
{
    // 1️⃣ ja vēl NAV batch → izveidojam draft tikai ar komentāru
    if (!Model.BatchId.HasValue || Model.BatchId <= 0)
    {
        var createDto = new
        {
            Title = "",               // backend pats ģenerēs
            Comment = Model.Comment,
            Items = new List<BatchCartItem>()
        };

        var resp = await Http.PostAsJsonAsync(
            "http://localhost:5270/api/batches/draft/create",
            createDto
        );

        if (!resp.IsSuccessStatusCode)
            return;

        var data = await resp.Content.ReadFromJsonAsync<Dictionary<string, int>>();
        if (data != null && data.TryGetValue("batchId", out var id))
        {
            Model.BatchId = id;
        }

        return;
    }

    // 2️⃣ ja batch jau eksistē → update
    var updateDto = new
    {
        BatchId = Model.BatchId.Value,
        Title = "",                 // nemainām
        Comment = Model.Comment,
        Items = Items.Select(it => new
        {
            VersionId = it.VersionId,
            Qty = it.Qty,
            Comment = it.Comment
        })
    };

    await Http.PostAsJsonAsync(
        "http://localhost:5270/api/batches/draft/update",
        updateDto
    );
}

public void SetComment(string? comment)
{
    Model.Comment = comment;
    StateHasChanged();
}

[Parameter]
public int? BatchId { get; set; }

protected override void OnParametersSet()
{
    Model.BatchId = BatchId;
    StateHasChanged();
}


private bool isCreateOpen = false;

private void OpenCreateDialog()
{
    isCreateOpen = true;
}

[Parameter]
public Func<string, Task<bool>>? OnCreateConfirmed { get; set; }

private async Task CreateConfirmed(string planCode)
{
    createPlanError = null;

    if (OnCreateConfirmed is null)
        return;

    var success = await OnCreateConfirmed(planCode);

    if (success)
    {
        // ✅ viss OK → aizveram popup
        isCreateOpen = false;
        StateHasChanged();
    }
    else
    {
        // ❌ kļūda → popup paliek vaļā
        isCreateOpen = true;
        StateHasChanged();
    }
}

public void SetCreateError(string message)
{
    createPlanError = message;
    isCreateOpen = true;
    StateHasChanged();
}

public void CloseCreateDialog()
{
    createPlanError = null;
    isCreateOpen = false;
    StateHasChanged();
}

private async Task DeleteDraftClicked()
{
    if (Model.BatchId == null || Model.BatchId <= 0)
        return;

    var ok = await JS.InvokeAsync<bool>(
        "confirm",
        "Vai tiešām dzēst melnrakstu?"
    );

    if (!ok)
        return;

    // izsaucam parent (Planning.razor)
    await OnDeleteDraft.InvokeAsync();
}

[Parameter]
public EventCallback OnDeleteDraft { get; set; }

[Parameter]
public IReadOnlyList<SalesCartItem> SalesItems { get; set; }
    = Array.Empty<SalesCartItem>();


public void Refresh()
{
    InvokeAsync(StateHasChanged);
}

// pievienot pogu Pārdošanas panelī
[Parameter]
public EventCallback OnSold { get; set; }

private async Task OnSoldClicked()
{
    if (OnSold.HasDelegate)
        await OnSold.InvokeAsync();
}

// pievienot pogu Pārdošanas panelī pardošanas rindai
private void EditSalesItem(SalesCartItem item)
{
    editingSalesItem = new SalesCartItem
{
    VersionId   = item.VersionId,
    ProductName = item.ProductName,
    VersionName = item.VersionName,
    Qty         = item.Qty,
    InStock     = item.InStock,
    IsAssembly  = item.IsAssembly,

    Batches = item.Batches
        .Select(b => new SalesBatchItem
        {
            BatchProductId = b.BatchProductId,
            BatchCode      = b.BatchCode,
            Qty            = b.Qty,
            AvailableQty   = b.AvailableQty
        })
        .ToList()
};

    isEditSalesOpen = true;
    StateHasChanged();
}

private bool isEditSalesOpen = false;
private SalesCartItem? editingSalesItem;

private void CloseEditSalesDialog()
{
    isEditSalesOpen = false;
    editingSalesItem = null;
}

[Parameter]
public EventCallback OnAutosave { get; set; }

private async Task OnEditSalesConfirmed(int qty)

{
    if (editingSalesItem != null)
{
    // Qty vienmēr rēķinām no batchiem
    editingSalesItem.Qty = editingSalesItem.Batches.Sum(b => b.Qty);
}
CloseEditSalesDialog();
StateHasChanged();
await OnAutosave.InvokeAsync();


}

private async Task DeleteSalesItem(SalesCartItem item)
{
    var ok = await JS.InvokeAsync<bool>(
        "confirm",
        "Vai izdzēst rindu?"
    );

    if (!ok)
        return;

    SalesItems = SalesItems
        .Where(x => x != item)
        .ToList();

    StateHasChanged();
}

private void OpenDeliveryNote()
{
    Nav.NavigateTo("/sales-delivery-note", true);
}


}
