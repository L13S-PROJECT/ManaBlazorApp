@page "/products"
@using System.Net.Http.Json
@using System.Linq
@using ManaApp.Models
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using Microsoft.JSInterop
@using ManaApp.Shared
@inject HttpClient Http
@inject IJSRuntime JS
@layout MainLayout
@using ManaApp.Components.Products
@using ManaApp.Pages
       
<PageHeader Title="Produkts" />

<div class="products-main">

        <!-- vidÄ“jÄ zona: pa kreisi saraksts, pa labi 3 bloki -->
        <div class="products-content">

            <!-- KREISÄ€ PUSE: filtri + grida saraksts -->
            <div class="products-left">

                <div @key="filterResetKey">
<ProductsFilters
    Categories="filteredCategories"
    HasFilters="HasAnyFilters"
    OnCategoryChanged="OnCategoryFilterChanged"
    OnSearch="OnSearchInput"
    OnClear="ClearFilters">

    <RootButtons>
        <button type="button"
                class="root-pill @(string.IsNullOrWhiteSpace(selectedRoot) ? "active" : "")"
                @onclick='@(() => SetRootFilter(""))'>
            Visi
        </button>

        <button type="button"
                class="root-pill @(selectedRoot == "KAUSS" ? "active" : "")"
                @onclick='@(() => SetRootFilter("KAUSS"))'>
            Kausi
        </button>

        <button type="button"
                class="root-pill @(selectedRoot == "ADAPTERIS" ? "active" : "")"
                @onclick='@(() => SetRootFilter("ADAPTERIS"))'>
            Adapteri
        </button>
    </RootButtons>

    <Actions>
        <button type="button"
                class="action-btn"
                @onclick="OpenDialog">
            Jauns
        </button>

        <button type="button"
                class="action-btn"
                @onclick="OpenEditDialog"
                disabled="@(selected is null || selectedDetails is null)">
            Labot
        </button>

        <button type="button"
                class="action-btn"
                @onclick="SoftDeleteSelected"
                disabled="@(selected is null)">
            DzÄ“st
        </button>
    </Actions>

            </ProductsFilters>

            <ProductsGrid
                Rows="rows"
                OnRowSelected="Grid_RowSelected" />
                </div>
 </div>

            <!-- LABÄ€ PUSE: Preces saturs + TehnoloÄ£ija -->
            <div class="products-right">

<ProductContentBox
    Selected="selected"
    Details="selectedDetails"
    Loading="loadingDetails" />

                <!-- TehnoloÄ£ija -->

<ProductTechnologyBox
    Selected="selected"
    LoadingPartDetails="loadingPartDetails"
    LoadingWorks="loadingWorks"
    SelectedPartDetails="selectedPartDetails"
    WorksByParts="worksByParts"
    OnAddPart="OpenNewPartDialog"
    OnOpenSteps="OpenStepsForPart">
</ProductTechnologyBox>

        </div>
    </div>
</div>


<!-- === PRECES dialogs (JAUNS/LABOT) === -->
<SfDialog
    Width="620px"
    ShowCloseIcon="true"
    IsModal="true"
    ZIndex="10000"
    Header="@(isEdit ? "Labot preci" : "Jauna prece")"
    @bind-Visible="isDialogVisible">

    <DialogTemplates>
        <Content>
        
            <div style="display:grid; gap:.75rem; padding:.5rem;">
                <!-- VecÄkkategorija -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Kategorija (vecÄka)</label>
                    <SfDropDownList TValue="int?" TItem="CategoryDto"
                                    Placeholder="-- izvÄ“lies vecÄk-kategoriju --"
                                    @bind-Value="selectedParentId"
                                    DataSource="parentOptions"
                                    AllowFiltering="true"
                                    FloatLabelType="FloatLabelType.Never"
                                    Width="100%"
                                    Enabled="@( !isEdit )">
                        <DropDownListFieldSettings Text="CategoryName" Value="Id"></DropDownListFieldSettings>
                    </SfDropDownList>
                    @if (showValidation && !isEdit && selectedParentId is null)
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligÄti jÄizvÄ“las.</div>
                    }
                </div>

                <!-- BÄ“rnkategorija -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Kategorija (bÄ“rna)</label>
                    <SfDropDownList TValue="int?" TItem="CategoryDto"
                                    Placeholder="-- izvÄ“lies bÄ“rn-kategoriju --"
                                    @bind-Value="selectedChildId"
                                    DataSource="childOptions"
                                    Enabled="@(selectedParentId is not null && !isEdit)"
                                    AllowFiltering="true"
                                    Width="100%">
                        <DropDownListFieldSettings Text="CategoryName" Value="Id"></DropDownListFieldSettings>
                    </SfDropDownList>
                    @if (showValidation && selectedChildId is null)
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligÄti jÄizvÄ“las.</div>
                    }
                </div>

                <!-- Nosaukums -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Nosaukums</label>
                    <SfTextBox @bind-Value="newName" Placeholder="Preces nosaukums" Width="100%"></SfTextBox>
                    @if (showValidation && string.IsNullOrWhiteSpace(newName))
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligÄts lauks.</div>
                    }
                </div>

                <!-- Kods -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Kods</label>
                    <SfTextBox @bind-Value="newCode" Placeholder="Preces kods" Width="100%"></SfTextBox>
                    @if (showValidation && string.IsNullOrWhiteSpace(newCode))
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligÄts lauks.</div>
                    }
                </div>

@if (isEdit)
{
  <div class="form-check my-2" style="margin-top:.25rem;">
    <input class="form-check-input" type="checkbox" id="chkNewVersion" @bind="createNewVersion" />
    <label class="form-check-label" for="chkNewVersion">
      Izveidot jaunu versiju
    </label>
  </div>

  @if (createNewVersion)
  {
    <div class="form-check my-2" style="margin-left:1.25rem;">
      <input class="form-check-input"
             type="checkbox"
             id="chkCopySteps"
             @bind="copyTechnologySteps" />
      <label class="form-check-label" for="chkCopySteps">
        KopÄ“t tehnoloÄ£ijas soÄ¼us
      </label>
    </div>
  }
}


                <!-- Versija (obligÄts) -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Versija</label>
                    <SfTextBox @bind-Value="newVersionName"
                               Placeholder="Versijas nosaukums"
                               Width="100%"
                               Enabled="@( !(isEdit && !createNewVersion) )"></SfTextBox>
                    @if (isEdit && !createNewVersion)
                    {
                        <div style="font-size:.85em; opacity:.75;">AktÄ«vÄs versijas nosaukumu nevar mainÄ«t. AtzÄ«mÄ“ â€œIzveidot jaunu versijuâ€, lai ievadÄ«tu jaunu.</div>
                    }
                    @if (showValidation && ( !isEdit || createNewVersion ) && string.IsNullOrWhiteSpace(newVersionName))
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligÄts lauks.</div>
                    }
                </div>

                <!-- RasÄ“jums (neobligÄts) -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">RasÄ“jums</label>
                    <SfTextBox @bind-Value="newVersionRasejums" Placeholder="RasÄ“juma identifikators/saite" Width="100%"></SfTextBox>
                </div>

                <!-- Datums (obligÄts "Jauns" vai "Jauna versija") -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Datums</label>
                    <InputDate TValue="DateOnly?" @bind-Value="newVersionDate" class="form-control"
                               disabled="@(isEdit && !createNewVersion)" />
                    @if (isEdit && !createNewVersion)
                    {
                        <div style="font-size:.85em; opacity:.75;">AktÄ«vÄs versijas datumu nevar mainÄ«t. Ja vajag jaunu datumu â€” izveido jaunu versiju.</div>
                    }
                    @if (showValidation && ( !isEdit || createNewVersion ) && newVersionDate is null)
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligÄts lauks.</div>
                    }
                </div>

                <!-- KomentÄrs (neobligÄts) -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">KomentÄrs</label>
                    <SfTextArea @bind-Value="newVersionComment" Placeholder="KomentÄrs" Width="100%" Rows="3"></SfTextArea>
                </div>
            </div>
        </Content>

        <FooterTemplate>
            <div style="display:flex; gap:.5rem; justify-content:flex-end; padding:.25rem .75rem .75rem;">
                <button type="button" @onclick="SaveAsync" style="padding:.4rem .9rem;">SaglabÄt</button>
                <button type="button" @onclick="CloseDialog" style="padding:.4rem .9rem;">Atcelt</button>
            </div>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- === TEHNOLOÄ¢IJAS SOÄ»I dialogs === -->
<ProductStepsDialog
    @bind-Visible="isStepsDialogVisible"
    Steps="editingSteps"
    StepTypes="stepTypes"
    WorkCenters="workCenters"
    OnMoveUp="MoveUp"
    OnMoveDown="MoveDown"
    OnDelete="DeleteStepAsync"
    OnSetFinal="SetFinalStep">

<ChildContent>

<div class="steps-dialog-actions">
    <button type="button"
            class="action-btn action-btn-sm"
            title="PÄrvaldÄ«t tehnoloÄ£ijas soÄ¼u tipus"
            @onclick="OpenStepTypeDialogAsync">
        âš™ SoÄ¼u tipi
    </button>

    <button type="button"
            class="action-btn action-btn-sm"
            title="PÄrvaldÄ«t darba centrus"
            @onclick="OpenWorkCenterDialogAsync">
        ğŸ­ Darba centri
    </button>
</div>

</ChildContent>

<FooterContent>
  <div class="steps-footer">
    <button type="button"
        class="action-btn action-btn-sm"
        title="Pievieno jaunu tehnoloÄ£ijas soli Å¡ai detaÄ¼ai"
        @onclick="AddStep">
    + Pievienot soli
</button>

<button type="button"
        class="action-btn action-btn-sm action-btn-primary"
        title="SaglabÄt"
        @onclick="SaveStepsAsync">
    SaglabÄt
</button>

<button type="button"
        class="action-btn action-btn-sm"
        title="AizvÄ“rt logu"
        @onclick="CloseStepsDialog">
    AizvÄ“rt
</button>

  </div>

</FooterContent>

</ProductStepsDialog>

<!-- === labots lÄ«dz Å¡ai vietai === -->

  <SfDialog Width="520px"
          ShowCloseIcon="true"
          IsModal="true"
          ZIndex="10060"
          Header="SoÄ¼u tipu vÄrdnÄ«ca"
          @bind-Visible="isStepTypeDialogVisible">
  <DialogTemplates>
    <Content>
   <div class="manage-toolbar">
    <input class="manage-input-small"
           type="text"
           placeholder="Jauns nosaukums"
           @bind="newStepTypeName" />

    <button type="button"
            class="action-btn action-btn-sm"
            title="Pievienot jaunu soÄ¼a tipu"
            @onclick="AddStepTypeAsync">
        Pievienot
    </button>
</div>



      <table class="steps-table">

        <thead>
          <tr><th style="text-align:left;">Nosaukums</th><th style="text-align:left; width:120px;"></th></tr>
        </thead>
        <tbody>
         @foreach (var t in manageStepTypes)
{
    <tr style="border-bottom:1px solid #eee;">
        <td>
            @if (editStepTypeId == t.Id)
{
    <input class="manage-input-small"
           type="text"
           @bind="editStepTypeName" />
}
else
{
    @t.Name
}

        </td>
<td class="manage-actions">
    @if (editStepTypeId == t.Id)
    {
        <button type="button"
                class="action-btn action-btn-xs"
                title="SaglabÄt izmaiÅ†as"
                @onclick="SaveEditStepTypeAsync">
            SaglabÄt
        </button>

        <button type="button"
                class="action-btn action-btn-xs"
                title="Atcelt rediÄ£Ä“Å¡anu"
                @onclick="CancelEditStepType">
            Atcelt
        </button>
    }
    else
    {
        <button type="button"
                class="action-btn action-btn-xs"
                title="Labot soÄ¼a tipu"
                @onclick="() => BeginEditStepType(t.Id, t.Name)">
            Labot
        </button>

        @if (t.IsActive)
        {
            <button type="button"
                    class="icon-btn"
                    title="DzÄ“st soÄ¼a tipu"
                    aria-label="DzÄ“st soÄ¼a tipu"
                    @onclick="() => DeleteStepTypeAsync(t.Id)">
                ğŸ—‘
            </button>
        }
    }
</td>

    </tr>
}

        </tbody>
      </table>

      
    </Content>
  </DialogTemplates>
</SfDialog>

<SfDialog Width="520px"
          ShowCloseIcon="true"
          IsModal="true"
          ZIndex="10070"
          Header="Darba centri"
          @bind-Visible="isWorkCenterDialogVisible">
  <DialogTemplates>
    <Content>

  <div class="manage-toolbar">

    <input class="manage-input-small"
           type="text"
           placeholder="Jauns nosaukums"
           @bind="newWorkCenterName" />

    <button type="button"
            class="action-btn action-btn-sm"
            title="Pievienot darba centru"
            @onclick="AddWorkCenterAsync">
      Pievienot
    </button>
  </div>

  <table class="manage-table">
    <thead>
      <tr>
        <th>Nosaukums</th>
        <th style="width:120px;"></th>
      </tr>
    </thead>
    <tbody>
      @foreach (var it in manageWorkCenters)
      {
        <tr>
          <td>
            @if (editWorkCenterId == it.Id)
            {
              <input class="manage-input-small"
                     type="text"
                     @bind="editWorkCenterName" />
            }
            else
            {
              @it.WorkCentr_Name
            }
          </td>

          <td class="manage-actions">
            @if (editWorkCenterId == it.Id)
            {
              <button type="button"
                      class="action-btn action-btn-xs"
                      title="SaglabÄt"
                      @onclick="SaveEditWorkCenterAsync">
                SaglabÄt
              </button>

              <button type="button"
                      class="action-btn action-btn-xs"
                      title="Atcelt"
                      @onclick="CancelEditWorkCenter">
                Atcelt
              </button>
            }
            else
            {
              <button type="button"
                      class="action-btn action-btn-xs"
                      title="Labot darba centru"
                      @onclick="() => BeginEditWorkCenter(it.Id, it.WorkCentr_Name)">
                Labot
              </button>

              @if (it.IsActive)
              {
                <button type="button"
                        class="icon-btn"
                        title="DzÄ“st darba centru"
                        aria-label="DzÄ“st darba centru"
                        @onclick="() => DeleteWorkCenterAsync(it.Id)">
                  ğŸ—‘
                </button>
              }
            }
          </td>
        </tr>
      }
    </tbody>
  </table>

</Content>

  </DialogTemplates>
</SfDialog>


<!-- === JAUNA DETAÄ»A dialogs === -->
<SfDialog
    Width="520px"
    ShowCloseIcon="true"
    IsModal="true"
    ZIndex="10060"
    CssClass="newPartDialog"
    @bind-Visible="isNewPartDialogVisible">

  <DialogTemplates>
    <Header>Jauna detaÄ¼a â€“ @SelectedProductLabel</Header>
    <Content>
  <div class="newpart-form">
    <label class="newpart-label newpart-label-strong">DetaÄ¼as veids</label>

    <div class="newpart-field">
      <SfDropDownList TValue="int?" TItem="TopPartDto"
                CssClass="newpart-ddl"
                DataSource="topParts"
                Placeholder="-- izvÄ“lies detaÄ¼u --"
                @bind-Value="newPart.TopPartId"
                AllowFiltering="true"
                Width="100%">
  <DropDownListFieldSettings Text="Display" Value="Id"></DropDownListFieldSettings>
</SfDropDownList>

    </div>

    <label class="newpart-label newpart-label-strong">Daudzums uz izstrÄdÄjumu</label>
    <div class="newpart-field">
      <SfNumericTextBox TValue="int"
      IncrementTitle="PalielinÄt"
    DecrementTitle="SamazinÄt"
                  CssClass="newpart-num"
                  @bind-Value="newPart.QtyPerProduct"
                  Min="1"
                  Step="1"
                  Width="140px">
</SfNumericTextBox>


    </div>
  </div>
</Content>

   <FooterTemplate>
  <div class="newpart-footer">
    <button type="button"
            @onclick="SaveNewPart"
            disabled="@NewPartInvalid"
            class="action-btn action-btn-sm action-btn-primary">
      SaglabÄt
    </button>

    <button type="button"
            @onclick="CloseNewPartDialog"
            class="action-btn action-btn-sm">
      AizvÄ“rt
    </button>
  </div>
</FooterTemplate>

  </DialogTemplates>
</SfDialog>


@code {
    // ===== PalÄ«g-Ä«paÅ¡Ä«bas izvÄ“lÄ“tajai PRECEI (no 'selected') =====
    private int? SelectedProductId => selected?.id;
    private string SelectedProductLabel =>
        selected is null ? string.Empty : $"{selected.productName} ({selected.productCode})";

    // ===== ModeÄ¼i (UI pusÄ“) =====
    

    public class CategoryDto
    {
        public int Id { get; set; }
        public string CategoryName { get; set; } = "";
        public int? ParentId { get; set; }
        public bool IsActive { get; set; }
    }
    // ===== StÄvoklis =====
    private List<ProductRow> allRows = new();
    private List<ProductRow> rows = new();
    private List<string> parentCategories = new();
    private string selectedRoot = "";
    private string selectedCategory = "";
    private string searchText = "";
    private int filterResetKey = 0;

    private ProductRow? selected;

    private ProductContentDto? selectedDetails;
    private bool loadingDetails = false;
    private HashSet<string> openParts = new();

    private bool isDialogVisible;

    // ReÅ¾Ä«mi dialogam
    bool isEdit = false;
    private bool _createNewVersion = false;

private bool createNewVersion
{
    get => _createNewVersion;
    set
    {
        _createNewVersion = value;

        // ja noÅ†em â€œIzveidot jaunu versijuâ€, tad automÄtiski noÅ†em arÄ« â€œKopÄ“t soÄ¼usâ€
        if (!_createNewVersion)
            copyTechnologySteps = false;
    }
}


    // --- Versijas lauki ---
    private string? newVersionName;
    private string? newVersionRasejums;
    private DateOnly? newVersionDate;
    private string? newVersionComment;

    private List<ProductDetailDto>? selectedPartDetails;
    private bool loadingPartDetails = false;

    private List<WorksByPartDto>? worksByParts;
    private bool loadingWorks = false;

    private List<WorkCenter> workCenters = new();

    // ===== Jaunas preces dialogs =====
    private List<CategoryDto> categories = new();
    private List<CategoryDto> parentOptions => categories.Where(c => c.ParentId == null && c.IsActive).OrderBy(c => c.CategoryName).ToList();
    private List<CategoryDto> childOptions  => categories.Where(c => c.ParentId == selectedParentId && c.IsActive).OrderBy(c => c.CategoryName).ToList();

    private int? selectedParentId;
    private int? selectedChildId;
    private string newName = "";
    private string newCode = "";
    private bool showValidation = false;

    // ===== PalÄ«g-funkcijas =====
    private void TogglePart(string? code)
    {
        if (string.IsNullOrWhiteSpace(code)) return;
        if (!openParts.Add(code))
            openParts.Remove(code);
        StateHasChanged();
    }

    // ===== Datu ielÄde =====
    protected override async Task OnInitializedAsync()
{
    try
    {
        // 1) ielÄdÄ“ preces sarakstu (minimÄli nepiecieÅ¡amais)
        rows = await Http.GetFromJsonAsync<List<ProductRow>>("http://localhost:5270/api/products/list") 
               ?? new();
        allRows = new List<ProductRow>(rows);

        // 2) ielÄdÄ“ darba centrus (ja 404/500 â€” turpinÄm bez tiem)
        try
        {
            workCenters = await Http.GetFromJsonAsync<List<WorkCenter>>("http://localhost:5270/api/workcenters")
                          ?? new();
        }
        catch { workCenters = new List<WorkCenter>(); }

            // 2b) ielÄdÄ“ soÄ¼u tipus (ja 404/500 â€” turpinÄm bez tiem)
try
{
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes")
               ?? new();
}
catch { stepTypes = new List<StepTypeDto>(); }


        // 3) ielÄdÄ“ kategorijas (ja 404/500 â€” turpinÄm bez tÄm)
        try
        {
            categories = await Http.GetFromJsonAsync<List<CategoryDto>>("http://localhost:5270/api/categories")
                         ?? new();
        }
        catch { categories = new List<CategoryDto>(); }

        // 4) ielÄdÄ“ detaÄ¼u (TopPart) izvÄ“lnei (ja 404/500 â€” turpinÄm bez tÄs)
        try
        {
            topParts = await Http.GetFromJsonAsync<List<TopPartDto>>("http://localhost:5270/api/topparts")
                       ?? new();
        }
        catch { topParts = new List<TopPartDto>(); }

        // 5) atjauno filtru skatu
        parentCategories = rows
            .Select(r => r.categoryName)
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .Distinct()
            .ToList();

        ApplyFilters(); // lokÄla filtrÄ“Å¡ana; neuzsÄk jaunus HTTP
    }
    catch (Exception ex)
    {
        // nepieÄ¼aujam â€œmÅ«Å¾Ä«gu Loadingâ€
        Console.WriteLine("OnInitializedAsync error: " + ex);
        await JS.InvokeVoidAsync("alert", "KÄ¼Å«da ielÄdÄ“jot datus: " + ex.Message);
        rows = new(); allRows = new(); // Ä¼aujam lapai atvÄ“rties tukÅ¡ai
    }
}
 

    private IEnumerable<string> filteredCategories =>
        string.IsNullOrWhiteSpace(selectedRoot)
            ? allRows.Select(r => r.categoryName).Where(n => !string.IsNullOrWhiteSpace(n)).Distinct()
            : allRows.Where(r =>
                {
                    var stem = selectedRoot.Length > 1 ? selectedRoot[..^1] : selectedRoot;
                    return (r.rootName ?? "").StartsWith(stem, StringComparison.OrdinalIgnoreCase);
                })
                .Select(r => r.categoryName)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct();

    private void OnCategoryFilterChanged(ChangeEventArgs e)
    {
        selectedCategory = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        IEnumerable<ProductRow> q = allRows;

        if (!string.IsNullOrWhiteSpace(selectedRoot))
        {
            var stem = selectedRoot.Length > 1 ? selectedRoot[..^1] : selectedRoot;
            q = q.Where(r => (r.rootName ?? "").StartsWith(stem, StringComparison.OrdinalIgnoreCase));
        }
        if (!string.IsNullOrWhiteSpace(selectedCategory))
            q = q.Where(r => r.categoryName?.Equals(selectedCategory, StringComparison.OrdinalIgnoreCase) == true);

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var term = searchText.Trim();
            q = q.Where(r =>
                (r.productName?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (r.productCode?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (r.categoryName?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false));
        }
        rows = q.ToList();
    }

    private void ClearFilters()
    {
        selectedRoot = "";
        selectedCategory = "";
        searchText = "";
        filterResetKey++;
        ApplyFilters();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    // ===== Preces dialogs =====
    private void OpenDialog()
    {
        isEdit = false;
        createNewVersion = false;

        selectedParentId = null;
        selectedChildId  = null;
        newName = "";
        newCode = "";
        showValidation = false;

        newVersionName = null;
        newVersionRasejums = null;
        newVersionDate = null;
        newVersionComment = null;

        isDialogVisible = true;
    }

    

    private void OpenEditDialog()
{
    if (selected is null || selectedDetails is null) return;

    isEdit = true;
    createNewVersion = false;
    copyTechnologySteps = false;   // âœ… Å O TU PIEVIENO

    selectedChildId = categories
        .FirstOrDefault(c => c.CategoryName.Equals(selected.categoryName ?? "", StringComparison.OrdinalIgnoreCase))?.Id;

    selectedParentId = (selectedChildId is int childId)
        ? categories.FirstOrDefault(c => c.Id == childId)?.ParentId
        : null;

    newName = selected.productName ?? "";
    newCode = selected.productCode ?? "";

    newVersionName     = selectedDetails.VersionName ?? "";
    newVersionRasejums = selectedDetails.VersionRasejums ?? "";
    newVersionComment  = selectedDetails.VersionComment ?? "";
    newVersionDate     = selectedDetails.VersionDate;

    showValidation = false;
    isDialogVisible = true;
}

private void CloseDialog()
{
    isDialogVisible = false;
    isEdit = false;
    createNewVersion = false;
    copyTechnologySteps = false; // âœ… PIEVIENO Å O
}


    private async Task SaveAsync()
    {
        showValidation = true;

        var isCreate = !isEdit;

        if (isCreate)
        {
            if (selectedParentId is null || selectedChildId is null ||
                string.IsNullOrWhiteSpace(newName) || string.IsNullOrWhiteSpace(newCode))
                return;
        }
        else
        {
            if (selectedChildId is null ||
                string.IsNullOrWhiteSpace(newName) || string.IsNullOrWhiteSpace(newCode))
                return;
        }

        if ((isCreate || createNewVersion) &&
            (string.IsNullOrWhiteSpace(newVersionName) || newVersionDate is null))
            return;

        try
        {
            if (isCreate)
            {
                var payload = new
                {
                    productName = newName,
                    productCode = newCode,
                    categoryId  = selectedChildId!.Value,
                    versionName     = newVersionName,
                    versionRasejums = newVersionRasejums,
                    versionDate     = newVersionDate?.ToString("yyyy-MM-dd"),
                    versionComment  = newVersionComment
                };

                var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/products/create", payload);
                resp.EnsureSuccessStatusCode();
            }
            else
            {
                var payload = new
{
    productId   = selected!.id,
    productName = newName,
    productCode = newCode,
    categoryId  = selectedChildId!.Value,

    versionId = selectedDetails?.VersionId,
    versionName     = newVersionName,
    versionRasejums = newVersionRasejums,
    versionDate     = newVersionDate?.ToString("yyyy-MM-dd"),
    versionComment  = newVersionComment,

    createNewVersion = createNewVersion,
    copyTechnologySteps = createNewVersion && copyTechnologySteps
};


                var resp = await Http.PutAsJsonAsync("http://localhost:5270/api/products/update", payload);
                resp.EnsureSuccessStatusCode();
            }

            rows = await Http.GetFromJsonAsync<List<ProductRow>>("http://localhost:5270/api/products/list") ?? new();
            allRows = new List<ProductRow>(rows);

            if (selected is not null)
            {
                await OnRowClicked(selected);
            }

            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Save error: " + ex.Message);
        }
    }

    // ===== Rindu atlase kreisajÄ gridÄ =====
    private async Task Grid_RowSelected(RowSelectEventArgs<ProductRow> args)
    {
        if (args?.Data is not null)
            await OnRowClicked(args.Data);
    }

private async Task LoadActiveWorkCentersAsync()
{
    workCenters = await Http.GetFromJsonAsync<List<WorkCenter>>(
        "http://localhost:5270/api/workcenters") ?? new();
}

    private async Task DeletePartAsync(int productToPartId)
{
    var yes = await JS.InvokeAsync<bool>("confirm", "Vai tieÅ¡Äm vÄ“lies dzÄ“st Å¡o detaÄ¼u?");
    if (!yes) return;

    var resp = await Http.DeleteAsync($"http://localhost:5270/api/products/delete-part/{productToPartId}");
    if (!resp.IsSuccessStatusCode)
    {
        var b = await resp.Content.ReadAsStringAsync();
        await JS.InvokeVoidAsync("alert", $"DzÄ“Å¡ana neizdevÄs: {b}");
        return;
    }

    // atjauno sarakstu
    selectedPartDetails = await Http.GetFromJsonAsync<List<ProductDetailDto>>(
        $"http://localhost:5270/api/products/details-by-product?id={selected!.id}");
    worksByParts = await Http.GetFromJsonAsync<List<WorksByPartDto>>(
        $"http://localhost:5270/api/products/works-by-product?id={selected!.id}");

    openParts.Clear(); // âœ… aizver visus atvÄ“rtos pÄ“c soÄ¼u saglabÄÅ¡anas/dzÄ“Å¡anas
StateHasChanged();

}

    private async Task OnRowClicked(ProductRow row)
    {
        selected = row;

        openParts.Clear();

        selectedDetails = null;
        selectedPartDetails = null;
        worksByParts = null;

        loadingDetails = true;
        loadingPartDetails = true;
        loadingWorks = true;

        try
        {
            selectedDetails = await Http.GetFromJsonAsync<ProductContentDto>(
                $"http://localhost:5270/api/products/content?id={row.id}");

            selectedPartDetails = await Http.GetFromJsonAsync<List<ProductDetailDto>>(
                $"http://localhost:5270/api/products/details-by-product?id={row.id}");

            worksByParts = await Http.GetFromJsonAsync<List<WorksByPartDto>>(
                $"http://localhost:5270/api/products/works-by-product?id={row.id}");
        }
        finally
        {
            loadingDetails = false;
            loadingPartDetails = false;
            loadingWorks = false;
            StateHasChanged();
        }
    }

    private async Task SoftDeleteSelected()
    {
        if (selected is null) return;

        var yes = await JS.InvokeAsync<bool>("confirm",
            $"Vai tieÅ¡Äm vÄ“lies dzÄ“st preci '{selected.productName}'?");

        if (!yes) return;

        try
        {
            var resp = await Http.DeleteAsync($"http://localhost:5270/api/products/delete?id={selected.id}");
            resp.EnsureSuccessStatusCode();

            rows = await Http.GetFromJsonAsync<List<ProductRow>>("http://localhost:5270/api/products/list") ?? new();
            allRows = new List<ProductRow>(rows);

            selected = null;
            selectedDetails = null;
            selectedPartDetails = null;
            worksByParts = null;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Delete error: " + ex.Message);
        }
    }

    // ===== SoÄ¼i (dialogs) =====
    private bool isStepsDialogVisible = false;
    private List<ManaApp.Models.PartStepDto> editingSteps = new();

    private string? stepsError;

    private bool HasInvalidSteps =>
    editingSteps == null || editingSteps.Any(s =>
        string.IsNullOrWhiteSpace(s.StepName)
        || s.StepType <= 0
        || s.WorkCentrId <= 0);

    private int currentStepsPartId;

    private async Task<List<ManaApp.Models.PartStepDto>> LoadStepsAsync(int productToPartId)
    {
        var url = $"http://localhost:5270/api/products/steps-by-part?productToPartId={productToPartId}";
        return await Http.GetFromJsonAsync<List<ManaApp.Models.PartStepDto>>(url) ?? new();
    }

    private async Task OpenStepsForPart(string? topPartCode)
    {
        stepsError = null;
        
        if (string.IsNullOrWhiteSpace(topPartCode) || selectedPartDetails is null) return;

        var detail = selectedPartDetails.FirstOrDefault(x => x.TopPartCode == topPartCode);
        if (detail is null) return;

        currentStepsPartId = detail.ProductToPartId;
editingSteps = await LoadStepsAsync(detail.ProductToPartId);

// ielÄdÄ“ dropdown avotus katru reizi atverot
await LoadActiveWorkCentersAsync();
await LoadActiveStepTypesAsync();

isStepsDialogVisible = true;
StateHasChanged();

        StateHasChanged();
    }

private async Task CloseStepsDialog()
{
    stepsError = null;
    
    isStepsDialogVisible = false;

    // PÄ“c soÄ¼u rediÄ£Ä“Å¡anas/dzÄ“Å¡anas atsvaidzini labo pusi (â€œTehnoloÄ£ijaâ€ sarakstu)
    if (selected is not null)
    {
        selectedPartDetails = await Http.GetFromJsonAsync<List<ProductDetailDto>>(
            $"http://localhost:5270/api/products/details-by-product?id={selected.id}") ?? new();

        worksByParts = await Http.GetFromJsonAsync<List<WorksByPartDto>>(
            $"http://localhost:5270/api/products/works-by-product?id={selected.id}") ?? new();
    }

    StateHasChanged();
}

    private void AddStep()
    {
        if (currentStepsPartId == 0) return;
        editingSteps ??= new();

        var nextOrder = editingSteps.Count > 0 ? editingSteps.Max(x => x.StepOrder) + 1 : 1;

        // paÅ†em noklusÄ“tos no ielÄdÄ“tajiem sarakstiem (ja ir)
var defaultStepTypeId = stepTypes?.FirstOrDefault()?.Id ?? 0;
var defaultWcId       = workCenters?.FirstOrDefault()?.Id ?? 0;

editingSteps.Add(new ManaApp.Models.PartStepDto
{
    Id = 0,
    ProductToPartId = currentStepsPartId,
    StepOrder = nextOrder,
    StepName = "",
    StepType = defaultStepTypeId, // â† vairs nav 0
    WorkCentrId = defaultWcId,    // â† vairs nav 0
    ParallelGroup = 0,
    IsMandatory = false,
    IsFinal = false,
    Comments = ""
});

    }

    private void MoveUp(PartStepDto s)
    {
        var idx = editingSteps.IndexOf(s);
        if (idx <= 0) return;
        (editingSteps[idx - 1], editingSteps[idx]) = (editingSteps[idx], editingSteps[idx - 1]);
        RecalcOrders();
    }

    private void MoveDown(PartStepDto s)
    {
        var idx = editingSteps.IndexOf(s);
        if (idx < 0 || idx >= editingSteps.Count - 1) return;
        (editingSteps[idx + 1], editingSteps[idx]) = (editingSteps[idx], editingSteps[idx + 1]);
        RecalcOrders();
    }

private void RecalcOrders()
{
    for (int i = 0; i < editingSteps.Count; i++)
    {
        editingSteps[i].StepOrder = (i + 1) * 10;
    }

    // â— NEUZSPIEÅ½AM Final automÄtiski
    // Final ir lietotÄja atbildÄ«ba

    StateHasChanged();
}


    private async Task DeleteStepAsync(PartStepDto s)
    {
        var yes = await JS.InvokeAsync<bool>("confirm", $"DzÄ“st soli â€œ{s.StepName}â€?");
        if (!yes) return;

        if (s.Id == 0)
        {
            editingSteps.Remove(s);
            RecalcOrders();
            return;
        }

        var resp = await Http.DeleteAsync($"http://localhost:5270/api/products/step/{s.Id}");
        if (resp.IsSuccessStatusCode)
        {
            editingSteps.Remove(s);
            RecalcOrders();
        }
        else
        {
            var body = await resp.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"DzÄ“Å¡ana neizdevÄs: {body}");
        }
    }

    private bool ValidateFinalRule()
    {
        if (editingSteps is null || editingSteps.Count == 0) return false;

        var finals = editingSteps.Where(s => s.IsFinal).ToList();
        if (finals.Count != 1) return false;

        var final = finals[0];
        var maxOrder = editingSteps.Max(s => s.StepOrder);
        return final.StepOrder == maxOrder;
    }

    private async Task SaveStepsAsync()
    {
        // === GUARD: pÄrbaude pirms saglabÄÅ¡anas ===
var invalid = editingSteps
    .Select((s, i) => new { s, i })
    .FirstOrDefault(x => string.IsNullOrWhiteSpace(x.s.StepName)
                      || x.s.StepType <= 0
                      || x.s.WorkCentrId <= 0);

if (invalid != null)
{
    var field = string.IsNullOrWhiteSpace(invalid.s.StepName) ? "nosaukums"
             : (invalid.s.StepType <= 0 ? "soÄ¼a tips"
             : "darba centrs");

    stepsError = $"Izlabo soli #{invalid.i + 1}: nav aizpildÄ«ts {field}.";
StateHasChanged();
return;

}
// === /GUARD ===

        RecalcOrders();

        if (!ValidateFinalRule())
        {
            await JS.InvokeVoidAsync("alert",
                "Noteikums: jÄbÅ«t TIEÅ I vienam 'Final' un tam jÄbÅ«t pÄ“dÄ“jam solim. LÅ«dzu izlabo pirms saglabÄÅ¡anas.");
            return;
        }

        int tmpOrder = 1000;
        foreach (var step in editingSteps.Where(s => s.Id > 0))
        {
            var prePayload = new
            {
                Id = step.Id,
                StepOrder = tmpOrder,
                StepName = step.StepName,
                StepType = step.StepType > 0 ? step.StepType : 1,
                WorkCentrId = step.WorkCentrId,
                ParallelGroup = step.IsParallel ? 1 : 0,
                IsMandatory = step.IsMandatory,
                IsFinal = step.IsFinal,
                Comments = step.Comments
            };
            tmpOrder += 10;

            var preResp = await Http.PutAsJsonAsync("http://localhost:5270/api/products/step", prePayload);
            if (!preResp.IsSuccessStatusCode)
            {
                var b = await preResp.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Pre-PUT kÄ¼Å«da: {b}");
                return;
            }
        }

        RecalcOrders();

        foreach (var step in editingSteps.Where(s => s.Id == 0))
        {
            var payload = new
            {
                ProductToPartId = step.ProductToPartId,
                StepOrder = step.StepOrder,
                StepName = step.StepName,
                StepType = step.StepType > 0 ? step.StepType : 1,
                WorkCentrId = step.WorkCentrId,
                ParallelGroup = step.IsParallel ? 1 : 0,
                IsMandatory = step.IsMandatory,
                IsFinal = step.IsFinal,
                Comments = step.Comments
            };

            var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/products/step", payload);
            if (!resp.IsSuccessStatusCode)
            {
                var b = await resp.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"POST kÄ¼Å«da: {b}");
                return;
            }
        }

        foreach (var step in editingSteps.Where(s => s.Id > 0))
        {
            var payload = new
            {
                Id = step.Id,
                StepOrder = step.StepOrder,
                StepName = step.StepName,
                StepType = step.StepType > 0 ? step.StepType : 1,
                WorkCentrId = step.WorkCentrId,
                ParallelGroup = step.IsParallel ? 1 : 0,
                IsMandatory = step.IsMandatory,
                IsFinal = step.IsFinal,
                Comments = step.Comments
            };

            var resp = await Http.PutAsJsonAsync("http://localhost:5270/api/products/step", payload);
            if (!resp.IsSuccessStatusCode)
            {
                var b = await resp.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"PUT kÄ¼Å«da: {b}");
                return;
            }
        }

await CloseStepsDialog();
    }

    // ===== Jaunas detaÄ¼as dialogs =====
    private bool isNewPartDialogVisible = false;

private class NewPartVm
{
    public int? TopPartId { get; set; }
    public int QtyPerProduct { get; set; } = 1;
}

    private NewPartVm newPart = new();
    private List<PartStepDto> newPartSteps = new();

    

    private void CloseNewPartDialog() => isNewPartDialogVisible = false;

private async Task SaveNewPart()
{
    if (selectedDetails is null || newPart is null || newPart.TopPartId is null) return;

    
 var payload = new
{
    productId     = selected!.id,              // â† API gaida productId
    topPartId     = newPart.TopPartId!.Value,  // â† API gaida topPartId
    qtyPerProduct = newPart.QtyPerProduct      // â† API gaida qtyPerProduct (>=1)
};

    var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/products/add-part", payload);
    if (!resp.IsSuccessStatusCode)
    {
        var b = await resp.Content.ReadAsStringAsync();
        await JS.InvokeVoidAsync("alert", $"NeizdevÄs saglabÄt detaÄ¼u: {b}");
        return;
    }

    // atjauno sarakstus (gan detaÄ¼as, gan â€œTehnoloÄ£ijuâ€)
selectedPartDetails = await Http.GetFromJsonAsync<List<ProductDetailDto>>(
    $"http://localhost:5270/api/products/details-by-product?id={selected!.id}") ?? new();

worksByParts = await Http.GetFromJsonAsync<List<WorksByPartDto>>(
    $"http://localhost:5270/api/products/works-by-product?id={selected!.id}") ?? new();

isNewPartDialogVisible = false;

openParts.Clear(); // âœ… aizver visus atvÄ“rtos pÄ“c soÄ¼u saglabÄÅ¡anas/dzÄ“Å¡anas
StateHasChanged();
}



    private class TopPartDto
{
    public int Id { get; set; }
    public string TopPartName { get; set; } = "";
    public string TopPartCode { get; set; } = "";
    public string Display => $"{TopPartCode} â€” {TopPartName}";
}

private List<TopPartDto> topParts = new();

private async Task DeletePartByCode(string? topPartCode)
{
    if (string.IsNullOrWhiteSpace(topPartCode))
        return;

    var detail = selectedPartDetails?.FirstOrDefault(x => x.TopPartCode == topPartCode);
    if (detail is null)
    {
        await JS.InvokeVoidAsync("alert", "Neatradu Å¡ai detaÄ¼ai ProductToPartId.");
        return;
    }

    await DeletePartAsync(detail.ProductToPartId);
}

private List<StepTypeDto> stepTypes = new();

// pÄrvaldÄ«bas dialogs
private bool isStepTypeDialogVisible = false;

private string newStepTypeName = "";

private class StepTypeRow
{
    public int Id { get; set; }
    public string Name { get; set; } = "";
    public bool IsActive { get; set; }
}
private List<StepTypeRow> manageStepTypes = new();

private int? editStepTypeId = null;
private string editStepTypeName = "";

private async Task OpenStepTypeDialogAsync()
{
    // dropdowns (aktÄ«vie)
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes") ?? new();

    // pÄrvaldÄ«bai â€“ ielÄdÄ“jam un atfiltrÄ“jam tikai aktÄ«vos
    var manage = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes/manage") ?? new();
    manageStepTypes = manage
        .Where(x => x.IsActive)
        .OrderBy(x => x.StepTypeName)
        .Select(x => new StepTypeRow { Id = x.Id, Name = x.StepTypeName, IsActive = x.IsActive })
        .ToList();

    // notÄ«rÄm jebkuru iepriekÅ¡Ä“jo rediÄ£Ä“Å¡anas stÄvokli
    editStepTypeId = null;
    editStepTypeName = "";

    isStepTypeDialogVisible = true;
    StateHasChanged();
}

private async Task RefreshStepTypesAsync()
{
    // dropdownam
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes") ?? new();

    // pÄrvaldÄ«bai (tikai aktÄ«vie)
    var manage = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes/manage") ?? new();
    manageStepTypes = manage
        .Where(x => x.IsActive)
        .OrderBy(x => x.StepTypeName)
        .Select(x => new StepTypeRow { Id = x.Id, Name = x.StepTypeName, IsActive = x.IsActive })
        .ToList();
}


// CRUD darbÄ«bas pÄrvaldÄ«bas dialogÄ
private async Task AddStepTypeAsync()
{
    var name = (newStepTypeName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(name)) { await JS.InvokeVoidAsync("alert","Ievadi nosaukumu."); return; }
    var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/steptypes", new { Name = name });
    if (!resp.IsSuccessStatusCode) { await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync()); return; }
    newStepTypeName = "";
    await OpenStepTypeDialogAsync(); // refreÅ¡s
    // refreÅ¡o dropdown datus
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes") ?? new();
    StateHasChanged();
}

private void BeginEditStepType(int id, string current)
{
    editStepTypeId = id;
    editStepTypeName = current;
}

private void CancelEditStepType()
{
    editStepTypeId = null;
    editStepTypeName = "";
}

private async Task SaveEditStepTypeAsync()
{
    if (editStepTypeId is null) return;
    var name = (editStepTypeName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(name))
    {
        await JS.InvokeVoidAsync("alert", "Ievadi nosaukumu.");
        return;
    }

    var resp = await Http.PutAsJsonAsync("http://localhost:5270/api/steptypes",
        new { Id = editStepTypeId.Value, Name = name });

    if (!resp.IsSuccessStatusCode)
    {
        await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
        return;
    }

    editStepTypeId = null;
    editStepTypeName = "";
    await RefreshStepTypesAsync(); // pÄrlÄdÄ“ gan pÄrvaldÄ«bas sarakstu, gan dropdown
}



private async Task DeleteStepTypeAsync(int id)
{
    var ok = await JS.InvokeAsync<bool>("confirm", "DzÄ“st soÄ¼a tipu? (soft delete)");
    if (!ok) return;
    var resp = await Http.DeleteAsync($"http://localhost:5270/api/steptypes/{id}");
    if (!resp.IsSuccessStatusCode) { await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync()); return; }
    await OpenStepTypeDialogAsync();
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes") ?? new();
    StateHasChanged();
}

// dropdown atsvaidzinÄÅ¡anai

private bool isWorkCenterDialogVisible = false;
private List<WorkCenterManageDto> manageWorkCenters = new();

private class WorkCenterManageDto
{
    public int Id { get; set; }
    public string WorkCentr_Name { get; set; } = "";
    public bool IsActive { get; set; }
}

private async Task OpenWorkCenterDialogAsync()
{
    manageWorkCenters = (await Http.GetFromJsonAsync<List<WorkCenterManageDto>>(
    "http://localhost:5270/api/workcenters/manage") ?? new())
    .Where(x => x.IsActive)                   // â† slÄ“pjam neaktÄ«vos
    .ToList();
isWorkCenterDialogVisible = true;
StateHasChanged();

}

private string newWorkCenterName = "";
private int? editWorkCenterId = null;
private string editWorkCenterName = "";

private async Task RefreshWorkCentersAsync()
{
    manageWorkCenters = (await Http.GetFromJsonAsync<List<WorkCenterManageDto>>(
    "http://localhost:5270/api/workcenters/manage") ?? new())
    .Where(x => x.IsActive)                   // â† slÄ“pjam neaktÄ«vos
    .ToList();

}

private async Task AddWorkCenterAsync()
{
    var name = (newWorkCenterName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(name)) { await JS.InvokeVoidAsync("alert","Ievadi nosaukumu."); return; }

// Ä£enerÄ“jam kodu (bez atstarpÄ“m, lielie burti; ja gribi citu formÄtu â€” pasaki)
var code = (name ?? "").Trim().ToUpper().Replace(" ", "_");

var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/workcenters/add",
    new { WorkCentr_Name = name, WorkCentr_Code = code });
    

    if (!resp.IsSuccessStatusCode)
    {
        await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
        return;
    }
    newWorkCenterName = "";
    await RefreshWorkCentersAsync();
    await LoadActiveWorkCentersAsync();

}

private void BeginEditWorkCenter(int id, string current)
{
    editWorkCenterId = id; editWorkCenterName = current;
}

private void CancelEditWorkCenter()
{
    editWorkCenterId = null; editWorkCenterName = "";
}

private async Task SaveEditWorkCenterAsync()
{
    if (editWorkCenterId is null) return;
    var name = (editWorkCenterName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(name)) { await JS.InvokeVoidAsync("alert","Ievadi nosaukumu."); return; }

    // Ä£enerÄ“jam kodu no nosaukuma (bez atstarpÄ“m, lielie burti)
var code = (name ?? "").Trim().ToUpper().Replace(" ", "_");

var resp = await Http.PutAsJsonAsync("http://localhost:5270/api/workcenters/update",
    new { Id = editWorkCenterId!.Value, WorkCentr_Name = name, WorkCentr_Code = code });


    if (!resp.IsSuccessStatusCode)
    {
        await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
        return;
    }
    editWorkCenterId = null; editWorkCenterName = "";
    await RefreshWorkCentersAsync();
    await LoadActiveWorkCentersAsync();

}

private async Task DeleteWorkCenterAsync(int id)
{
    var ok = await JS.InvokeAsync<bool>("confirm", "DzÄ“st darba centru? (soft delete)");
    if (!ok) return;

    var resp = await Http.DeleteAsync($"http://localhost:5270/api/workcenters/{id}");
    if (!resp.IsSuccessStatusCode)
    {
        await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
        return;
    }
    await RefreshWorkCentersAsync();
    await LoadActiveWorkCentersAsync();

}

private bool NewPartExistsAlready
{
    get
    {
        if (newPart?.TopPartId is not int id) return false;
        var sel = topParts.FirstOrDefault(t => t.Id == id);
        return sel != null && (selectedPartDetails?.Any(d => d.TopPartCode == sel.TopPartCode) ?? false);
    }
}

private bool NewPartInvalid =>
    newPart is null
    || newPart.TopPartId is null
    || newPart.QtyPerProduct < 1
    || NewPartExistsAlready;

private void SetRootFilter(string value)
{
    selectedRoot = value ?? "";
    ApplyFilters();
}

private bool HasAnyFilters =>
    !string.IsNullOrWhiteSpace(selectedRoot)
    || !string.IsNullOrWhiteSpace(selectedCategory)
    || !string.IsNullOrWhiteSpace(searchText);

private bool IsLastStep(PartStepDto s)
{
    if (editingSteps is null || editingSteps.Count == 0)
        return false;

    var maxOrder = editingSteps.Max(x => x.StepOrder);
    return s.StepOrder == maxOrder;
}

private void SetFinalStep(PartStepDto step)
{
    if (!IsLastStep(step))
        return;

    foreach (var s in editingSteps)
        s.IsFinal = false;

    step.IsFinal = true;

    StateHasChanged();
}

private async Task LoadActiveStepTypesAsync()
{
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>(
        "http://localhost:5270/api/steptypes") ?? new();
}
private bool copyTechnologySteps = false;

private void OpenNewPartDialog()
{
    newPart = new NewPartVm { TopPartId = null, QtyPerProduct = 1 };
    newPartSteps = new List<ManaApp.Models.PartStepDto>();
    isNewPartDialogVisible = true;
}

}
