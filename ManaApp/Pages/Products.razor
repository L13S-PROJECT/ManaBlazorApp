@page "/products"
@using System.Net.Http.Json
@using System.Linq
@using ManaApp.Models
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using Microsoft.JSInterop
@using ManaApp.Shared
@inject HttpClient Http
@inject IJSRuntime JS
@layout MainLayout
@using ManaApp.Components.Products
@using ManaApp.Pages
       

<div class="products-main">

        <!-- vidƒìjƒÅ zona: pa kreisi saraksts, pa labi 3 bloki -->
    <div class="products-content">

            <!-- KREISƒÄ PUSE: filtri + grida saraksts -->
        <div class="products-main-block">

                <div class="products-section-header">
                    
                    <div class="products-header-title">
                        Preƒçu saraksts
                    </div>

                    <label class="archived-switch">
                        <input type="checkbox" @bind="ShowArchived" />
                        <span class="slider"></span>
                    </label>

                </div>

                <ProductsFilters
                    Categories="filteredCategories"
                    HasFilters="HasAnyFilters"
                    SelectedRoot="@selectedRoot"
                    OnRootChanged="SetRootFilter"
                    OnCategoryChanged="OnCategoryFilterChanged"
                    OnSearch="OnSearchInput"
                    OnClear="ClearFilters"
                    SearchText="@searchText"
                    SearchTextChanged="@(v => searchText = v)"
                    OnNew="OpenDialog"
                    OnEdit="OpenEditDialog"
                    OnDelete="SoftDeleteSelected"
                    CanEdit="@(selected is not null && selectedDetails is not null)"
                    CanDelete="@(selected is not null)">
                </ProductsFilters>

                        <ProductsGrid
                        Rows="rows"
                        OnRowSelected="Grid_RowSelected" />
        </div>



            <!-- LABƒÄ PUSE: Preces saturs + Tehnoloƒ£ija -->
    <div class="products-right">

                <ProductContentBox
                    Selected="selected"
                    Details="selectedDetails"
                    Loading="loadingDetails" />

            <!-- Tehnoloƒ£ija -->

<ProductTechnologyBox
    Selected="selected"
    LoadingPartDetails="loadingPartDetails"
    LoadingWorks="loadingWorks"
    SelectedPartDetails="selectedPartDetails"
    WorksByParts="worksByParts"
    AllTopParts="topParts"
    OnAddPart="OpenNewPartDialog"
    OnOpenSteps="OpenStepsForPart"
    OnOpenStepTypes="OpenStepTypeDialogAsync"
    OnOpenWorkCenters="OpenWorkCenterDialogAsync"
    OnDeletePart="DeletePartByCode"
    OnToggleTopPart="ToggleTopPartAsync">
</ProductTechnologyBox>

    </div>
</div>
</div>

<!-- === PRECES dialogs (JAUNS/LABOT) === -->
<SfDialog
    Width="620px"
    ShowCloseIcon="true"
    IsModal="true"
    ZIndex="10000"
    Header="@(isEdit ? "Labot preci" : "Jauna prece")"
    Visible="IsProductDialogOpen"
    VisibleChanged="@(v => SetMainDialog(v ? "Product" : null))">

    <DialogTemplates>
        <Content>
        
            <div style="display:grid; gap:.75rem; padding:.5rem;">
                <!-- VecƒÅkkategorija -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Kategorija (vecƒÅka)</label>
                    <SfDropDownList TValue="int?" TItem="CategoryDto"
                                    Placeholder="-- izvƒìlies vecƒÅk-kategoriju --"
                                    @bind-Value="selectedParentId"
                                    DataSource="parentOptions"
                                    AllowFiltering="true"
                                    FloatLabelType="FloatLabelType.Never"
                                    Width="100%"
                                    Enabled="@( !isEdit )">
                        <DropDownListFieldSettings Text="CategoryName" Value="Id"></DropDownListFieldSettings>
                    </SfDropDownList>
                    @if (showValidation && !isEdit && selectedParentId is null)
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligƒÅti jƒÅizvƒìlas.</div>
                    }
                </div>

                <!-- Bƒìrnkategorija -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Kategorija (bƒìrna)</label>
                    <SfDropDownList TValue="int?" TItem="CategoryDto"
                                    Placeholder="-- izvƒìlies bƒìrn-kategoriju --"
                                    @bind-Value="selectedChildId"
                                    DataSource="childOptions"
                                    Enabled="@(selectedParentId is not null && !isEdit)"
                                    AllowFiltering="true"
                                    Width="100%">
                        <DropDownListFieldSettings Text="CategoryName" Value="Id"></DropDownListFieldSettings>
                    </SfDropDownList>
                    @if (showValidation && selectedChildId is null)
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligƒÅti jƒÅizvƒìlas.</div>
                    }
                </div>

                <!-- Nosaukums -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Nosaukums</label>
                    <SfTextBox @bind-Value="newName" Placeholder="Preces nosaukums" Width="100%"></SfTextBox>
                    @if (showValidation && string.IsNullOrWhiteSpace(newName))
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligƒÅts lauks.</div>
                    }
                </div>

                <!-- Kods -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Kods</label>
                    <SfTextBox @bind-Value="newCode" Placeholder="Preces kods" Width="100%"></SfTextBox>
                    @if (showValidation && string.IsNullOrWhiteSpace(newCode))
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligƒÅts lauks.</div>
                    }
                </div>

@if (isEdit)
{
  <div class="form-check my-2" style="margin-top:.25rem;">
    <input class="form-check-input" type="checkbox" id="chkNewVersion" @bind="createNewVersion" />
    <label class="form-check-label" for="chkNewVersion">
      Izveidot jaunu versiju
    </label>
  </div>

  @if (createNewVersion)
  {
    <div class="form-check my-2" style="margin-left:1.25rem;">
      <input class="form-check-input"
             type="checkbox"
             id="chkCopySteps"
             @bind="copyTechnologySteps" />
      <label class="form-check-label" for="chkCopySteps">
        Kopƒìt tehnoloƒ£ijas soƒºus
      </label>
    </div>
  }
}


                <!-- Versija (obligƒÅts) -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Versija</label>
                    <SfTextBox @bind-Value="newVersionName"
                               Placeholder="Versijas nosaukums"
                               Width="100%"
                               Enabled="@( !(isEdit && !createNewVersion) )"></SfTextBox>
                    @if (isEdit && !createNewVersion)
                    {
                        <div style="font-size:.85em; opacity:.75;">Aktƒ´vƒÅs versijas nosaukumu nevar mainƒ´t. Atzƒ´mƒì ‚ÄúIzveidot jaunu versiju‚Äù, lai ievadƒ´tu jaunu.</div>
                    }
                    @if (showValidation && ( !isEdit || createNewVersion ) && string.IsNullOrWhiteSpace(newVersionName))
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligƒÅts lauks.</div>
                    }
                </div>

                <!-- Rasƒìjums (neobligƒÅts) -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Rasƒìjums</label>
                    <SfTextBox @bind-Value="newVersionRasejums" Placeholder="Rasƒìjuma identifikators/saite" Width="100%"></SfTextBox>
                </div>

                <!-- Datums (obligƒÅts "Jauns" vai "Jauna versija") -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">Datums</label>
                    <InputDate TValue="DateOnly?" @bind-Value="newVersionDate" class="form-control"
                               disabled="@(isEdit && !createNewVersion)" />
                    @if (isEdit && !createNewVersion)
                    {
                        <div style="font-size:.85em; opacity:.75;">Aktƒ´vƒÅs versijas datumu nevar mainƒ´t. Ja vajag jaunu datumu ‚Äî izveido jaunu versiju.</div>
                    }
                    @if (showValidation && ( !isEdit || createNewVersion ) && newVersionDate is null)
                    {
                        <div style="color:#b91c1c; font-size:.9em;">ObligƒÅts lauks.</div>
                    }
                </div>

                <!-- KomentƒÅrs (neobligƒÅts) -->
                <div>
                    <label style="font-weight:600; display:block; margin-bottom:.25rem;">KomentƒÅrs</label>
                    <SfTextArea @bind-Value="newVersionComment" Placeholder="KomentƒÅrs" Width="100%" Rows="3"></SfTextArea>
                </div>
            </div>
        </Content>

        <FooterTemplate>
            <div style="display:flex; gap:.5rem; justify-content:flex-end; padding:.25rem .75rem .75rem;">
                <button type="button" @onclick="SaveAsync" style="padding:.4rem .9rem;">SaglabƒÅt</button>
                <button type="button" @onclick="CloseDialog" style="padding:.4rem .9rem;">Atcelt</button>
            </div>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<!-- === TEHNOLOƒ¢IJAS SOƒªI dialogs === -->
<ProductStepsDialog
    Visible="IsStepsOpen"
    VisibleChanged="@(v => SetMainDialog(v ? "Steps" : null))"
    Steps="editingSteps"
    StepTypes="stepTypes"
    WorkCenters="workCenters"
    OnMoveUp="MoveUp"
    OnMoveDown="MoveDown"
    OnDelete="DeleteStepAsync"
    OnSetFinal="SetFinalStep"
    OnOpenStepTypes="OpenStepTypeDialogAsync"
    OnOpenWorkCenters="OpenWorkCenterDialogAsync"
    OnAddStep="AddStep"
    OnSave="SaveStepsAsync"
    OnClose="CloseStepsDialog" />

<!-- === labots lƒ´dz ≈°ai vietai === -->

<StepTypesDialog
    Visible="isStepTypesOpen"
    VisibleChanged="@(v => isStepTypesOpen = v)"
    Items="manageStepTypes"
    NewName="@newStepTypeName"
    EditId="@editStepTypeId"
    @bind-EditName="editStepTypeName"
    OnAdd="AddStepTypeAsync"
    OnSaveEdit="SaveEditStepTypeAsync"
    OnCancelEdit="CancelEditStepType"
    OnBeginEdit="BeginEditStepType"
    OnDelete="DeleteStepTypeAsync">
</StepTypesDialog>

<WorkCentersDialog
    Visible="isWorkCentersOpen"
    VisibleChanged="@(v => isWorkCentersOpen = v)"
    Items="manageWorkCenters"
    NewName="@newWorkCenterName"
    EditId="editWorkCenterId"
    @bind-EditName="editWorkCenterName"
    OnAdd="AddWorkCenterAsync"
    OnSaveEdit="SaveEditWorkCenterAsync"
    OnCancelEdit="CancelEditWorkCenter"
    OnBeginEdit="BeginEditWorkCenter"
    OnDelete="DeleteWorkCenterAsync" >
</WorkCentersDialog>

<!-- === JAUNA DETAƒªA dialogs === -->

<NewPartDialog
    Visible="IsNewPartOpen"
    VisibleChanged="@(v => SetMainDialog(v ? "NewPart" : null))" />

@code {
    // ===== Palƒ´g-ƒ´pa≈°ƒ´bas izvƒìlƒìtajai PRECEI (no 'selected') =====
    private int? SelectedProductId => selected?.id;
    private string SelectedProductLabel =>
        selected is null ? string.Empty : $"{selected.productName} ({selected.productCode})";

    // ===== Modeƒºi (UI pusƒì) =====
    private string? activeMainDialog = null;

    private bool IsStepsOpen => activeMainDialog == "Steps";
    private bool IsNewPartOpen => activeMainDialog == "NewPart";

    private bool isStepTypesOpen = false;
    private bool isWorkCentersOpen = false;
    public class CategoryDto
    {
        public int Id { get; set; }
        public string CategoryName { get; set; } = "";
        public int? ParentId { get; set; }
        public bool IsActive { get; set; }
    }
    // ===== StƒÅvoklis =====
    private List<ProductRow> allRows = new();
    private List<ProductRow> rows = new();
    private List<string> parentCategories = new();
    private string selectedRoot = "";
    private string selectedCategory = "";
    private string searchText = "";
    private int filterResetKey = 0;

    private ProductRow? selected;

    private ProductContentDto? selectedDetails;
    private bool loadingDetails = false;
    private HashSet<string> openParts = new();

    // Re≈æƒ´mi dialogam
    bool isEdit = false;
    private bool _createNewVersion = false;

private bool createNewVersion
{
    get => _createNewVersion;
    set
    {
        _createNewVersion = value;

        // ja no≈Üem ‚ÄúIzveidot jaunu versiju‚Äù, tad automƒÅtiski no≈Üem arƒ´ ‚ÄúKopƒìt soƒºus‚Äù
        if (!_createNewVersion)
            copyTechnologySteps = false;
    }
}


    // --- Versijas lauki ---
    private string? newVersionName;
    private string? newVersionRasejums;
    private DateOnly? newVersionDate;
    private string? newVersionComment;

    private List<ProductDetailDto>? selectedPartDetails;
    private bool loadingPartDetails = false;

    private List<WorksByPartDto>? worksByParts;
    private bool loadingWorks = false;

    private List<WorkCenter> workCenters = new();

    // ===== Jaunas preces dialogs =====
    private List<CategoryDto> categories = new();
    private List<CategoryDto> parentOptions => categories.Where(c => c.ParentId == null && c.IsActive).OrderBy(c => c.CategoryName).ToList();
    private List<CategoryDto> childOptions  => categories.Where(c => c.ParentId == selectedParentId && c.IsActive).OrderBy(c => c.CategoryName).ToList();

    private int? selectedParentId;
    private int? selectedChildId;
    private string newName = "";
    private string newCode = "";
    private bool showValidation = false;
    private List<StageStepTypeMapDto> stageStepTypeMap = new();

    public class StageStepTypeMapDto
{
    public int Stage { get; set; }
    public int Step_Type_ID { get; set; }
    public bool IsActive { get; set; }
}

    // ===== Palƒ´g-funkcijas =====
    private void TogglePart(string? code)
    {
        if (string.IsNullOrWhiteSpace(code)) return;
        if (!openParts.Add(code))
            openParts.Remove(code);
        StateHasChanged();
    }

    // ===== Datu ielƒÅde =====
    protected override async Task OnInitializedAsync()
{
    try
    {
        // 1) ielƒÅdƒì preces sarakstu (minimƒÅli nepiecie≈°amais)
        rows = await Http.GetFromJsonAsync<List<ProductRow>>("http://localhost:5270/api/products/list") 
               ?? new();
        allRows = new List<ProductRow>(rows);

        // 2) ielƒÅdƒì darba centrus (ja 404/500 ‚Äî turpinƒÅm bez tiem)
        try
        {
            workCenters = await Http.GetFromJsonAsync<List<WorkCenter>>("http://localhost:5270/api/workcenters")
                          ?? new();
        }
        catch { workCenters = new List<WorkCenter>(); }

// 2b) ielƒÅdƒì soƒºu tipus
            try
            {
                stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>(
                    "http://localhost:5270/api/steptypes")
                    ?? new();
            }
            catch { stepTypes = new List<StepTypeDto>(); }

// 2c) ielƒÅdƒì stage ‚Üí stepType mapping
            try
            {
                stageStepTypeMap = await Http.GetFromJsonAsync<List<StageStepTypeMapDto>>(
                    "http://localhost:5270/api/products/stage-step-type-map")
                    ?? new();
            }
            catch { stageStepTypeMap = new List<StageStepTypeMapDto>(); }

        // 3) ielƒÅdƒì kategorijas (ja 404/500 ‚Äî turpinƒÅm bez tƒÅm)
        try
        {
            categories = await Http.GetFromJsonAsync<List<CategoryDto>>("http://localhost:5270/api/categories")
                         ?? new();
        }
        catch { categories = new List<CategoryDto>(); }

        // 4) ielƒÅdƒì detaƒºu (TopPart) izvƒìlnei (ja 404/500 ‚Äî turpinƒÅm bez tƒÅs)
        try
        {
            topParts = await Http.GetFromJsonAsync<List<TopPartDto>>("http://localhost:5270/api/topparts")
                       ?? new();
        }
        catch { topParts = new List<TopPartDto>(); }

        // 5) atjauno filtru skatu
        parentCategories = rows
            .Select(r => r.categoryName)
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .Distinct()
            .ToList();

        ApplyFilters(); // lokƒÅla filtrƒì≈°ana; neuzsƒÅk jaunus HTTP
    }
    catch (Exception ex)
    {
        // nepieƒºaujam ‚Äúm≈´≈æƒ´gu Loading‚Äù
        Console.WriteLine("OnInitializedAsync error: " + ex);
        await JS.InvokeVoidAsync("alert", "Kƒº≈´da ielƒÅdƒìjot datus: " + ex.Message);
        rows = new(); allRows = new(); // ƒºaujam lapai atvƒìrties tuk≈°ai
    }
}
 

    private IEnumerable<string> filteredCategories =>
        string.IsNullOrWhiteSpace(selectedRoot)
            ? allRows.Select(r => r.categoryName).Where(n => !string.IsNullOrWhiteSpace(n)).Distinct()
            : allRows.Where(r =>
                {
                    var stem = selectedRoot.Length > 1 ? selectedRoot[..^1] : selectedRoot;
                    return (r.rootName ?? "").StartsWith(stem, StringComparison.OrdinalIgnoreCase);
                })
                .Select(r => r.categoryName)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct();

    private void OnCategoryFilterChanged(ChangeEventArgs e)
    {
        selectedCategory = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        IEnumerable<ProductRow> q = allRows;

        if (!ShowArchived)
        {
            q = q.Where(r => r.IsActive && r.VersionIsActive);
        }

        if (!string.IsNullOrWhiteSpace(selectedRoot))
        {
            var stem = selectedRoot.Length > 1 ? selectedRoot[..^1] : selectedRoot;
            q = q.Where(r => (r.rootName ?? "").StartsWith(stem, StringComparison.OrdinalIgnoreCase));
        }
        if (!string.IsNullOrWhiteSpace(selectedCategory))
            q = q.Where(r => r.categoryName?.Equals(selectedCategory, StringComparison.OrdinalIgnoreCase) == true);

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var term = searchText.Trim();
            q = q.Where(r =>
                (r.productName?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (r.productCode?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (r.categoryName?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false));
        }
        rows = q.ToList();
    }

    private void ClearFilters()
    {
        selectedRoot = "";
        selectedCategory = "";
        searchText = "";
        filterResetKey++;
        ApplyFilters();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    // ===== Preces dialogs =====
    private void OpenDialog()
    {
        isEdit = false;
        createNewVersion = false;

        selectedParentId = null;
        selectedChildId  = null;
        newName = "";
        newCode = "";
        showValidation = false;

        newVersionName = null;
        newVersionRasejums = null;
        newVersionDate = null;
        newVersionComment = null;

        SetMainDialog("Product");
    }

    

    private void OpenEditDialog()
{
    if (selected is null || selectedDetails is null) return;

    isEdit = true;
    createNewVersion = false;
    copyTechnologySteps = false;   // ‚úÖ ≈†O TU PIEVIENO

    selectedChildId = categories
        .FirstOrDefault(c => c.CategoryName.Equals(selected.categoryName ?? "", StringComparison.OrdinalIgnoreCase))?.Id;

    selectedParentId = (selectedChildId is int childId)
        ? categories.FirstOrDefault(c => c.Id == childId)?.ParentId
        : null;

    newName = selected.productName ?? "";
    newCode = selected.productCode ?? "";

    newVersionName     = selectedDetails.VersionName ?? "";
    newVersionRasejums = selectedDetails.VersionRasejums ?? "";
    newVersionComment  = selectedDetails.VersionComment ?? "";
    newVersionDate     = selectedDetails.VersionDate;

    showValidation = false;
    SetMainDialog("Product");
}

private void CloseDialog()
{
    SetMainDialog(null);
    isEdit = false;
    createNewVersion = false;
    copyTechnologySteps = false; // ‚úÖ PIEVIENO ≈†O
}


    private async Task SaveAsync()
    {
        showValidation = true;

        var isCreate = !isEdit;

        if (isCreate)
        {
            if (selectedParentId is null || selectedChildId is null ||
                string.IsNullOrWhiteSpace(newName) || string.IsNullOrWhiteSpace(newCode))
                return;
        }
        else
        {
            if (selectedChildId is null ||
                string.IsNullOrWhiteSpace(newName) || string.IsNullOrWhiteSpace(newCode))
                return;
        }

        if ((isCreate || createNewVersion) &&
            (string.IsNullOrWhiteSpace(newVersionName) || newVersionDate is null))
            return;

        try
        {
            if (isCreate)
            {
                var payload = new
                {
                    productName = newName,
                    productCode = newCode,
                    categoryId  = selectedChildId!.Value,
                    versionName     = newVersionName,
                    versionRasejums = newVersionRasejums,
                    versionDate     = newVersionDate?.ToString("yyyy-MM-dd"),
                    versionComment  = newVersionComment
                };

                var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/products/create", payload);
                resp.EnsureSuccessStatusCode();
            }
            else
            {
                var payload = new
{
    productId   = selected!.id,
    productName = newName,
    productCode = newCode,
    categoryId  = selectedChildId!.Value,

    versionId = selectedDetails?.VersionId,
    versionName     = newVersionName,
    versionRasejums = newVersionRasejums,
    versionDate     = newVersionDate?.ToString("yyyy-MM-dd"),
    versionComment  = newVersionComment,

    createNewVersion = createNewVersion,
    copyTechnologySteps = createNewVersion && copyTechnologySteps
};


                var resp = await Http.PutAsJsonAsync("http://localhost:5270/api/products/update", payload);
                resp.EnsureSuccessStatusCode();
            }

            allRows = await Http.GetFromJsonAsync<List<ProductRow>>("http://localhost:5270/api/products/list") ?? new();
            ApplyFilters();

            if (selected is not null)
            {
                await OnRowClicked(selected);
            }

            CloseDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Save error: " + ex.Message);
        }
    }

    // ===== Rindu atlase kreisajƒÅ gridƒÅ =====
    private async Task Grid_RowSelected(RowSelectEventArgs<ProductRow> args)
    {
        if (args?.Data is not null)
            await OnRowClicked(args.Data);
    }

private async Task LoadActiveWorkCentersAsync()
{
    workCenters = await Http.GetFromJsonAsync<List<WorkCenter>>(
        "http://localhost:5270/api/workcenters") ?? new();
}

    private async Task DeletePartAsync(int productToPartId)
{
    var yes = await JS.InvokeAsync<bool>("confirm", "Vai tie≈°ƒÅm vƒìlies dzƒìst ≈°o detaƒºu?");
    if (!yes) return;

    var resp = await Http.DeleteAsync($"http://localhost:5270/api/products/delete-part/{productToPartId}");
    if (!resp.IsSuccessStatusCode)
    {
        var b = await resp.Content.ReadAsStringAsync();
        await JS.InvokeVoidAsync("alert", $"Dzƒì≈°ana neizdevƒÅs: {b}");
        return;
    }

    // atjauno sarakstu
    selectedPartDetails = await Http.GetFromJsonAsync<List<ProductDetailDto>>(
        $"http://localhost:5270/api/products/details-by-product?id={selected!.id}");
    worksByParts = await Http.GetFromJsonAsync<List<WorksByPartDto>>(
        $"http://localhost:5270/api/products/works-by-product?id={selected!.id}");
    
    StateHasChanged();
}

    private async Task OnRowClicked(ProductRow row)
{
if (row.VersionId == null || row.VersionId == 0)
{
    Console.WriteLine("VersionId is NULL!");
    return;
}

    selected = row;

    Console.WriteLine($"Clicked VersionId = {row.VersionId}");

    openParts.Clear();

    selectedDetails = null;
    selectedPartDetails = null;
    worksByParts = null;

    loadingDetails = true;
    loadingPartDetails = true;
    loadingWorks = true;

    try
    {
        selectedDetails = await Http.GetFromJsonAsync<ProductContentDto>(
            $"http://localhost:5270/api/products/content?versionId={row.VersionId}");

        selectedPartDetails = await Http.GetFromJsonAsync<List<ProductDetailDto>>(
    $"http://localhost:5270/api/products/details?versionId={row.VersionId}&stepType=1");

worksByParts = await Http.GetFromJsonAsync<List<WorksByPartDto>>(
    $"http://localhost:5270/api/products/works-by-version?versionId={row.VersionId}");
    }
    finally
    {
        loadingDetails = false;
        loadingPartDetails = false;
        loadingWorks = false;
        StateHasChanged();
    }
}

    private async Task SoftDeleteSelected()
    {
        if (selected is null) return;

        var yes = await JS.InvokeAsync<bool>("confirm",
            $"Vai tie≈°ƒÅm vƒìlies dzƒìst preci '{selected.productName}'?");

        if (!yes) return;

        try
        {
            var resp = await Http.DeleteAsync($"http://localhost:5270/api/products/delete?id={selected.id}");
            resp.EnsureSuccessStatusCode();

            rows = await Http.GetFromJsonAsync<List<ProductRow>>("http://localhost:5270/api/products/list") ?? new();
            allRows = new List<ProductRow>(rows);

            selected = null;
            selectedDetails = null;
            selectedPartDetails = null;
            worksByParts = null;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Delete error: " + ex.Message);
        }
    }

    // ===== Soƒºi (dialogs) =====
    private List<ManaApp.Models.PartStepDto> editingSteps = new();

    private string? stepsError;

    private bool HasInvalidSteps =>
    editingSteps == null || editingSteps.Any(s =>
        string.IsNullOrWhiteSpace(s.StepName)
        || s.StepType <= 0
        || s.WorkCentrId <= 0);

    private int currentStepsPartId;

    private async Task<List<ManaApp.Models.PartStepDto>> LoadStepsAsync(int productToPartId)
    {
        var url = $"http://localhost:5270/api/products/steps-by-part?productToPartId={productToPartId}";
        return await Http.GetFromJsonAsync<List<ManaApp.Models.PartStepDto>>(url) ?? new();
    }

    private async Task OpenStepsForPart(string? topPartCode)
    {       
        stepsError = null;
        
        if (string.IsNullOrWhiteSpace(topPartCode) || selectedPartDetails is null) return;

        var detail = selectedPartDetails.FirstOrDefault(x => x.TopPartCode == topPartCode);
        if (detail is null) return;

        currentStepsPartId = detail.ProductToPartId;
editingSteps = await LoadStepsAsync(detail.ProductToPartId);

// ielƒÅdƒì dropdown avotus katru reizi atverot
await LoadActiveWorkCentersAsync();
await LoadActiveStepTypesAsync();

        SetMainDialog("Steps");

        StateHasChanged();
    }

private async Task CloseStepsDialog()
{
    isStepTypesOpen = false;
    isWorkCentersOpen = false;

    stepsError = null;
    SetMainDialog(null);

    // Pƒìc soƒºu rediƒ£ƒì≈°anas/dzƒì≈°anas atsvaidzini labo pusi (‚ÄúTehnoloƒ£ija‚Äù sarakstu)
    if (selected is not null)
    {
        selectedPartDetails = await Http.GetFromJsonAsync<List<ProductDetailDto>>(
            $"http://localhost:5270/api/products/details-by-product?id={selected.id}") ?? new();

        worksByParts = await Http.GetFromJsonAsync<List<WorksByPartDto>>(
            $"http://localhost:5270/api/products/works-by-product?id={selected.id}") ?? new();
    }

    StateHasChanged();
}

    private void AddStep()
{
    if (currentStepsPartId == 0) return;
    editingSteps ??= new();

    var nextOrder = editingSteps.Count > 0
        ? editingSteps.Max(x => x.StepOrder) + 10
        : 10;

    var detail = selectedPartDetails?
        .FirstOrDefault(x => x.ProductToPartId == currentStepsPartId);

    var stage = detail?.Stage ?? 0;

    var defaultStepTypeId = stageStepTypeMap
        .FirstOrDefault(x => x.Stage == stage && x.IsActive)?
        .Step_Type_ID ?? 0;
    
    var defaultWcId = workCenters?.FirstOrDefault()?.Id ?? 0;

    editingSteps.Add(new PartStepDto
    {
        Id = 0,
        ProductToPartId = currentStepsPartId,
        StepOrder = nextOrder,
        StepName = "",
        StepType = defaultStepTypeId,
        WorkCentrId = defaultWcId,
        ParallelGroup = 0,
        IsMandatory = false,
        IsFinal = false,
        Comments = ""
    });

    StateHasChanged();
}

    private void MoveUp(PartStepDto s)
    {
        var idx = editingSteps.IndexOf(s);
        if (idx <= 0) return;
        (editingSteps[idx - 1], editingSteps[idx]) = (editingSteps[idx], editingSteps[idx - 1]);
        RecalcOrders();
    }

    private void MoveDown(PartStepDto s)
    {
        var idx = editingSteps.IndexOf(s);
        if (idx < 0 || idx >= editingSteps.Count - 1) return;
        (editingSteps[idx + 1], editingSteps[idx]) = (editingSteps[idx], editingSteps[idx + 1]);
        RecalcOrders();
    }

private void RecalcOrders()
{
    for (int i = 0; i < editingSteps.Count; i++)
    {
        editingSteps[i].StepOrder = (i + 1) * 10;
    }

    // ‚ùó NEUZSPIE≈ΩAM Final automƒÅtiski
    // Final ir lietotƒÅja atbildƒ´ba

    StateHasChanged();
}


    private async Task DeleteStepAsync(PartStepDto s)
    {
        var yes = await JS.InvokeAsync<bool>("confirm", $"Dzƒìst soli ‚Äú{s.StepName}‚Äù?");
        if (!yes) return;

        if (s.Id == 0)
        {
            editingSteps.Remove(s);
            RecalcOrders();
            return;
        }

        var resp = await Http.DeleteAsync($"http://localhost:5270/api/products/step/{s.Id}");
        if (resp.IsSuccessStatusCode)
        {
            editingSteps.Remove(s);
            RecalcOrders();
        }
        else
        {
            var body = await resp.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Dzƒì≈°ana neizdevƒÅs: {body}");
        }
    }

    private bool ValidateFinalRule()
    {
        if (editingSteps is null || editingSteps.Count == 0) return false;

        var finals = editingSteps.Where(s => s.IsFinal).ToList();
        if (finals.Count != 1) return false;

        var final = finals[0];
        var maxOrder = editingSteps.Max(s => s.StepOrder);
        return final.StepOrder == maxOrder;
    }

    private async Task SaveStepsAsync()
    {
        // === GUARD: pƒÅrbaude pirms saglabƒÅ≈°anas ===
var invalid = editingSteps
    .Select((s, i) => new { s, i })
    .FirstOrDefault(x => string.IsNullOrWhiteSpace(x.s.StepName)
                      || x.s.StepType <= 0
                      || x.s.WorkCentrId <= 0);

if (invalid != null)
{
    var field = string.IsNullOrWhiteSpace(invalid.s.StepName) ? "nosaukums"
             : (invalid.s.StepType <= 0 ? "soƒºa tips"
             : "darba centrs");

    stepsError = $"Izlabo soli #{invalid.i + 1}: nav aizpildƒ´ts {field}.";
StateHasChanged();
return;

}
// === /GUARD ===

        RecalcOrders();

        if (!ValidateFinalRule())
        {
            await JS.InvokeVoidAsync("alert",
                "Noteikums: jƒÅb≈´t TIE≈†I vienam 'Final' un tam jƒÅb≈´t pƒìdƒìjam solim. L≈´dzu izlabo pirms saglabƒÅ≈°anas.");
            return;
        }

        int tmpOrder = 1000;
        foreach (var step in editingSteps.Where(s => s.Id > 0))
        {
            var prePayload = new
            {
                Id = step.Id,
                StepOrder = tmpOrder,
                StepName = step.StepName,
                StepType = step.StepType > 0 ? step.StepType : 1,
                WorkCentrId = step.WorkCentrId,
                ParallelGroup = step.IsParallel ? 1 : 0,
                IsMandatory = step.IsMandatory,
                IsFinal = step.IsFinal,
                Comments = step.Comments
            };
            tmpOrder += 10;

            var preResp = await Http.PutAsJsonAsync("http://localhost:5270/api/products/step", prePayload);
            if (!preResp.IsSuccessStatusCode)
            {
                var b = await preResp.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Pre-PUT kƒº≈´da: {b}");
                return;
            }
        }

        RecalcOrders();

        foreach (var step in editingSteps.Where(s => s.Id == 0))
        {
            var payload = new
            {
                ProductToPartId = step.ProductToPartId,
                StepOrder = step.StepOrder,
                StepName = step.StepName,
                StepType = step.StepType > 0 ? step.StepType : 1,
                WorkCentrId = step.WorkCentrId,
                ParallelGroup = step.IsParallel ? 1 : 0,
                IsMandatory = step.IsMandatory,
                IsFinal = step.IsFinal,
                Comments = step.Comments
            };

            var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/products/step", payload);
            if (!resp.IsSuccessStatusCode)
            {
                var b = await resp.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"POST kƒº≈´da: {b}");
                return;
            }
        }

        foreach (var step in editingSteps.Where(s => s.Id > 0))
        {
            var payload = new
            {
                Id = step.Id,
                StepOrder = step.StepOrder,
                StepName = step.StepName,
                StepType = step.StepType > 0 ? step.StepType : 1,
                WorkCentrId = step.WorkCentrId,
                ParallelGroup = step.IsParallel ? 1 : 0,
                IsMandatory = step.IsMandatory,
                IsFinal = step.IsFinal,
                Comments = step.Comments
            };

            var resp = await Http.PutAsJsonAsync("http://localhost:5270/api/products/step", payload);
            if (!resp.IsSuccessStatusCode)
            {
                var b = await resp.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"PUT kƒº≈´da: {b}");
                return;
            }
        }

await CloseStepsDialog();
    }

    // ===== Jaunas detaƒºas dialogs =====
   private NewPartVm newPart = new();
    private List<PartStepDto> newPartSteps = new();

    private void CloseNewPartDialog() => SetMainDialog(null);

private async Task SaveNewPart()
{
    if (selectedDetails is null || newPart is null || newPart.TopPartId is null) return;

    
 var payload = new
{
    productId     = selected!.id,              // ‚Üê API gaida productId
    topPartId     = newPart.TopPartId!.Value,  // ‚Üê API gaida topPartId
    qtyPerProduct = newPart.QtyPerProduct      // ‚Üê API gaida qtyPerProduct (>=1)
};

    var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/products/add-part", payload);
    if (!resp.IsSuccessStatusCode)
    {
        var b = await resp.Content.ReadAsStringAsync();
        await JS.InvokeVoidAsync("alert", $"NeizdevƒÅs saglabƒÅt detaƒºu: {b}");
        return;
    }

    // atjauno sarakstus (gan detaƒºas, gan ‚ÄúTehnoloƒ£iju‚Äù)
selectedPartDetails = await Http.GetFromJsonAsync<List<ProductDetailDto>>(
    $"http://localhost:5270/api/products/details-by-product?id={selected!.id}") ?? new();

worksByParts = await Http.GetFromJsonAsync<List<WorksByPartDto>>(
    $"http://localhost:5270/api/products/works-by-product?id={selected!.id}") ?? new();

SetMainDialog(null);

}

private List<TopPartDto> topParts = new();

private async Task DeletePartByCode(string? topPartCode)
{
    if (string.IsNullOrWhiteSpace(topPartCode))
        return;

    var detail = selectedPartDetails?.FirstOrDefault(x => x.TopPartCode == topPartCode);
    if (detail is null)
    {
        await JS.InvokeVoidAsync("alert", "Neatradu ≈°ai detaƒºai ProductToPartId.");
        return;
    }

    await DeletePartAsync(detail.ProductToPartId);
}

private List<StepTypeDto> stepTypes = new();

// pƒÅrvaldƒ´bas dialogs
private string newStepTypeName = "";

private List<StepTypeRow> manageStepTypes = new();

private int? editStepTypeId = null;
private string editStepTypeName = "";

private async Task OpenStepTypeDialogAsync()
{
    // dropdowns (aktƒ´vie)
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes") ?? new();

    // pƒÅrvaldƒ´bai ‚Äì ielƒÅdƒìjam un atfiltrƒìjam tikai aktƒ´vos
    var manage = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes/manage") ?? new();
    manageStepTypes = manage
        .Where(x => x.IsActive)
        .OrderBy(x => x.StepTypeName)
        .Select(x => new StepTypeRow { Id = x.Id, Name = x.StepTypeName, IsActive = x.IsActive })
        .ToList();

    // notƒ´rƒÅm jebkuru iepriek≈°ƒìjo rediƒ£ƒì≈°anas stƒÅvokli
    editStepTypeId = null;
    editStepTypeName = "";
    isWorkCentersOpen = false;
    isStepTypesOpen = true;
    StateHasChanged();
}

private async Task RefreshStepTypesAsync()
{
    // dropdownam
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes") ?? new();

    // pƒÅrvaldƒ´bai (tikai aktƒ´vie)
    var manage = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes/manage") ?? new();
    manageStepTypes = manage
        .Where(x => x.IsActive)
        .OrderBy(x => x.StepTypeName)
        .Select(x => new StepTypeRow { Id = x.Id, Name = x.StepTypeName, IsActive = x.IsActive })
        .ToList();
}


// CRUD darbƒ´bas pƒÅrvaldƒ´bas dialogƒÅ
private async Task AddStepTypeAsync()
{
    var name = (newStepTypeName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(name)) { await JS.InvokeVoidAsync("alert","Ievadi nosaukumu."); return; }
    var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/steptypes", new { Name = name });
    if (!resp.IsSuccessStatusCode) { await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync()); return; }
    newStepTypeName = "";
    await OpenStepTypeDialogAsync(); // refre≈°s
    // refre≈°o dropdown datus
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes") ?? new();
    StateHasChanged();
}

private void BeginEditStepType(StepTypeRow row)
{
    editStepTypeId = row.Id;
    editStepTypeName = row.Name;
}

private void CancelEditStepType()
{
    editStepTypeId = null;
    editStepTypeName = "";
}

private async Task SaveEditStepTypeAsync()
{
    if (editStepTypeId is null) return;
    var name = (editStepTypeName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(name))
    {
        await JS.InvokeVoidAsync("alert", "Ievadi nosaukumu.");
        return;
    }

    var resp = await Http.PutAsJsonAsync("http://localhost:5270/api/steptypes",
        new { Id = editStepTypeId.Value, Name = name });

    if (!resp.IsSuccessStatusCode)
    {
        await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
        return;
    }

    editStepTypeId = null;
    editStepTypeName = "";
    await RefreshStepTypesAsync(); // pƒÅrlƒÅdƒì gan pƒÅrvaldƒ´bas sarakstu, gan dropdown
}



private async Task DeleteStepTypeAsync(int id)
{
    var ok = await JS.InvokeAsync<bool>("confirm", "Dzƒìst soƒºa tipu? (soft delete)");
    if (!ok) return;
    var resp = await Http.DeleteAsync($"http://localhost:5270/api/steptypes/{id}");
    if (!resp.IsSuccessStatusCode) { await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync()); return; }
    await OpenStepTypeDialogAsync();
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>("http://localhost:5270/api/steptypes") ?? new();
    StateHasChanged();
}

// dropdown atsvaidzinƒÅ≈°anai

private List<WorkCenterManageDto> manageWorkCenters = new();

private async Task OpenWorkCenterDialogAsync()
{
    newWorkCenterName = "";   

    manageWorkCenters = (await Http.GetFromJsonAsync<List<WorkCenterManageDto>>(
        "http://localhost:5270/api/workcenters/manage") ?? new())
        .Where(x => x.IsActive)
        .ToList();

    isStepTypesOpen = false;
    isWorkCentersOpen = true;
}

private string newWorkCenterName = "";
private int? editWorkCenterId = null;
private string editWorkCenterName = "";

private async Task RefreshWorkCentersAsync()
{
    manageWorkCenters = (await Http.GetFromJsonAsync<List<WorkCenterManageDto>>(
    "http://localhost:5270/api/workcenters/manage") ?? new())
    .Where(x => x.IsActive)                   // ‚Üê slƒìpjam neaktƒ´vos
    .ToList();

}

private async Task AddWorkCenterAsync()
{
    var name = (newWorkCenterName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(name)) { await JS.InvokeVoidAsync("alert","Ievadi nosaukumu."); return; }

// ƒ£enerƒìjam kodu (bez atstarpƒìm, lielie burti; ja gribi citu formƒÅtu ‚Äî pasaki)
var code = (name ?? "").Trim().ToUpper().Replace(" ", "_");

var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/workcenters/add",
    new { WorkCentr_Name = name, WorkCentr_Code = code });
    

    if (!resp.IsSuccessStatusCode)
    {
        await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
        return;
    }
    newWorkCenterName = "";
    await RefreshWorkCentersAsync();
    await LoadActiveWorkCentersAsync();

}


private void CancelEditWorkCenter()
{
    editWorkCenterId = null; editWorkCenterName = "";
}

private async Task SaveEditWorkCenterAsync()
{
      if (editWorkCenterId is null) return;
    
    var name = (editWorkCenterName ?? "").Trim();
    if (string.IsNullOrWhiteSpace(name)) { await JS.InvokeVoidAsync("alert","Ievadi nosaukumu."); return; }

    // ƒ£enerƒìjam kodu no nosaukuma (bez atstarpƒìm, lielie burti)
var code = (name ?? "").Trim().ToUpper().Replace(" ", "_");

var resp = await Http.PutAsJsonAsync("http://localhost:5270/api/workcenters/update",
    new { Id = editWorkCenterId!.Value, WorkCentr_Name = name, WorkCentr_Code = code });


    if (!resp.IsSuccessStatusCode)
    {
        await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
        return;
    }
    editWorkCenterId = null; editWorkCenterName = "";
    await RefreshWorkCentersAsync();
    await LoadActiveWorkCentersAsync();

}

private async Task DeleteWorkCenterAsync(int id)
{
    var ok = await JS.InvokeAsync<bool>("confirm", "Dzƒìst darba centru? (soft delete)");
    if (!ok) return;

    var resp = await Http.DeleteAsync($"http://localhost:5270/api/workcenters/{id}");
    if (!resp.IsSuccessStatusCode)
    {
        await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
        return;
    }
    await RefreshWorkCentersAsync();
    await LoadActiveWorkCentersAsync();

}

private bool NewPartExistsAlready
{
    get
    {
        if (newPart?.TopPartId is not int id) return false;
        var sel = topParts.FirstOrDefault(t => t.Id == id);
        return sel != null && (selectedPartDetails?.Any(d => d.TopPartCode == sel.TopPartCode) ?? false);
    }
}

private bool NewPartInvalid =>
    newPart is null
    || newPart.TopPartId is null
    || newPart.QtyPerProduct < 1
    || NewPartExistsAlready;

private void SetRootFilter(string value)
{
    selectedRoot = value ?? "";
    ApplyFilters();
    StateHasChanged();
}

private bool HasAnyFilters =>
    !string.IsNullOrWhiteSpace(selectedRoot)
    || !string.IsNullOrWhiteSpace(selectedCategory)
    || !string.IsNullOrWhiteSpace(searchText);

private bool IsLastStep(PartStepDto s)
{
    if (editingSteps is null || editingSteps.Count == 0)
        return false;

    var maxOrder = editingSteps.Max(x => x.StepOrder);
    return s.StepOrder == maxOrder;
}

private void SetFinalStep(PartStepDto step)
{
    if (!IsLastStep(step))
        return;

    foreach (var s in editingSteps)
        s.IsFinal = false;

    step.IsFinal = true;

    StateHasChanged();
}

private async Task LoadActiveStepTypesAsync()
{
    stepTypes = await Http.GetFromJsonAsync<List<StepTypeDto>>(
        "http://localhost:5270/api/steptypes") ?? new();
}
private bool copyTechnologySteps = false;

private async Task OpenNewPartDialog()
{
    newPart = new NewPartVm { TopPartId = null, QtyPerProduct = 1 };
    newPartSteps = new List<ManaApp.Models.PartStepDto>();
    SetMainDialog("NewPart");
}

private Task HandleBeginEditStepType(StepTypeRow row)
{
    editStepTypeId = row.Id;
    editStepTypeName = row.Name;
    return Task.CompletedTask;
}

private void BeginEditWorkCenter(WorkCenterManageDto it)
{
    editWorkCenterId = it.Id;
    editWorkCenterName = it.WorkCentr_Name;
}

private async Task HandleNewPartSave(NewPartVm model)
{
    await SaveNewPart();
}

private bool IsProductDialogOpen => activeMainDialog == "Product";
private void SetMainDialog(string? dialog)
{
    activeMainDialog = dialog;
}

private class AddPartResponse
{
    public int Id { get; set; }
}
private async Task ToggleTopPartAsync(TopPartDto part)
{
    if (selected is null)
        return;

    selectedPartDetails ??= new List<ProductDetailDto>();

    var existing = selectedPartDetails
        .FirstOrDefault(x => x.TopPartCode == part.TopPartCode);

    if (existing is null)
    {
        // ===== ADD =====
        var resp = await Http.PostAsJsonAsync(
            "http://localhost:5270/api/products/add-part",
            new
            {
                productId = selected.id,
                topPartId = part.Id,
                qtyPerProduct = 1
            });

        if (!resp.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
            return;
        }

        var result = await resp.Content.ReadFromJsonAsync<AddPartResponse>();

        if (result is null)
        {
            await JS.InvokeVoidAsync("alert", "Serveris neatgrieza ID.");
            return;
        }

        // üëá pievienojam lokƒÅli bez reload
        selectedPartDetails.Add(new ProductDetailDto
        {
            ProductToPartId = result.Id,
            TopPartName = part.TopPartName,
            TopPartCode = part.TopPartCode,
            Quantity = 1
        });
    }
    else
    {
        // ===== REMOVE =====
        var resp = await Http.PutAsJsonAsync(
            "http://localhost:5270/api/products/toggle-part",
            new
            {
                ProductToPartId = existing.ProductToPartId,
                IsActive = false
            });

        if (!resp.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", await resp.Content.ReadAsStringAsync());
            return;
        }

        // üëá iz≈Üemam lokƒÅli bez reload
        selectedPartDetails.Remove(existing);
    }

    StateHasChanged();
}

private bool _showArchived;

private bool ShowArchived
{
    get => _showArchived;
    set
    {
        if (_showArchived == value) return;

        _showArchived = value;
        ApplyFilters();
    }
}

private void OnArchivedChanged(ChangeEventArgs e)
{
    ApplyFilters();
}

}
