@page "/sales"
@inject HttpClient Http
@using System.Net.Http.Json
@using System.Linq
@using System.Text.Json.Serialization
@using Syncfusion.Blazor.Grids
@inject IJSRuntime JS
@using ManaApp.Shared

@using ManaApp.Models
@using ManaApp.Components


<PageHeader Title="PƒÄRDO≈†ANA" />

  <div class="planning-header-card">  

    <div class="planning-content">
                           <!-- ≈†eit sƒÅkas preƒçu saraksts -->
        <div class="planning-main">
            <div class="planning-panel">
<div class="planning-toolbar-row">

    <PlanningToolbar
        SearchText="@searchText"
        SearchTextChanged="(v) => searchText = v"
        SelectedView="@selectedView"
        SelectedViewChanged="(v) => selectedView = v"
        OnDownloadExcel="DownloadPlanningExcel" />

    <button class="toolbar-btn refresh-btn"
            @onclick="ManualRefresh">
        üîÑ AtsvaidzinƒÅt
    </button>

</div>

@* <PlanningGrid Rows="@groupedRows" /> *@

<SalesTable
    Groups="@FilteredRows"
    OnSell="OpenSellPopup" />


           @if (selected is not null && Summary is not null)
           {
               <div style="margin-top:8px;">
                   <b>@selected.categoryName ‚Ä¢ @selected.productName (@selected.productCode)</b>
                   <div style="display:grid;grid-template-columns:200px repeat(7,110px);margin-top:6px;">
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center"><b>VersionId</b></div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center"><b>Planned</b></div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center"><b>Detailed</b></div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center"><b>Assembly</b></div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center"><b>Finishing</b></div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center"><b>Stock</b></div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center"><b>Scrap</b></div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center"><b>Out</b></div>

                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center">@selected.VersionId</div>
                       
                       @{
                           var planned = selected.Planned;
                           var bg = planned > 0 ? "#00ff00" : "transparent";
                       }
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center; background:@bg">
                           @planned
                       </div>

                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center; background:#f9b115">@Summary.Detailed</div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center; background:#f9b115">@Summary.Assembly</div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center; background:#ffe873">@Summary.Finishing</div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center; background:#efefef">@Summary.Stock</div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center; background:#efefef">@Summary.Scrap</div>
                       <div style="min-width:110px;padding:6px 10px;border:1px solid #ccc;text-align:center; background:#efefef">@Summary.Out</div>
                   </div>
               </div>
           }

        </div>
        </div>
        <!-- LABƒÄ PUSE: jaunais Batch panelis -->

        <div class="planning-right">

<SalesBatchPanel
    SalesItems="salesItems"
    OnSold="OnSalesSold"
    OnAutosave="SaveSalesDraftAsync"
    EditSalesRequested="OpenEditSalesPopup" />


</div>

</div>
    
</div>
  

@if (isSellPopupOpen)
{
<SalesAllocateDialog
    ProductId="sellProductId"
    ProductName="@sellProductName"
    VersionName="@sellVersionName"
    Batches="sellBatches"
    OnConfirm="@( (ManaApp.Models.SalesAllocateResult r) => OnSellPopupConfirmed(r) )"
    OnCancel="CloseSellPopup" />

}

@if (isEditSalesPopupOpen)
{
    <SalesEditDialog
    Items="editSalesItems"
    OnClose="CloseEditSalesPopup"
    OnSave="OnEditSalesSaved" />

}

@code {
   
    private List<ProductRow> rows = new();
    private List<ProductRow> allRows = new();
private List<CategoryRow> categories = new();

private List<CategoryRow> categoriesFiltered = new();

private List<SalesAllocateDialog.BatchRow> sellBatches = new();
   

private bool isInitializing = true;

protected override async Task OnInitializedAsync()
{
    await ReloadPlanningDataAsync();
    await LoadSalesDraftAsync();

    isInitializing = false;
}

// "-" popup stƒÅvoklis
private bool isMinusOpen = false;
private ProductRow? minusRow;

private async Task LoadSummariesForRows(IEnumerable<ProductRow> targetRows)
    {
        foreach (var r in targetRows)
        {
            var eligible = targetRows.Count(r => r.VersionId.HasValue && r.VersionId > 0);

            if (r.VersionId is null || r.VersionId <= 0)
{
    var c = await Http.GetFromJsonAsync<ProductContentDto>(
        $"http://localhost:5270/api/products/content?id={r.id}");
    r.VersionId = c?.VersionId;
    if (!string.IsNullOrWhiteSpace(c?.VersionName))
    r.versionName = c!.VersionName!;

    if (r.VersionId is null || r.VersionId <= 0) continue;
}

            var sum = await Http.GetFromJsonAsync<StockSummary>(
    $"http://localhost:5270/api/stockmovements/summary?versionId={r.VersionId}");

            if (sum is null) continue;
            
           r.InStock = sum.Stock;

// AssemblyINProgress / AssemblyFinish vairs NEMAINƒÄM ≈°eit,
// tie tagad nƒÅk no /api/batches/list
// r.AssemblyINProgress  = ...
// r.AssemblyFinish      = ...

r.FinishingInProgress = sum.Finishing;
r.InStock            = sum.Stock;

var finAlloc = await Http.GetFromJsonAsync<FinAllocatedDto>(
    $"http://localhost:5270/api/tasks/finishing-allocated-by-version?versionId={r.VersionId}");

r.FinishingAllocated = finAlloc?.FinishingAllocated ?? 0;

        }

        // tikai vienreiz pƒìc cikla
        StateHasChanged();
    }

private void BuildCategoriesFromRows(IEnumerable<ProductRow> source)
{
    categories = source
        .Where(r => !string.IsNullOrWhiteSpace(r.categoryName))
        .Select(r => (r.categoryName ?? "").Trim())
        .Where(name => !string.IsNullOrWhiteSpace(name))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(name => name)
        .Select(name => new CategoryRow { CategoryName = name })
        .ToList();
        // 0. lƒ´me≈Üa datu avots tree-view gridam
    categoriesFiltered = categories;
}
  
    private List<ProductSimpleRow> simpleRows = new();
    private string searchText = "";
    private ProductViewType selectedView = ProductViewType.Kauss;
    private int VersionId = 1;

    private StockSummary? Summary;
    private string? Raw;        
    private string? Error;      

   private async Task Load()
{
    Error = null;
    Summary = null;
    Raw = null;

    if (selected is null || !(selected.VersionId.HasValue && selected.VersionId > 0))
{
    Error = "Nav izvƒìlƒìta rinda vai nav VersionId.";
    return;
}

    try
    {
        var url = $"http://localhost:5270/api/stockmovements/summary?versionId={selected.VersionId}";
        Console.WriteLine($"CLICK Load -> {url}");
        
        Raw = await Http.GetStringAsync(url);
        Console.WriteLine($"RAW LEN = {Raw?.Length}");

        if (string.IsNullOrWhiteSpace(Raw)) { Error = "Empty response"; return; }
        Summary = System.Text.Json.JsonSerializer.Deserialize<StockSummary>(Raw)!;

        Console.WriteLine($"Parsed Finishing = {Summary?.Finishing}");
    }
    catch (Exception ex)
    {
        Error = ex.ToString();
        Console.WriteLine(Error);
    }
}

    
    private ProductRow? selected;

    private async Task OnRowSelected(RowSelectEventArgs<ProductRow> args)
{
    selected = args.Data;
    VersionId = selected?.VersionId ?? 0; // var paturƒìt tikai info dƒìƒº
    await Load();                         // vienmƒìr lƒÅdƒìjam pƒìc BatchProduct_ID
}

private async Task ReloadAfterCreate()
{
    await ReloadPlanningDataAsync();
}


private IEnumerable<ProductRow> GetRowsForCategory(object catObj)
{
    var cat = catObj as CategoryRow;
    if (cat is null) return Enumerable.Empty<ProductRow>();

    var key = (cat.CategoryName ?? "").Trim();

    // PamatƒÅ ‚Äì tikai ≈°ƒ´s kategorijas preces
    var query = rows.Where(r =>
        string.Equals((r.categoryName ?? "").Trim(), key, StringComparison.OrdinalIgnoreCase)
    );

    // Ja nav meklƒì≈°anas teksta ‚Äì atdod visus ≈°ƒ´s kategorijas produktus
    if (string.IsNullOrWhiteSpace(searchText))
        return query;

    // Ja ir meklƒì≈°ana ‚Äì filtrƒì ≈°ƒ´s kategorijas iek≈°ienƒì
    return query.Where(r =>
        (r.productName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
        (r.productCode?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
        (r.categoryName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
    );
}

private async Task ReloadPlanningDataAsync()
{
    // 1) Produkti
    rows = await Http.GetFromJsonAsync<List<ProductRow>>(
    "http://localhost:5270/api/products/planning-list")
    ?? new();

    allRows = new List<ProductRow>(rows);

    // 2) Stock + FinishingInProgress
    await LoadSummariesForRows(rows);

    // 3) Batch dati (Planned / Detailed / Assembly)
    var plannedList = await Http.GetFromJsonAsync<List<ManaApp.Models.BatchPlannedRow>>(

        "http://localhost:5270/api/batches/list?batch_type=1")
        ?? new();

    var plannedByVersion = plannedList
        .GroupBy(x => x.VersionId)
        .ToDictionary(g => g.Key, g => g.Sum(x => x.Planned));

    var detailedInProgressByVersion = plannedList
        .GroupBy(x => x.VersionId)
        .ToDictionary(g => g.Key, g => g.Sum(x => x.DetailedInProgress));

    var detailedFinishByVersion = plannedList
        .GroupBy(x => x.VersionId)
        .ToDictionary(g => g.Key, g => g.Sum(x => x.DetailedFinish));

    var assemblyInProgressByVersion = plannedList
        .GroupBy(x => x.VersionId)
        .ToDictionary(g => g.Key, g => g.Sum(x => x.AssemblyInProgress));

    var assemblyFinishByVersion = plannedList
        .GroupBy(x => x.VersionId)
        .ToDictionary(g => g.Key, g => g.Sum(x => x.AssemblyFinish));



    // 4) AizpildƒÅm rindas
    foreach (var r in rows)
    {
        if (!r.VersionId.HasValue)
        {
            r.Planned = 0;
            r.DetailedInProgress = 0;
            r.DetailedFinish = 0;
            r.AssemblyINProgress = 0;
            r.AssemblyFinish = 0;
            continue;
        }

        var vid = r.VersionId.Value;

        Console.WriteLine($"[DEBUG] row vid={vid}, planned={(plannedByVersion.TryGetValue(vid, out var p2) ? p2 : -1)}");


        r.Planned = plannedByVersion.TryGetValue(vid, out var p) ? p : 0;
        r.DetailedInProgress = detailedInProgressByVersion.TryGetValue(vid, out var d) ? d : 0;
        r.DetailedFinish = detailedFinishByVersion.TryGetValue(vid, out var df) ? df : 0;
        r.AssemblyINProgress = assemblyInProgressByVersion.TryGetValue(vid, out var ap) ? ap : 0;
        r.AssemblyFinish =
    assemblyFinishByVersion.TryGetValue(vid, out var af) ? af : 0;
    

            if (r.AssemblyFinish < 0)
                r.AssemblyFinish = 0;

    }

    // 5) SakƒÅrtojam
    rows = rows
        .OrderBy(r => r.categoryName)
        .ThenBy(r => r.productName)
        .ToList();

// UztaisƒÅm "viena rinda uz produktu" + bƒìrni = versijas
// UztaisƒÅm "viena rinda uz produktu" + bƒìrni = versijas
groupedRows = rows
    .GroupBy(r =>
        $"{(r.categoryName ?? "").Trim()}||{(r.productCode ?? "").Trim()}",
        StringComparer.OrdinalIgnoreCase)
    .Select(g =>
    {
        var parts = g.Key.Split("||", 2);
        var cat  = parts.Length > 0 ? parts[0] : "";
        var code = parts.Length > 1 ? parts[1] : "";

        var first = g.First();


        return new ProductGroupRow
        {
            CategoryName = cat,
            ProductCode  = code,
            ProductName  = first.productName ?? "",

            InStock = g.Sum(x => x.InStock),
            Planned = g.Sum(x => x.Planned),
            DetailedInProgress = g.Sum(x => x.DetailedInProgress),
            DetailedFinish     = g.Sum(x => x.DetailedFinish),
            AssemblyINProgress = g.Sum(x => x.AssemblyINProgress),
            AssemblyFinish = g.Sum(x => x.AssemblyFinish),
            Versions = g
                .OrderByDescending(x => x.VersionId ?? 0) // jaunƒÅkƒÅ aug≈°ƒÅ
                .ToList()
        };
    })
    
    .OrderBy(x => x.CategoryName)
    .ThenBy(x => x.ProductName)
    .ToList();

flatRows.Clear();

foreach (var grp in groupedRows
    .GroupBy(g => g.CategoryName)
    .OrderBy(g => g.Key))
{
    flatRows.Add(new CategoryHeaderRow
    {
        CategoryName = grp.Key
    });

    foreach (var row in grp.OrderBy(r => r.ProductName))
    {
        flatRows.Add(row);
    }
}


    BuildLatestVersionByCode();
    await InvokeAsync(StateHasChanged);
}

public sealed class FinProgressDto
{
    [JsonPropertyName("finishingInProgress")]
    public int FinishingInProgress { get; set; }
}


private async Task DownloadPlanningExcel()
{
    // atver jaunu tabu un lejupielƒÅdƒì failu no API
    await JS.InvokeVoidAsync("open", "http://localhost:5270/api/reports/planning-excel", "_blank");
}

// productCode -> latest VersionId
private readonly Dictionary<string, int> _latestVersionByCode = new(StringComparer.OrdinalIgnoreCase);

private void BuildLatestVersionByCode()
{
    _latestVersionByCode.Clear();

    foreach (var g in rows
        .Where(r => !string.IsNullOrWhiteSpace(r.productCode) && r.VersionId is > 0)
        .GroupBy(r => r.productCode.Trim(), StringComparer.OrdinalIgnoreCase))
    {
        _latestVersionByCode[g.Key] = g.Max(x => x.VersionId!.Value);
    }
}
private bool IsLatestVersion(ProductRow r)
{
    if (r is null) return false;
    if (string.IsNullOrWhiteSpace(r.productCode)) return true; // ja nav koda, lai netraucƒì
    if (r.VersionId is not int v || v <= 0) return false;

    return _latestVersionByCode.TryGetValue(r.productCode.Trim(), out var latest) && v == latest;
}

private List<ProductGroupRow> groupedRows = new();

private List<IPlanningRow> flatRows = new();

private List<ProductGroupRow> FilteredRows =>
    groupedRows
        .Where(MatchRoot)
        .Where(g =>
            string.IsNullOrWhiteSpace(searchText) ||
            g.ProductName.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
            g.ProductCode.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
            g.CategoryName.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
            g.Versions.Any(v =>
                v.productName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) == true ||
                v.productCode?.Contains(searchText, StringComparison.OrdinalIgnoreCase) == true
            )
        )
        .ToList();

private Task OnPlannedMinus(ProductRow row)
{
    minusRow = row;
    isMinusOpen = true;
    StateHasChanged();
    return Task.CompletedTask;
}


private bool MatchRoot(ProductGroupRow g)
{
    var root = selectedView == ProductViewType.Kauss
        ? "KAUSS"
        : "ADAPTERIS";

    // skatƒÅmies uz jebkuru versiju grupƒÅ (visƒÅm b≈´s viens root)
    var any = g.Versions?.FirstOrDefault();
    if (any is null) return false;

    var stem = root.Length > 1 ? root[..^1] : root;
    return (any.rootName ?? "")
        .StartsWith(stem, StringComparison.OrdinalIgnoreCase);
}

private List<BatchCartItem> batchItems = new();


protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (!firstRender)
        return;
    
}

private void CloseMinusDialog()
{
    isMinusOpen = false;
    minusRow = null;
}

private void OnMinusConfirmed(int qty)
{
    if (minusRow is null)
        return;

    salesItems = salesItems
        .Append(new SalesCartItem
        {
            VersionId   = minusRow.VersionId ?? 0,
            ProductName = minusRow.productName ?? "",
            VersionName = minusRow.versionName,
            Qty         = qty,
            InStock     = minusRow.InStock
        })
        .ToList();
    // ‚¨ÖÔ∏è KRITISKI: atjaunojam ASSEMBLY, lai SalesEditDialog to redz
if (minusRow.AssemblyFinish > 0)
{
    salesItems = salesItems
        .Append(new SalesCartItem
        {
            VersionId   = minusRow.VersionId ?? 0,
            ProductName = minusRow.productName ?? "",
            VersionName = minusRow.versionName,
            Qty         = 0, // sƒÅkumƒÅ 0, rediƒ£ƒì popupƒÅ
            InStock     = minusRow.AssemblyFinish,
            IsAssembly  = true,

            Batches = new List<SalesBatchItem>
            {
                new SalesBatchItem
                {
                    BatchProductId = 0,
                    BatchCode      = "-",
                    Qty            = 0,
                    AvailableQty   = minusRow.AssemblyFinish
                }
            }
        })
        .ToList();
}


    isMinusOpen = false;
    minusRow = null;

    StateHasChanged(); // <‚Äì piespie≈æ SalesBatchPanel pƒÅrzƒ´mƒìties
}


private List<SalesCartItem> salesItems = new();

// popup rediƒ£ƒìjamƒÅ kopija (Edit-Copy pattern)
private List<SalesCartItem> editSalesItems = new();



// pievienots pƒÅrdo≈°anas console

private async Task OnSalesSold()
{
    var ok = await JS.InvokeAsync<bool>(
        "confirm",
        "ApstiprinƒÅt pƒÅrdo≈°anu?"
    );

    if (!ok)
        return;

    var resp = await Http.PostAsync(
        "http://localhost:5270/api/sales-drafts/commit",
        null
    );

    if (!resp.IsSuccessStatusCode)
    {
        var err = await resp.Content.ReadAsStringAsync();
        await JS.InvokeVoidAsync("alert", err);
        return;
    }

    // UI RESET pƒìc commit
    // UI RESET pƒìc commit
salesItems.Clear();

// ‚¨ÖÔ∏è OBLIGƒÄTI: pƒÅrlƒÅdƒì datus, kas baro Plan kolonnu
await ReloadPlanningDataAsync();

// ‚¨ÖÔ∏è OBLIGƒÄTI: Blazor render ciklƒÅ
await InvokeAsync(StateHasChanged);

}

public class SalesCommitResult
{
    public bool Ok { get; set; }
    public List<SalesCommitItem> Items { get; set; } = new();
}

public class SalesCommitItem
{
    public int VersionId { get; set; }
    public int InStock { get; set; }
}

// 10.01.2026 labojums JAUNAJAM PƒÅrdo≈°anas popup logam:

private bool isSellPopupOpen = false;
private int sellProductId;
private string? sellProductName;
private string? sellVersionName;
private int? sellVersionId;

private SalesSummary? pendingSale;

//testa labojums 10.01.2026

private async Task OpenSellPopup(ProductRow row)
{
    sellProductId = row.id;
    sellProductName = row.productName ?? "";
    sellVersionName = row.versionName;
    sellVersionId = row.VersionId;

    sellBatches.Clear();

    var apiRows = await Http.GetFromJsonAsync<List<ApiBatchRow>>(
        $"http://localhost:5270/api/stockmovements/available-by-batch?versionId={row.VersionId}");

    if (apiRows != null)
    {
        sellBatches = apiRows
            .GroupBy(x => new { x.BatchProductId, x.BatchCode })
            .Select(g => new SalesAllocateDialog.BatchRow
            {
                BatchProductId = g.Key.BatchProductId,
                BatchCode = g.Key.BatchCode,
                StockQty = g.Where(x => x.MoveType == "STOCK").Sum(x => x.AvailableQty),
                AssemblyQty = g.Where(x => x.MoveType == "ASSEMBLY").Sum(x => x.AvailableQty)
            })
            .ToList();
    }
    
    // ‚¨ÖÔ∏è pieskaitƒÅm atpakaƒº ≈°ƒ´ melnraksta apjomus,
// lai dialogƒÅ rƒÅdƒ´tu FIZISKO pieejamƒ´bu
foreach (var it in salesItems.Where(x => x.VersionId == row.VersionId))
{
    foreach (var b in it.Batches)
    {
        var target = sellBatches
            .FirstOrDefault(x => x.BatchProductId == b.BatchProductId);

        if (target != null)
        {
            if (it.IsAssembly)
                target.AssemblyQty += b.Qty;
            else
                target.StockQty += b.Qty;
        }
    }
}


    isSellPopupOpen = true;
    StateHasChanged();
}

private sealed class ApiBatchRow
{
    public int BatchProductId { get; set; }
    public string BatchCode { get; set; } = "";
    public string MoveType { get; set; } = "";
    public int AvailableQty { get; set; }
}


private void CloseSellPopup()
{
    isSellPopupOpen = false;
    sellVersionId = null;
}

// pƒÅrdo≈°ana Ok apstirpinƒÅ≈°anai
public sealed class StockMoveDto
{
    public int Version_ID { get; set; }
    public string From { get; set; } = "";   // "STOCK" | "ASSEMBLY"
    public string To { get; set; } = "OUT";
    public int Qty { get; set; }
    public int BatchProduct_ID { get; set; }
}

private async Task OnSellPopupConfirmed(SalesAllocateResult result)
{
    Console.WriteLine("=== SELL POPUP CONFIRMED ===");

foreach (var s in result.BatchSelections ?? new List<BatchSelection>())
{
    Console.WriteLine(
        $"BatchProductId={s.BatchProductId}, " +
        $"FromStock={s.FromStock}, " +
        $"FromAssembly={s.FromAssembly}"
    );
}
    
    var versionId = sellVersionId ?? 0;
    var selections = result.BatchSelections ?? new List<BatchSelection>();

    if ((result.BatchSelections?.Any(s => s.FromStock > 0 || s.FromAssembly > 0)) == true)
{
    salesItems.RemoveAll(it => it.VersionId == versionId);
}


// STRICT DATA COMPLETION
// SalesBatchItem already has BatchCode property
// Copy BatchCode directly from selection (s.BatchCode)
// Do NOT change existing logic, filters, or structure
// Do NOT add fallbacks or new logic

var stockBatches = selections
    .Where(s => s.FromStock > 0)
    .Select(s =>
    {
        var avail = sellBatches.FirstOrDefault(b => b.BatchProductId == s.BatchProductId);
        return new SalesBatchItem
        {
            BatchProductId = s.BatchProductId,
            BatchCode      = s.BatchCode,
            Qty            = s.FromStock,
            AvailableQty   = avail?.StockQty ?? 0
        };
    })
    .ToList();


    if (stockBatches.Count > 0)
    {
        salesItems.Add(new SalesCartItem
        {
            VersionId = versionId,
            ProductName = result.ProductName,
            VersionName = sellVersionName,
            Qty = stockBatches.Sum(b => b.Qty),
            InStock = result.StockTotal,
            IsAssembly = false,
            Batches = stockBatches
        });
    }

var assemblyBatches = selections
    .Where(s => s.FromAssembly > 0)
    .Select(s =>
    {
        var avail = sellBatches.FirstOrDefault(b => b.BatchProductId == s.BatchProductId);
        return new SalesBatchItem
        {
            BatchProductId = s.BatchProductId,
            BatchCode      = s.BatchCode,
            Qty            = s.FromAssembly,
            AvailableQty   = avail?.AssemblyQty ?? 0
        };
    })
    .ToList();


    if (assemblyBatches.Count > 0)
    {
        salesItems.Add(new SalesCartItem
        {
            VersionId = versionId,
            ProductName = result.ProductName,
            VersionName = sellVersionName,
            Qty = assemblyBatches.Sum(b => b.Qty),
            InStock = result.AssemblyTotal,
            IsAssembly = true,
            Batches = assemblyBatches
        });
    }

    isSellPopupOpen = false;
sellVersionId = null;

await SaveSalesDraftAsync();
await LoadSalesDraftAsync();
await ReloadPlanningDataAsync();

StateHasChanged();

}

private void OpenEditSalesPopup()
{
    // Izveidojam dziƒºu salesItems kopiju popup rediƒ£ƒì≈°anai
    editSalesItems = salesItems

    // STRICT COPY FIX
// This is a deep copy for edit popup
// Copy ALL existing SalesBatchItem properties AS-IS
// Do NOT rename properties
// Do NOT add logic
// Do NOT change structure

        .Select(item => new SalesCartItem
        {
            VersionId   = item.VersionId,
            ProductName = item.ProductName,
            VersionName = item.VersionName,
            Qty         = item.Qty,
            InStock     = item.InStock,
            IsAssembly  = item.IsAssembly,

            Batches = item.Batches
            .Select(b => new SalesBatchItem
            {
                BatchProductId = b.BatchProductId,
                BatchCode      = b.BatchCode,
                Qty            = b.Qty,
                AvailableQty   = b.AvailableQty   // ‚¨ÖÔ∏è Svarƒ´gi, lai parƒÅdƒÅs apjoms pie popupƒÅ
            })
            .ToList()
        })
        .ToList();

    isEditSalesPopupOpen = true;
}
      
private bool isEditSalesPopupOpen = false;

private void CloseEditSalesPopup()
{
    isEditSalesPopupOpen = false;
}
private async Task OnEditSalesSaved(List<SalesCartItem> updatedItems)

{
    salesItems = updatedItems.ToList();

    foreach (var updated in updatedItems)
    {
        // 1) pƒÅrrƒìƒ∑inam summu no batchiem
        updated.Qty = updated.Batches.Sum(b => b.Qty);

        // 2) ja ≈°im (VersionId + IsAssembly) nav ko pƒÅrdot ‚Üí iz≈Üemam rindu
        if (updated.Qty <= 0)
        {
            salesItems.RemoveAll(x =>
                x.VersionId == updated.VersionId &&
                x.IsAssembly == updated.IsAssembly);
            continue;
        }

        // 3) citƒÅdi ‚Äì parasts update
var idx = salesItems.FindIndex(x =>
    x.VersionId == updated.VersionId &&
    x.IsAssembly == updated.IsAssembly);

if (idx >= 0)
    salesItems[idx] = updated;
else
    salesItems.Add(updated);
}

// ≈°is labojums pievienots 20.01.2026
await SaveSalesDraftAsync();

isEditSalesPopupOpen = false;
StateHasChanged();
await ReloadPlanningDataAsync();

}

private async Task SaveSalesDraftAsync()
{
    if (isInitializing && !isEditSalesPopupOpen)
    return;


    var dto = new
    {
        Items = salesItems
            .SelectMany(it => it.Batches.Select(b => new
            {
                VersionId      = it.VersionId,
                BatchProductId = b.BatchProductId,
                BatchCode      = b.BatchCode,
                Qty            = b.Qty,
                IsAssembly     = it.IsAssembly
            }))
            .Where(x => x.Qty > 0)
            .ToList()
    };

    await Http.PostAsJsonAsync(
        "http://localhost:5270/api/sales-drafts/autosave",
        dto
    );
}

private async Task LoadSalesDraftAsync()
{
      var resp = await Http.GetAsync(
        "http://localhost:5270/api/sales-drafts/last"
    );

    if (!resp.IsSuccessStatusCode || resp.Content.Headers.ContentLength == 0)
        return;

    var draft = await resp.Content.ReadFromJsonAsync<SalesDraftDto>();
    if (draft == null)
        return;

    salesItems.Clear();

var grouped = draft.Items
    .GroupBy(x => new { x.VersionId, x.IsAssembly });

foreach (var g in grouped)
{
    var row = rows.FirstOrDefault(r => r.VersionId == g.Key.VersionId);

    salesItems.Add(new SalesCartItem
    {
        VersionId   = g.Key.VersionId,
        ProductName = row?.productName ?? "",
        VersionName = row?.versionName,
        IsAssembly  = g.Key.IsAssembly,

        // summa no batchiem
        Qty = g.Sum(x => x.Qty),

        InStock = row?.InStock ?? 0,

        // ‚¨ÖÔ∏è KRITISKI: batchi nƒÅk NO DRAFTA, nevis no API
        Batches = g.Select(x => new SalesBatchItem
        {
            BatchProductId = x.BatchProductId,
            BatchCode      = x.BatchCode,
            Qty            = x.Qty,
            AvailableQty   = 0   // draft = patiesƒ´ba
        }).ToList()
    });
}

// üîπ ielƒÅdƒìjam REƒÄLO pieejamo atlikumu no noliktavas
foreach (var item in salesItems)
{
    var apiRows = await Http.GetFromJsonAsync<List<ApiBatchRow>>(
        $"http://localhost:5270/api/stockmovements/available-by-batch?versionId={item.VersionId}");

    if (apiRows == null)
        continue;

    foreach (var b in item.Batches)
    {
        var api = apiRows.FirstOrDefault(x =>
            x.BatchProductId == b.BatchProductId &&
            (item.IsAssembly
                ? x.MoveType == "ASSEMBLY"
                : x.MoveType == "STOCK"));

        if (api != null)
    b.AvailableQty = api.AvailableQty;


    }
}

StateHasChanged();

}

private sealed class SalesDraftDto
{
    public int DraftId { get; set; }
    public List<SalesDraftItemDto> Items { get; set; } = new();
}

private sealed class SalesDraftItemDto
{
    public int VersionId { get; set; }
    public int BatchProductId { get; set; }   // pievienots 16.01.2026
    public string BatchCode { get; set; } = ""; // pievienots 16.01.2026
    public int Qty { get; set; }
    public bool IsAssembly { get; set; }
}

private async Task ManualRefresh()
{
    await ReloadPlanningDataAsync();
    await InvokeAsync(StateHasChanged);
}


}
