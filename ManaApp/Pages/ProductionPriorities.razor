@page "/production-priorities"
@inject HttpClient Http
@inject ManaApp.Services.AppState AppState
@using ManaApp.Components.PriorityTasks
@inject NavigationManager Nav


@if (products == null)

{
    <p>IelƒÅdƒì...</p>
}
else
{
    <h3>Ra≈æo≈°anas prioritƒÅtes</h3>
    <button class="btn btn-primary mb-3"
        @onclick="SavePriorities">
    ATJAUNOT
</button>
    
<h5>PrioritƒÅrie produkti</h5>
    <table class="table">
        <thead>
            <tr>
                <th>Batch</th>
                <th>Kods</th>
                <th>Nosaukums</th>
                <th>Kategorija</th>
                <th>Versija</th>
                <th>Apjoms</th>
                <th>Detailed</th>
                <th>Assembly</th>
                <th>Finishing</th>
                <th>DetalizƒÅcija</th>
                <th>PrioritƒÅte</th>
            </tr>
        </thead>
        <tbody>

            

            @foreach (var p in PriorityProducts)

                {
                   
                    <tr>
                        <td>@p.BatchCode</td>
                        <td>@p.ProductCode</td>
                        <td>@p.ProductName</td>
                        <td>@p.CategoryName</td>
                        <td>@p.VersionName</td>
                        <td>@p.Done / @p.Planned</td>
                        <td>
                            <div>@p.DetailedX / @p.DetailedY</div>

                            <div class="d-flex align-items-center gap-2 mt-1">
                                <span class="text-muted" style="font-size:12px;">
                                    @p.DetailedDoneX / @p.DetailedY
                                </span>

                                <div class="progress flex-grow-1" style="height:6px;">
                                    <div class="progress-bar @GetDetailedBarClass(p)"
                                        style="width:@(p.DetailedY == 0 ? 0 : (p.DetailedStartedX * 100 / p.DetailedY))%">
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td>
                            <div>@GetAssemblyStatus(p)</div>

                            <div class="progress mt-1" style="height:6px;">
                                <div class="progress-bar @GetAssemblyBarClass(p)"
                                    style="width:100%">
                                </div>
                            </div>
                        </td>

                        <td>
                            <div class="d-flex justify-content-center gap-3">

                                <!-- ASSEMBLY (zilais) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingY
                                    </div>
                                    <div class="rounded-pill bg-primary mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- FINISHING procesƒÅ (dzeltens) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @(p.FinishingX - p.FinishingDone)
                                    </div>
                                    <div class="rounded-pill bg-warning mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- PABEIGTS (zaƒº≈°) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingDone
                                    </div>
                                    <div class="rounded-pill bg-success mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                            </div>
                        </td>

                        <td>
    <span style="cursor:pointer;"
          @onclick="() => GoToBatch(p.BatchProductId)">
        üîé
    </span>
</td>
                        <td>
                            <input type="checkbox"
                             @bind="p.IsPriority" />
                        </td>
                    </tr>
                }
        </tbody>
    </table>

    <h5 class="mt-4">Parastie produkti</h5>

<table class="table">
    <thead>
        <!-- NOKOPƒí eso≈°o thead -->
    </thead>
    <tbody>
        @foreach (var p in NormalProducts)
        {
            <tr>
                        <td>@p.BatchCode</td>
                        <td>@p.ProductCode</td>
                        <td>@p.ProductName</td>
                        <td>@p.CategoryName</td>
                        <td>@p.VersionName</td>
                        <td>@p.Done / @p.Planned</td>
                        <td>
                            <div>@p.DetailedX / @p.DetailedY</div>

                            <div class="d-flex align-items-center gap-2 mt-1">
                                <span class="text-muted" style="font-size:12px;">
                                    @p.DetailedDoneX / @p.DetailedY
                                </span>

                                <div class="progress flex-grow-1" style="height:6px;">
                                    <div class="progress-bar @GetDetailedBarClass(p)"
                                        style="width:@(p.DetailedY == 0 ? 0 : (p.DetailedStartedX * 100 / p.DetailedY))%">
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td>
                            <div>@GetAssemblyStatus(p)</div>

                            <div class="progress mt-1" style="height:6px;">
                                <div class="progress-bar @GetAssemblyBarClass(p)"
                                    style="width:100%">
                                </div>
                            </div>
                        </td>

                        <td>
                            <div class="d-flex justify-content-center gap-3">

                                <!-- ASSEMBLY (zilais) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingY
                                    </div>
                                    <div class="rounded-pill bg-primary mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- FINISHING procesƒÅ (dzeltens) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @(p.FinishingX - p.FinishingDone)
                                    </div>
                                    <div class="rounded-pill bg-warning mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- PABEIGTS (zaƒº≈°) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingDone
                                    </div>
                                    <div class="rounded-pill bg-success mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                            </div>
                        </td>

                        <td>
    <span style="cursor:pointer;"
          @onclick="() => GoToBatch(p.BatchProductId)">
        üîé
    </span>
</td>
                        <td>
                            <input type="checkbox"
                             @bind="p.IsPriority" />
                        </td>
                    </tr>
        }
    </tbody>
</table>

}

<PriorityImpactSummary @ref="impactSummary" />


@code {
    private List<ProductRow>? products;
    
    private IEnumerable<ProductRow> PriorityProducts =>
    products?.Where(p => p.IsPriority) ?? Enumerable.Empty<ProductRow>();

    private IEnumerable<ProductRow> NormalProducts =>
    products?.Where(p => !p.IsPriority) ?? Enumerable.Empty<ProductRow>();

    
protected override async Task OnInitializedAsync()
{
    await LoadProducts();
}

private async Task LoadProducts()
{
    products = await Http.GetFromJsonAsync<List<ProductRow>>(
    "http://localhost:5270/api/production-priorities");

}

private string GetDetailedStatus(ProductRow p)
{
    if (p.DetailedFinish > 0)
        return "Done";

    if (p.DetailedInProgress > 0)
        return "In progress";

    return "Not started";
}

private string GetDetailedBarClass(ProductRow p)
{
if (p.DetailedIsDone)
    return "bg-success";

if (p.DetailedStartedX > 0)
    return "bg-warning";

return "";
}


private string GetAssemblyStatus(ProductRow p)
{
    if (p.Done > 0)
        return "Done";

    if (p.Assembly > 0)
        return "In progress";

    return "Not started";
}

private string GetAssemblyBarClass(ProductRow p)
{
    if (p.Assembly > 0)
        return "bg-warning";   // In progress

    if (p.Done > 0)
        return "bg-success";   // Done

    return "bg-light";         // Not started
}


private string GetFinishingStatus(ProductRow p)
{
    if (p.FinishingInProgress > 0)
        return "In progress";

    return "Not started";
}

private class ProductRow
{
    public string BatchCode { get; set; } = "";
    public int BatchProductId { get; set; }
    public int VersionId { get; set; }

    public string ProductName { get; set; } = "";
    public string ProductCode { get; set; } = "";
    public string CategoryName { get; set; } = "";
    public string VersionName { get; set; } = "";   // ‚Üê TE

    public bool IsPriority { get; set; }

    public int Planned { get; set; }
    public int DetailedInProgress { get; set; }
    public int DetailedFinish { get; set; }
    public int Assembly { get; set; }
    public int FinishingInProgress { get; set; }
    public int Done { get; set; }
    public int DetailedX { get; set; }
    public int DetailedY { get; set; }
    public int DetailedStartedX { get; set; }

    public int DetailedDoneX { get; set; }
    public bool DetailedHasStarted { get; set; }
    public bool DetailedIsDone { get; set; }

    public int FinishingX { get; set; }
    public int FinishingY { get; set; }
    public int FinishingDone { get; set; }

}

private async Task SavePriorities()
{
    if (products == null)
        return;

    foreach (var p in products)
    {
        await Http.PutAsJsonAsync(
            $"http://localhost:5270/api/production-priorities/{p.BatchProductId}",
            p.IsPriority
        );
    }

    await LoadProducts();

if (impactSummary != null)
    await impactSummary.Reload();

StateHasChanged();
}
private PriorityImpactSummary? impactSummary;

private void GoToBatch(int batchProductId)
{
    Nav.NavigateTo($"/productiontasks-v2?batchProductId={batchProductId}");
}

}
