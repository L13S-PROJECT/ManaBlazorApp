@page "/production-priorities"
@inject HttpClient Http
@inject ManaApp.Services.AppState AppState
@using ManaApp.Components.PriorityTasks
@inject NavigationManager Nav


@if (products == null)

{
    <p>IelƒÅdƒì...</p>
}
else
{
    <h3>Ra≈æo≈°anas prioritƒÅtes</h3>
    <button class="btn btn-primary mb-3"
        @onclick="SavePriorities">
    ATJAUNOT
</button>
    
<h5>PrioritƒÅrie produkti</h5>

<div class="priority-table">
        <div class="priority-head priority-grid">
            <div style="width:40px;"></div>
            <div>Batch</div>
            <div>Kods</div>
            <div>Nosaukums</div>
            <div>Kategorija</div>
            <div>Versija</div>
            <div>Apjoms</div>
            <div>Detailed</div>
            <div>Assembly</div>
            <div>Finishing</div>
            <div>DetalizƒÅcija</div>
            <div>PrioritƒÅte</div>
        </div>

<div class="priority-body"
     @onmouseup="EndDrag">

@for (int i = 0; i < _priorityList.Count; i++)
{
    var p = _priorityList[i];
        {
                   
                    <div @key="p.BatchProductId"
                        class="priority-row priority-grid
                            @( _selectedId == p.BatchProductId ? "dragging" : "" )"
                       @onmousemove="() => OnDragEnter(p)">
                        <div class="priority-drag-cell"
                            @onmousedown="() => StartDrag(p)"
                            @onmousedown:preventDefault="true">
                            ‚ãÆ‚ãÆ
                        </div>
                        <div>@p.BatchCode</div>
                        <div>@p.ProductCode</div>
                        <div>@p.ProductName</div>
                        <div>@p.CategoryName</div>
                        <div>@p.VersionName</div>
                        <div>@p.Done / @p.Planned</div>
                        <div>
                            <div>@p.DetailedX / @p.DetailedY</div>

                            <div class="d-flex align-items-center gap-2 mt-1">
                                <span class="text-muted" style="font-size:12px;">
                                    @p.DetailedDoneX / @p.DetailedY
                                </span>

                                <div class="progress flex-grow-1" style="height:6px;">
                                    <div class="progress-bar @GetDetailedBarClass(p)"
                                        style="width:@(p.DetailedY == 0 ? 0 : (p.DetailedStartedX * 100 / p.DetailedY))%">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div>@GetAssemblyStatus(p)</div>

                            <div class="progress mt-1" style="height:6px;">
                                <div class="progress-bar @GetAssemblyBarClass(p)"
                                    style="width:100%">
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="d-flex justify-content-center gap-3">

                                <!-- ASSEMBLY (zilais) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingY
                                    </div>
                                    <div class="rounded-pill bg-primary mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- FINISHING procesƒÅ (dzeltens) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @(p.FinishingX - p.FinishingDone)
                                    </div>
                                    <div class="rounded-pill bg-warning mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- PABEIGTS (zaƒº≈°) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingDone
                                    </div>
                                    <div class="rounded-pill bg-success mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div>
    <span style="cursor:pointer;"
          @onclick="() => GoToBatch(p.BatchProductId)">
        üîé
    </span>
</div>
                        <div>
                        <input type="checkbox"
                            checked="@p.IsPriority"
                            @onchange="(e) => OnPriorityToggled(p, e)" />
                        </div>
                    </div>
                }
}
        </div>
        </div>

    <h5 class="mt-4">Parastie produkti</h5>

<table class="table">
    <thead>
        <!-- NOKOPƒí eso≈°o thead -->
    </thead>
    <tbody>
        @foreach (var p in NormalProducts)
        {
            <tr>
                        <td>@p.BatchCode</td>
                        <td>@p.ProductCode</td>
                        <td>@p.ProductName</td>
                        <td>@p.CategoryName</td>
                        <td>@p.VersionName</td>
                        <td>@p.Done / @p.Planned</td>
                        <td>
                            <div>@p.DetailedX / @p.DetailedY</div>

                            <div class="d-flex align-items-center gap-2 mt-1">
                                <span class="text-muted" style="font-size:12px;">
                                    @p.DetailedDoneX / @p.DetailedY
                                </span>

                                <div class="progress flex-grow-1" style="height:6px;">
                                    <div class="progress-bar @GetDetailedBarClass(p)"
                                        style="width:@(p.DetailedY == 0 ? 0 : (p.DetailedStartedX * 100 / p.DetailedY))%">
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td>
                            <div>@GetAssemblyStatus(p)</div>

                            <div class="progress mt-1" style="height:6px;">
                                <div class="progress-bar @GetAssemblyBarClass(p)"
                                    style="width:100%">
                                </div>
                            </div>
                        </td>

                        <td>
                            <div class="d-flex justify-content-center gap-3">

                                <!-- ASSEMBLY (zilais) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingY
                                    </div>
                                    <div class="rounded-pill bg-primary mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- FINISHING procesƒÅ (dzeltens) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @(p.FinishingX - p.FinishingDone)
                                    </div>
                                    <div class="rounded-pill bg-warning mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- PABEIGTS (zaƒº≈°) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingDone
                                    </div>
                                    <div class="rounded-pill bg-success mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                            </div>
                        </td>

                        <td>
    <span style="cursor:pointer;"
          @onclick="() => GoToBatch(p.BatchProductId)">
        üîé
    </span>
</td>
                        <td>
                            <input type="checkbox"
                                checked="@p.IsPriority"
                                @onchange="(e) => OnPriorityToggled(p, e)" />
                        </td>
                    </tr>
        }
    </tbody>
</table>

}

<PriorityImpactSummary @ref="impactSummary" />


@code {
    private List<ProductRow>? products;
    
private List<ProductRow> PriorityProducts =>
    products?.Where(p => p.IsPriority).ToList()
    ?? new List<ProductRow>();

    private IEnumerable<ProductRow> NormalProducts =>
    products?.Where(p => !p.IsPriority) ?? Enumerable.Empty<ProductRow>();

 private List<ProductRow> _priorityList = new();

protected override async Task OnInitializedAsync()
{
    await LoadProducts();
}

private async Task LoadProducts()
{
    products = await Http.GetFromJsonAsync<List<ProductRow>>(
    "http://localhost:5270/api/production-priorities");

    _priorityList = products?
    .Where(p => p.IsPriority)
    .ToList()
    ?? new List<ProductRow>();

}

private string GetDetailedStatus(ProductRow p)
{
    if (p.DetailedFinish > 0)
        return "Done";

    if (p.DetailedInProgress > 0)
        return "In progress";

    return "Not started";
}

private string GetDetailedBarClass(ProductRow p)
{
if (p.DetailedIsDone)
    return "bg-success";

if (p.DetailedStartedX > 0)
    return "bg-warning";

return "";
}


private string GetAssemblyStatus(ProductRow p)
{
    if (p.Done > 0)
        return "Done";

    if (p.Assembly > 0)
        return "In progress";

    return "Not started";
}

private string GetAssemblyBarClass(ProductRow p)
{
    if (p.Assembly > 0)
        return "bg-warning";   // In progress

    if (p.Done > 0)
        return "bg-success";   // Done

    return "bg-light";         // Not started
}


private string GetFinishingStatus(ProductRow p)
{
    if (p.FinishingInProgress > 0)
        return "In progress";

    return "Not started";
}

private class ProductRow
{
    public string BatchCode { get; set; } = "";
    public int BatchProductId { get; set; }
    public int VersionId { get; set; }

    public string ProductName { get; set; } = "";
    public string ProductCode { get; set; } = "";
    public string CategoryName { get; set; } = "";
    public string VersionName { get; set; } = "";   // ‚Üê TE

    public bool IsPriority { get; set; }
    public int Priority { get; set; }
    public int Planned { get; set; }
    public int DetailedInProgress { get; set; }
    public int DetailedFinish { get; set; }
    public int Assembly { get; set; }
    public int FinishingInProgress { get; set; }
    public int Done { get; set; }
    public int DetailedX { get; set; }
    public int DetailedY { get; set; }
    public int DetailedStartedX { get; set; }

    public int DetailedDoneX { get; set; }
    public bool DetailedHasStarted { get; set; }
    public bool DetailedIsDone { get; set; }

    public int FinishingX { get; set; }
    public int FinishingY { get; set; }
    public int FinishingDone { get; set; }

}

private async Task SavePriorities()
{
    Console.WriteLine("SAVE CLICKED");

    if (products == null)
        return;


    // 1Ô∏è‚É£ Pie≈°ƒ∑iram secƒ´bu pƒìc UI kƒÅrtƒ´bas
    for (int i = 0; i < _priorityList.Count; i++)
    {
        _priorityList[i].Priority = i + 1;
    }

    foreach (var p in products)
{
    int newPriority = 0;

    if (p.IsPriority)
    {
        var index = _priorityList
            .FindIndex(x => x.BatchProductId == p.BatchProductId);

        if (index >= 0)
            newPriority = index + 1;
    }

    await Http.PutAsJsonAsync(
        $"http://localhost:5270/api/production-priorities/{p.BatchProductId}",
        new
        {
            IsPriority = p.IsPriority,
            Priority = newPriority
        }
    );
}

    await LoadProducts();

    if (impactSummary != null)
        await impactSummary.Reload();

    StateHasChanged();
}
private PriorityImpactSummary? impactSummary;

private bool _isDragging = false;

private int? _selectedId = null;

private void GoToBatch(int batchProductId)
{
    Nav.NavigateTo($"/productiontasks-v2?batchProductId={batchProductId}");
}

private void StartDrag(ProductRow item)
{
    _selectedId = item.BatchProductId;
    _isDragging = true;
    StateHasChanged();
}

private void OnDragEnter(ProductRow target)
{
    if (!_isDragging || _selectedId == null)
        return;

    var currentIndex = _priorityList.FindIndex(x => x.BatchProductId == _selectedId);
    var newIndex = _priorityList.FindIndex(x => x.BatchProductId == target.BatchProductId);

    if (currentIndex == -1 || newIndex == -1 || currentIndex == newIndex)
        return;

    var item = _priorityList[currentIndex];

    _priorityList.RemoveAt(currentIndex);
    _priorityList.Insert(newIndex, item);

    StateHasChanged();
}

private void EndDrag()
{
    _isDragging = false;
    _selectedId = null;
}

private void OnPriorityToggled(ProductRow p, ChangeEventArgs e)
{
    var isChecked = e?.Value is bool b && b;
    p.IsPriority = isChecked;

    if (isChecked)
    {
        // ja atzƒ´mƒì par prioritƒÅru -> pievieno saraksta beigƒÅs
        if (!_priorityList.Any(x => x.BatchProductId == p.BatchProductId))
            _priorityList.Add(p);
    }
    else
    {
        // ja no≈Üem ƒ∑eksi -> iz≈Üem no prioritƒÅrajiem
        _priorityList.RemoveAll(x => x.BatchProductId == p.BatchProductId);
        p.Priority = 0;
    }
}

}
