@page "/production-priorities"
@inject HttpClient Http
@inject ManaApp.Services.AppState AppState
@using ManaApp.Components.PriorityTasks

@if (products == null)

{
    <p>Ielādē...</p>
}
else
{
    <h3>Ražošanas prioritātes</h3>

    <table class="table">
        <thead>
            <tr>
                <th>Kods</th>
                <th>Nosaukums</th>
                <th>Kategorija</th>
                <th>Versija</th>
                <th>Apjoms</th>
                <th>Detailed</th>
                <th>Assembly</th>
                <th>Finishing</th>
                <th>Datums</th>
                <th>Prioritāte</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in products)
                {
                    <tr>
                        <td>@p.ProductCode</td>
                        <td>@p.ProductName</td>
                        <td>@p.CategoryName</td>
                        <td>@p.VersionName</td>
                        <td>@p.Done / @p.Planned</td>
                        <td>
                            <div>@p.DetailedX / @p.DetailedY</div>

                            <div class="progress mt-1" style="height:6px;">
                                <div class="progress-bar @GetDetailedBarClass(p)"
                                    style="width:@(p.DetailedY == 0 ? 0 : (p.DetailedX * 100 / p.DetailedY))%">
                                </div>
                            </div>
                        </td>

                        <td>
                            <div>@GetAssemblyStatus(p)</div>

                            <div class="progress mt-1" style="height:6px;">
                                <div class="progress-bar @GetAssemblyBarClass(p)"
                                    style="width:100%">
                                </div>
                            </div>
                        </td>

                        <td>
                            <div class="d-flex justify-content-center gap-3">

                                <!-- ASSEMBLY (zilais) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingY
                                    </div>
                                    <div class="rounded-pill bg-primary mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- FINISHING procesā (dzeltens) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @(p.FinishingX - p.FinishingDone)
                                    </div>
                                    <div class="rounded-pill bg-warning mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                                <!-- PABEIGTS (zaļš) -->
                                <div class="text-center">
                                    <div class="text-muted" style="font-size:12px;">
                                        @p.FinishingDone
                                    </div>
                                    <div class="rounded-pill bg-success mt-1"
                                        style="height:6px; width:28px;">
                                    </div>
                                </div>

                            </div>
                        </td>

                        <td></td>
                        <td>
                            <input type="checkbox"
                            checked="@p.IsPriority"
                            @onchange="e => OnPriorityChanged(p.BatchProductId, e)" />

                        </td>
                    </tr>
                }
        </tbody>
    </table>
}

<PriorityImpactSummary />

@code {
    private List<ProductRow>? products;
    
protected override async Task OnInitializedAsync()
{
    await LoadProducts();
}

private async Task LoadProducts()
{
    products = await Http.GetFromJsonAsync<List<ProductRow>>(
    "http://localhost:5270/api/production-priorities");

}

private async Task OnPriorityChanged(int batchProductId, ChangeEventArgs e)
{
    var isChecked = (bool)e.Value!;

    await Http.PutAsJsonAsync(
        $"http://localhost:5270/api/production-priorities/{batchProductId}",
        isChecked
    );

    await LoadProducts();
}

private string GetDetailedStatus(ProductRow p)
{
    if (p.DetailedFinish > 0)
        return "Done";

    if (p.DetailedInProgress > 0)
        return "In progress";

    return "Not started";
}

private string GetDetailedBarClass(ProductRow p)
{
    if (p.DetailedIsDone)
        return "bg-success";   // viss pabeigts

    if (p.DetailedHasStarted)
        return "bg-warning";   // ir iesākts

    return "bg-light";         // nav iesākts
}


private string GetAssemblyStatus(ProductRow p)
{
    if (p.Done > 0)
        return "Done";

    if (p.Assembly > 0)
        return "In progress";

    return "Not started";
}

private string GetAssemblyBarClass(ProductRow p)
{
    if (p.Assembly > 0)
        return "bg-warning";   // In progress

    if (p.Done > 0)
        return "bg-success";   // Done

    return "bg-light";         // Not started
}


private string GetFinishingStatus(ProductRow p)
{
    if (p.FinishingInProgress > 0)
        return "In progress";

    return "Not started";
}

private class ProductRow
{
    public int BatchProductId { get; set; }
    public int VersionId { get; set; }

    public string ProductName { get; set; } = "";
    public string ProductCode { get; set; } = "";
    public string CategoryName { get; set; } = "";
    public string VersionName { get; set; } = "";   // ← TE

    public bool IsPriority { get; set; }

    public int Planned { get; set; }
    public int DetailedInProgress { get; set; }
    public int DetailedFinish { get; set; }
    public int Assembly { get; set; }
    public int FinishingInProgress { get; set; }
    public int Done { get; set; }

    public int DetailedX { get; set; }
    public int DetailedY { get; set; }
    public bool DetailedHasStarted { get; set; }
    public bool DetailedIsDone { get; set; }

    public int FinishingX { get; set; }
    public int FinishingY { get; set; }
    public int FinishingDone { get; set; }

}


}
