@page "/employeetasks"
@using System.Net.Http.Json
@using System.Linq
@inject HttpClient Http
@using ManaApp.Components.EmployeeTasks
@using ManaApp.Shared
@using ManaApp.Services
@inject AppState AppState


<PageHeader Title="Darbinieku uzdevumi" /> 

    <div class="main-layout">

    <div class="left-panel">

        @if (tasks.Count == 0)
        {
            <div class="empty-state">
                Šobrīd tev nav piešķirtu darbu.
            </div>
        }
        else
        {
            @if (priorityTasks.Any())
            {
                <h5>Prioritārie darbi</h5>
                <TasksTable Tasks="priorityTasks"
                            StatusText="StatusText"
                            CanStart="CanStart"
                            OnSelect="SelectTask"
                            OnOpen="OpenTaskDialog" />
            }

            @if (normalTasks.Any())
            {
                <h5>Pārējie darbi</h5>
                <TasksTable Tasks="normalTasks"
                            StatusText="StatusText"
                            CanStart="CanStart"
                            OnSelect="SelectTask"
                            OnOpen="OpenTaskDialog" />
}

        }

    </div>


    <div class="right-panel">
        <ActiveTaskPanel ActiveTask="_activeTask"
                    OnFinish="FinishTask"
                    StatusText="StatusText"
                    OnStart="OpenTaskDialog"
                    OnFinishConfirm="OpenFinishDialog" />

    </div>

    </div>

<TaskDialog IsOpen="_isDialogOpen"
            IsFinish="@(_dialogMode == TaskDialogMode.Finish)"
            SelectedTask="_selectedTask"
            StatusText="StatusText"
            CanStart="CanStart"
            OnConfirm="@(async t => {
       if (_dialogMode == TaskDialogMode.Finish)
            await FinishTask(t);
        else
            await ClaimTask(t.TaskId);

        _isDialogOpen = false;
        _dialogMode = TaskDialogMode.None;

            })"
            OnClose="() => {
                _isDialogOpen = false;
                _dialogMode = TaskDialogMode.None;}" />

@code {
    private List<TaskRow> tasks = new();
    
private List<TaskRow> priorityTasks =>
    tasks?.Where(t => t.PriorityLevel > 0).ToList() ?? new();


private List<TaskRow> normalTasks =>
    tasks?.Where(t => t.Priority == 0).ToList() ?? new();


protected override async Task OnInitializedAsync()
{
    await LoadTasks();
}

private string StatusText(int s, TaskRow t) => s switch
{
    1 => "Nav iesākts",
    2 => "Procesā",
    3 => "Pabeigts",
    4 => "Atcelts",
    _ => "?"
};

private string StatusText(int s) => StatusText(s, null!);


private async Task ClaimTask(int taskId)
{
    var body = new
    {
        taskId,
        empId = 1 // testējam ar vienu darbinieku
    };

    var resp = await Http.PostAsJsonAsync("api/tasks/claim", body);

    if (resp.IsSuccessStatusCode)
    {
        await LoadTasks();
        CloseTaskDialog();
    }
}


private async Task LoadTasks()
{
tasks = await Http.GetFromJsonAsync<List<TaskRow>>(
    "api/tasks/for-employee"
) ?? new();


Console.WriteLine($"TASKS COUNT = {tasks.Count}");

_activeTask = tasks.FirstOrDefault(t => t.Status == 2);

Console.WriteLine($"ACTIVE = {_activeTask?.TaskId}, STATUS = {_activeTask?.Status}");

StateHasChanged(); // 

}



private async Task FinishTask(TaskRow task)
{
    if (task is null) return;

    // cik vēl nav padarīts šim uzdevumam
    var remaining = task.Planned - task.Done;
    if (remaining < 0) remaining = 0;

    var body = new
    {
        taskId = task.TaskId,
        qtyDoneAdd = remaining > 0 ? remaining : (int?)null
    };

    // pabeidzam tasku API pusē
    var resp = await Http.PostAsJsonAsync(
    "api/tasks/finish", body);

    if (!resp.IsSuccessStatusCode)
    {
        Console.WriteLine($"Finish failed: {resp.StatusCode} - {await resp.Content.ReadAsStringAsync()}");
        return;
    }

    // pārlādējam uzdevumus
    await LoadTasks();
}

private bool _isDialogOpen = false;
private TaskRow? _selectedTask;

private Task OpenTaskDialog(TaskRow t)
{
    _selectedTask = t;
    _dialogMode = TaskDialogMode.Start;
    _isDialogOpen = true;
    return Task.CompletedTask;


}



private void CloseTaskDialog()
{
    _isDialogOpen = false;
    _selectedTask = null;
}

private TaskRow? _activeTask;

    // Pārbaudām, vai ir kāds iepriekšējais solis šai pašai partijai + detaļai,
    // kas joprojām ir sarakstā (t.i., nav pabeigts).
    private bool CanStart(TaskRow t)
{
    // 1. solis vienmēr drīkst (secības ziņā)
    if (t.StepOrder <= 1)
        return true;

    // vai ir kāds iepriekšējais solis šai pašai partijai + detaļai,
    // kurš NAV pabeigts (Status != 3)?
    var hasPrevNotFinished = tasks.Any(other =>
        other.BatchCode == t.BatchCode &&
        other.PartName == t.PartName &&
        other.StepOrder < t.StepOrder &&
        other.Status != 3);

    // ja priekšā ir nepabeigti soļi -> šo sākt nedrīkst
    return !hasPrevNotFinished;
}

private void SelectTask(TaskRow task)
{
    _activeTask = task;
    _dialogMode = TaskDialogMode.None;
}

enum TaskDialogMode
{
    None,
    Start,
    Finish
}

TaskDialogMode _dialogMode = TaskDialogMode.None;


private void OpenFinishDialog(TaskRow t)
{
    _selectedTask = t;
    _dialogMode = TaskDialogMode.Finish;
    _isDialogOpen = true;
}

}


