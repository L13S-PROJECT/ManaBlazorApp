@page "/employeetasks"
@using System.Net.Http.Json
@using System.Linq
@inject HttpClient Http
@using ManaApp.Components.EmployeeTasks
@using ManaApp.Shared


<PageHeader Title="Darbinieku uzdevumi" />

   
        <EmployeeHeader EmpId="@empId" OnLoad="LoadTasks" />
    

    <div class="main-layout">

    <div class="left-panel">
        <TasksTable Tasks="tasks"
                    StatusText="StatusText"
                    CanStart="CanStart"
                    OnSelect="SelectTask"
                    OnOpen="OpenTaskDialog" />
    </div>

    <div class="right-panel">
        <ActiveTaskPanel ActiveTask="_activeTask"
                    OnFinish="FinishTask"
                    StatusText="StatusText"
                    OnStart="OpenTaskDialog"
                    OnFinishConfirm="OpenFinishDialog" />

    </div>

    </div>

<TaskDialog IsOpen="_isDialogOpen"
            IsFinish="_isFinishDialog"
            SelectedTask="_selectedTask"
            StatusText="StatusText"
            CanStart="CanStart"
            OnConfirm="@(async t => {
                if (_isFinishDialog)
                    await FinishTask(t);
                else
                    await ClaimTask(t.TaskId);

                _isDialogOpen = false;
                _isFinishDialog = false;
            })"
            OnClose="() => {
                _isDialogOpen = false;
                _isFinishDialog = false;
            }" />


@code {
    private List<TaskRow> tasks = new();

    protected override async Task OnInitializedAsync() => await LoadTasks();

    private string StatusText(int s) => s switch
{
    1 => "Nav iesākts",
    2 => "Procesā",
    3 => "Pabeigts",
    4 => "Atcelts",
    _ => "?"
};

private async Task ClaimTask(int taskId)
{
    var body = new { taskId, empId };
    var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/tasks/claim", body);

    if (resp.IsSuccessStatusCode)
    {
        await LoadTasks();
        CloseTaskDialog();
    }
    else
    {
        Console.WriteLine($"Claim failed: {resp.StatusCode} - {await resp.Content.ReadAsStringAsync()}");
    }
}

int empId = 1;

private async Task LoadTasks()
{
    tasks = await Http.GetFromJsonAsync<List<TaskRow>>(
        $"http://localhost:5270/api/tasks/for-employee?empId={empId}"
    ) ?? new();

    // Meklējam aktīvo uzdevumu (Tasks_Status = 2)
    _activeTask = tasks.FirstOrDefault(t => t.Status == 2);
}


private async Task FinishTask(TaskRow task)
{
    if (task is null) return;

    // cik vēl nav padarīts šim uzdevumam
    var remaining = task.Planned - task.Done;
    if (remaining < 0) remaining = 0;

    var body = new
    {
        taskId = task.TaskId,
        qtyDoneAdd = remaining > 0 ? remaining : (int?)null
    };

    // pabeidzam tasku API pusē
    var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/tasks/finish", body);
    if (!resp.IsSuccessStatusCode)
    {
        Console.WriteLine($"Finish failed: {resp.StatusCode} - {await resp.Content.ReadAsStringAsync()}");
        return;
    }

    // pārlādējam uzdevumus
    await LoadTasks();
}

private bool _isDialogOpen = false;
private TaskRow? _selectedTask;

private void OpenTaskDialog(TaskRow t)
{
    _selectedTask = t;
    _isDialogOpen = true;
}

private void CloseTaskDialog()
{
    _isDialogOpen = false;
    _selectedTask = null;
}

private TaskRow? _activeTask;

    // Pārbaudām, vai ir kāds iepriekšējais solis šai pašai partijai + detaļai,
    // kas joprojām ir sarakstā (t.i., nav pabeigts).
    private bool CanStart(TaskRow t)
{
    // 1. solis vienmēr drīkst (secības ziņā)
    if (t.StepOrder <= 1)
        return true;

    // vai ir kāds iepriekšējais solis šai pašai partijai + detaļai,
    // kurš NAV pabeigts (Status != 3)?
    var hasPrevNotFinished = tasks.Any(other =>
        other.BatchCode == t.BatchCode &&
        other.PartName == t.PartName &&
        other.StepOrder < t.StepOrder &&
        other.Status != 3);

    // ja priekšā ir nepabeigti soļi -> šo sākt nedrīkst
    return !hasPrevNotFinished;
}

private void SelectTask(TaskRow task)
{
    _activeTask = task;
}

bool _isFinishDialog = false;

private void OpenFinishDialog(TaskRow t)
{
    _selectedTask = t;
    _isFinishDialog = true;
    _isDialogOpen = true;
}

}


