@page "/employeetasks"
@using System.Net.Http.Json
@using System.Linq
@inject HttpClient Http
@using ManaApp.Components.EmployeeTasks
@using ManaApp.Shared
@using ManaApp.Services
@inject AppState AppState


<PageHeader Title="Darbinieku uzdevumi" /> 

    <div class="main-layout">

    <div class="left-panel">

        @if (tasks.Count == 0)
        {
            <div class="empty-state">
                Šobrīd tev nav piešķirtu darbu.
            </div>
        }
        else
        {
            <TasksTable Tasks="tasks"
                        StatusText="StatusText"
                        CanStart="CanStart"
                        OnSelect="SelectTask"
                        OnOpen="OpenTaskDialog" />
        }

    </div>


    <div class="right-panel">
        <ActiveTaskPanel ActiveTask="_activeTask"
                    OnFinish="FinishTask"
                    StatusText="StatusText"
                    OnStart="OpenTaskDialog"
                    OnFinishConfirm="OpenFinishDialog" />

    </div>

    </div>

<TaskDialog IsOpen="_isDialogOpen"
            IsFinish="_isFinishDialog"
            SelectedTask="_selectedTask"
            StatusText="StatusText"
            CanStart="CanStart"
            OnConfirm="@(async t => {
                if (_isFinishDialog)
                    await FinishTask(t);
                else
                    await ClaimTask(t.TaskId);

                _isDialogOpen = false;
                _isFinishDialog = false;
            })"
            OnClose="() => {
                _isDialogOpen = false;
                _isFinishDialog = false;
            }" />


@code {
    private List<TaskRow> tasks = new();

protected override async Task OnInitializedAsync()
{
    await LoadTasks();
}


    private string StatusText(int s) => s switch
{
    1 => "Nav iesākts",
    2 => "Procesā",
    3 => "Pabeigts",
    4 => "Atcelts",
    _ => "?"
};

private async Task ClaimTask(int taskId)
{
    if (AppState.CurrentEmployee == null)
        return;

    var body = new
    {
        taskId,
        empId = 1 // testējam ar vienu darbinieku
    };

    var resp = await Http.PostAsJsonAsync("api/tasks/claim", body);

    if (resp.IsSuccessStatusCode)
    {
        await LoadTasks();
        CloseTaskDialog();
    }
}

private async Task LoadTasks()
{
tasks = await Http.GetFromJsonAsync<List<TaskRow>>(
    "http://localhost:5270/api/tasks/for-employee"
) ?? new();

Console.WriteLine($"TASKS COUNT = {tasks.Count}");

_activeTask = tasks.FirstOrDefault(t => t.Status == 2);

Console.WriteLine($"ACTIVE = {_activeTask?.TaskId}, STATUS = {_activeTask?.Status}");

StateHasChanged(); // 

}



private async Task FinishTask(TaskRow task)
{
    if (task is null) return;

    // cik vēl nav padarīts šim uzdevumam
    var remaining = task.Planned - task.Done;
    if (remaining < 0) remaining = 0;

    var body = new
    {
        taskId = task.TaskId,
        qtyDoneAdd = remaining > 0 ? remaining : (int?)null
    };

    // pabeidzam tasku API pusē
    var resp = await Http.PostAsJsonAsync("http://localhost:5270/api/tasks/finish", body);
    if (!resp.IsSuccessStatusCode)
    {
        Console.WriteLine($"Finish failed: {resp.StatusCode} - {await resp.Content.ReadAsStringAsync()}");
        return;
    }

    // pārlādējam uzdevumus
    await LoadTasks();
}

private bool _isDialogOpen = false;
private TaskRow? _selectedTask;

private Task OpenTaskDialog(TaskRow t)
{
    _selectedTask = t;
    _isFinishDialog = false;
    _isDialogOpen = true;
    return Task.CompletedTask;
}



private void CloseTaskDialog()
{
    _isDialogOpen = false;
    _selectedTask = null;
}

private TaskRow? _activeTask;

    // Pārbaudām, vai ir kāds iepriekšējais solis šai pašai partijai + detaļai,
    // kas joprojām ir sarakstā (t.i., nav pabeigts).
    private bool CanStart(TaskRow t)
{
    // 1. solis vienmēr drīkst (secības ziņā)
    if (t.StepOrder <= 1)
        return true;

    // vai ir kāds iepriekšējais solis šai pašai partijai + detaļai,
    // kurš NAV pabeigts (Status != 3)?
    var hasPrevNotFinished = tasks.Any(other =>
        other.BatchCode == t.BatchCode &&
        other.PartName == t.PartName &&
        other.StepOrder < t.StepOrder &&
        other.Status != 3);

    // ja priekšā ir nepabeigti soļi -> šo sākt nedrīkst
    return !hasPrevNotFinished;
}

private void SelectTask(TaskRow task)
{
    _activeTask = task;
    _isFinishDialog = false; // reset dialog mode
}




bool _isFinishDialog = false;

private void OpenFinishDialog(TaskRow t)
{
    _selectedTask = t;
    _isFinishDialog = true;
    _isDialogOpen = true;
}

}


